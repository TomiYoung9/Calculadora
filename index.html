<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Funci√≥n Diast√≥lica</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --main-bg:#b7d0e8;--header-bg:#3a5a7a;--card-bg:#fff;
      --accent:#27ae60;--accent-dark:#219150;--accent-light:#e9f7ef;
      --text-main:#1a2a36;--text-soft:#5a6e7f;--border:#e3eaf2;
      --shadow:0 4px 24px rgba(74,144,226,0.08);
      --red:#e74c3c;--green:#27ae60;--yellow:#f7b731;
      --label-w:200px;
    }
    *{box-sizing:border-box}
    body{font-family:'Inter',Arial,sans-serif;background:var(--main-bg);min-height:100vh;margin:0}
    .container{max-width:900px;margin:40px auto 0;background:var(--card-bg);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .header{background:var(--header-bg);color:#fff;padding:36px 20px 24px;text-align:center}
    .header h1{font-size:2.1em;font-weight:700;margin:0 0 8px;letter-spacing:.5px;display:flex;align-items:center;justify-content:center;gap:14px}
    .header .subtitle{font-size:1.08em;font-weight:500;margin-top:6px;letter-spacing:.2px}

    .form-container{padding:36px 22px 28px}

    .alg-link{display:block;text-align:right;margin:-6px 0 14px;color:#3a5a7a;font-size:.97em;text-decoration:underline dotted}
    .alg-link:hover{color:var(--accent)}

    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 2px 8px #4a90e211;border:1.5px solid var(--border);margin-bottom:20px;padding:22px 18px 12px}
    .form-card h3{color:var(--text-main);font-size:1.13em;font-weight:600;margin-bottom:14px;letter-spacing:.3px}

    .input-row-group{display:flex;gap:18px;flex-wrap:wrap}

    .input-row{
      display:grid;
      grid-template-columns: var(--label-w) minmax(0,1fr) auto;
      align-items:center;
      gap:10px 12px;
      margin-bottom:10px;
      flex:1 1 420px;
      min-width:360px;
    }
    .input-row--full{flex:1 1 100%;min-width:100%}

    .input-row label{font-weight:500;color:var(--text-main);font-size:1em}
    .input-row input,.input-row select{
      width:100%;
      min-width:0;
      padding:9px 10px;border:1.5px solid var(--border);border-radius:6px;
      font-size:1em;background:#f7fbfd;color:#1a2a36;
    }
    .input-row input:focus,.input-row select:focus{outline:none;border-color:var(--accent)}
    .unit{color:var(--text-soft);font-weight:500;font-size:.97em;white-space:nowrap}

    .calculate-btn{width:100%;padding:13px;background:var(--green);color:#fff;border:none;border-radius:9px;font-size:1.13em;font-weight:700;cursor:pointer;margin-top:14px;box-shadow:0 2px 8px #4a90e211}
    .calculate-btn:hover{background:var(--accent-dark)}

    .results{margin-top:26px;padding:22px 18px;border-radius:10px;display:none}
    .results.normal{background:#eafaf1;color:var(--green);border:2px solid var(--green)}
    .results.abnormal{background:#fdeaea;color:var(--red);border:2px solid var(--red)}
    .results.indeterminate{background:#fffbe6;color:var(--yellow);border:2px solid var(--yellow)}
    .results h3{font-size:1.2em;margin-bottom:10px}
    .parameter-status{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:6px;margin-top:12px}
    .parameter-item{background:rgba(255,255,255,0.13);padding:7px 10px;border-radius:7px;border-left:4px solid #fff;font-size:1em}
    .parameter-item.abnormal{border-left-color:var(--red);background:#fdeaea}
    .parameter-item.normal{border-left-color:var(--green);background:#eafaf1}
    .parameter-item.indeterminate{border-left-color:var(--yellow);background:#fffbe6}
    .recommendations{margin-top:12px;padding:12px 10px;background:rgba(255,255,255,0.13);border-radius:7px}

    .fevi-warning{background:#fff8e1;border:1px solid #ffecb3;padding:10px 12px;border-radius:7px;margin-bottom:12px;color:#6d4c41}
    .indeterminate-note{background:#fffbe6;border:1.5px solid var(--yellow);color:#b38600;padding:10px 12px;border-radius:7px;margin-bottom:12px}
    .age-reference{background:#e8f4fd;padding:10px 12px;border-radius:7px;margin-bottom:12px;border-left:4px solid var(--accent)}

    .referencias{margin-top:28px;padding:16px 12px;background:#f8f9fa;border-radius:9px;border-left:5px solid var(--accent-light)}
    .referencias h3{color:var(--text-main);margin-bottom:12px;font-size:1.08em}
    .referencia-item{margin-bottom:10px;padding:10px;background:#fff;border-radius:7px;box-shadow:0 2px 5px #4a90e20a}
    .referencia-item p{margin:0;line-height:1.6;color:#1a2a36}
    .referencia-item a{color:#27ae60 !important;text-decoration:none;font-weight:500}
    .referencia-item a:hover{color:#219150 !important;text-decoration:underline}
    .referencia-item a:visited{color:#27ae60 !important}
    .referencia-item small, .referencia-item small a{font-size:1em}

    .twitter-section{text-align:center;padding:10px;margin-bottom:6px;display:flex;justify-content:center;gap:20px}
    .twitter-link,.linkedin-link{display:inline-flex;align-items:center;gap:8px;color:#111;text-decoration:none;font-weight:600;font-size:1.1em}
    .twitter-link:hover,.linkedin-link:hover{color:#27ae60}
    .twitter-section a:visited{color:#111}

    .pressure-status{font-size:1.08em;font-weight:bold;margin-top:8px;padding:7px;border-radius:7px;text-align:center}
    .pressure-status.normal{background:#eafaf1;color:#27ae60}
    .pressure-status.elevated{background:#fdeaea;color:#e74c3c}

    .version-footer{font-size:.85em;color:#5b6470;text-align:center;margin:12px 0 18px}

    /* Modal */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;overflow:auto;background-color:rgba(0,0,0,0.5);backdrop-filter:blur(3px)}
    .modal-content{background:#fff;margin:5% auto;padding:20px 30px;border-radius:12px;max-width:600px;box-shadow:0 4px 24px rgba(0,0,0,0.2);position:relative}
    .modal-close{position:absolute;top:12px;right:16px;background:transparent;border:none;font-size:28px;font-weight:bold;cursor:pointer;color:#333;line-height:1}
    .modal-close:hover{color:#27ae60}
    .modal-body{max-height:60vh;overflow-y:auto;font-size:.95em;line-height:1.4}
    .modal-table{width:100%;border-collapse:collapse;margin-top:10px}
    .modal-table th,.modal-table td{border:1px solid #ccc;padding:6px 10px;text-align:center}
    .modal-table th{background:#f0f4f8;font-weight:600}

    /* M√≥vil */
    @media (max-width:480px){
      body{font-size:14px;line-height:1.3}
      .container{width:95vw;max-width:400px;margin:8px auto;border-radius:10px;box-shadow:none}
      .form-container{padding:12px 10px}
      .form-card{padding:14px 12px 8px;margin-bottom:8px;border:1px solid var(--border);box-shadow:none}
      .form-card h3{font-size:1.1em;margin-bottom:8px;line-height:1.3}
      .input-row-group{display:block}
      .input-row{grid-template-columns:1fr;gap:6px;min-width:0}
      .unit{font-size:.85em;color:var(--text-soft)}
      .results{padding:12px 10px;font-size:1em;margin-top:14px;line-height:1.3}
      .parameter-status{grid-template-columns:1fr;gap:6px;margin-top:8px}
      .parameter-item{font-size:.9em;padding:5px 8px;word-wrap:break-word;margin-bottom:4px;line-height:1.2}
      input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü´Ä Calculadora de Funci√≥n Diast√≥lica</h1>
      <div class="subtitle">ASE 2025</div>
    </div>

    <div class="form-container">
      <a id="openAlgInfo" class="alg-link" href="javascript:void(0)">¬øC√≥mo funciona el algoritmo?</a>

      <!-- novalidate: evita bloqueo de Safari iOS con coma -->
      <form id="diastolicForm" novalidate>
        <div class="form-card">
          <h3>ü©∫ Contexto cl√≠nico</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Ritmo:</label>
              <select id="ritmo" onchange="toggleEASection();updateAgeReferences();">
                <option value="sinusal">Ritmo sinusal</option>
                <option value="fa">Fibrilaci√≥n auricular</option>
              </select>
              <span class="unit"></span>
            </div>
            <div class="input-row">
              <label>FEVI:</label>
              <select id="fevi" onchange="updateAgeReferences()">
                <option value="mayorigual">‚â•50%</option>
                <option value="menor">&lt;50%</option>
              </select>
              <span class="unit"></span>
            </div>
            <div class="input-row">
              <label>Edad:</label>
              <select id="edad" onchange="updateAgeReferences()">
                <option value="1">20‚Äì39 a√±os</option>
                <option value="2">40‚Äì65 a√±os</option>
                <option value="3">&gt;65 a√±os</option>
              </select>
              <span class="unit"></span>
            </div>
            <div class="input-row input-row--full">
              <label>Escenario especial:</label>
              <select id="escenarioEspecial" onchange="updateAgeReferences()">
                <option value="normal" selected>‚Äî Caso general ‚Äî</option>
                <option value="AF">Fibrilaci√≥n auricular</option>
                <option value="MAC">MAC moderada/severa</option>
                <option value="MR">Insuficiencia mitral significativa</option>
                <option value="MS">Estenosis mitral significativa</option>
                <option value="PHnoCard">Hipertensi√≥n pulmonar no cardiaca</option>
                <option value="LVAD">LVAD</option>
                <option value="HTX">Trasplante card√≠aco</option>
                <option value="Constriccion">Pericarditis constrictiva</option>
                <option value="HCM">Miocardiopat√≠a hipertr√≥fica</option>
                <option value="BCRI_CRT">BCRI / CRT / marcapaseo</option>
              </select>
              <span class="unit"></span>
            </div>
          </div>
        </div>

        <div id="ageReferences" class="age-reference" style="display:none;">
          <strong>üìä Valores de referencia para este perfil:</strong>
          <div id="ageReferenceContent"></div>
          <div id="scenarioHint" style="margin-top:6px;"></div>
        </div>

        <div class="form-card" id="eaSection">
          <h3>üîÑ Flujo mitral (Doppler pulsado)</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Onda E:</label>
              <input type="number" id="velocidadE" step="0.1" min="0" max="300" placeholder="Opcional" inputmode="decimal"/>
              <span class="unit">cm/s</span>
            </div>
            <div class="input-row">
              <label>Onda A:</label>
              <input type="number" id="velocidadA" step="0.1" min="0" max="300" placeholder="Opcional" inputmode="decimal"/>
              <span class="unit">cm/s</span>
            </div>
          </div>
        </div>

        <div id="faWarning" class="fevi-warning" style="display:none;">
          ‚ö†Ô∏è <strong>Fibrilaci√≥n auricular:</strong> No se utiliza la relaci√≥n E/A para el diagn√≥stico. La onda E s√≠ se usa para calcular E/e‚Ä≤.
        </div>

        <div class="form-card">
          <h3>üéØ Doppler tisular</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>e‚Ä≤ lateral:</label>
              <input type="number" id="eLateral" step="0.1" min="0" max="30" placeholder="Opcional" inputmode="decimal"/>
              <span class="unit">cm/s</span>
            </div>
            <div class="input-row">
              <label>e‚Ä≤ septal:</label>
              <input type="number" id="eSeptal" step="0.1" min="0" max="30" placeholder="Opcional" inputmode="decimal"/>
              <span class="unit">cm/s</span>
            </div>
          </div>
        </div>

        <div class="form-card">
          <h3>üìè Aur√≠cula izquierda</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Tipo de medici√≥n:</label>
              <select id="tipoAI" onchange="toggleAIInput();updateAgeReferences();">
                <option value="volumen">Volumen indexado</option>
                <option value="area">√Årea</option>
              </select>
              <span class="unit"></span>
            </div>
            <div class="input-row" id="volumenRow">
              <label>Vol AI indexado:</label>
              <input type="number" id="volumenAI" step="1" min="0" max="200" placeholder="Opcional" inputmode="decimal"/>
              <span class="unit">ml/m¬≤</span>
            </div>
            <div class="input-row" id="areaRow" style="display:none;">
              <label>√Årea auricular izquierda:</label>
              <input type="number" id="areaAI" step="0.1" min="0" max="60" placeholder="Opcional" inputmode="decimal"/>
              <span class="unit">cm¬≤</span>
            </div>
          </div>
          <div class="ai-option-note">
            <em>Si solo dispone de <strong>√Årea AI</strong>, se acepta como subrogante de LAVi (umbral ‚â§20 cm¬≤ ‚âà LAVi ‚â§34 ml/m¬≤).</em>
          </div>
        </div>

        <div class="form-card">
          <h3>üåä TR / PSAP</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Par√°metro:</label>
              <select id="parametroPresion" onchange="syncPresionUI()">
                <option value="TR" selected>Velocidad pico TR</option>
                <option value="PSAP">PSAP</option>
              </select>
              <span class="unit"></span>
            </div>
            <div class="input-row">
              <label id="labelPresion">Velocidad pico TR:</label>
              <input type="number" id="valorPresion" step="0.01" min="0" max="6" placeholder="Opcional" inputmode="decimal"/>
              <span class="unit" id="unidadPresion">m/s</span>
            </div>
          </div>
        </div>

        <div class="form-card">
          <h3>‚≠ê Strain auricular izquierdo</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>LA Strain:</label>
              <input type="number" id="laStrain" step="1" min="0" max="60" placeholder="Opcional" inputmode="decimal"/>
              <span class="unit">%</span>
            </div>
          </div>
        </div>

        <!-- Calculadora avanzada (colapsable) -->
        <div class="form-card" id="advanced">
          <h3 style="display:flex;align-items:center;gap:10px;cursor:pointer" onclick="toggleAdvanced()">
            <svg id="advChevron" width="16" height="16" viewBox="0 0 24 24" fill="none" style="transition:transform .2s"><path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            üß© Calculadora avanzada
          </h3>
          <div id="advancedContent" style="display:none;">
            <div class="input-row-group">
              <div class="input-row">
                <label>IVRT:</label>
                <input type="number" id="ivrt" step="1" min="20" max="200" placeholder="Opcional" inputmode="decimal"/>
                <span class="unit">ms</span>
              </div>
              <div class="input-row">
                <label>Relaci√≥n PV S/D:</label>
                <input type="number" id="sd" step="0.01" min="0" max="3" placeholder="Opcional" inputmode="decimal"/>
                <span class="unit">‚Äî</span>
              </div>
            </div>
            <div class="ai-option-note" style="margin-top:8px;">
              <em>Use IVRT y PV S/D (‚â§0.67) para desempatar cuando los pilares est√©n discordantes o falte TR/PSAP.</em>
            </div>
          </div>
        </div>

        <button id="btnCalcular" type="submit" class="calculate-btn">üßÆ Calcular funci√≥n diast√≥lica</button>
      </form>

      <div id="results" class="results" aria-live="polite">
        <div id="feviWarning" class="fevi-warning" style="display:none;">
          ‚ö†Ô∏è <strong>FEVI reducida:</strong> En pacientes con FEVI &lt;50%, se asume disfunci√≥n diast√≥lica. Lo relevante es estimar la presi√≥n de llenado.
        </div>
        <div id="indeterminateNote" class="indeterminate-note" style="display:none;">
          Resultado indeterminado/discordante. Considere par√°metros adicionales (LAVi, LARS, PV S/D, IVRT) o eco de ejercicio si hay s√≠ntomas.
        </div>
        <h3 id="diagnostico" tabindex="-1">Resultado</h3>
        <div id="pressureStatus" class="pressure-status"></div>
        <div id="parametros-status" class="parameter-status"></div>
        <div id="recomendaciones" class="recommendations"></div>
      </div>

      <div class="referencias">
        <h3>üìö Referencia</h3>
        <div class="referencia-item">
          <p>
            <strong>ASE 2025. Left Ventricular Diastolic Function by Echo</strong><br />
            <a href="https://www.asecho.org/guideline/left-ventricular-diastolic-function-by-echo/" target="_blank" rel="noopener">
              P√°gina oficial ASE
            </a> ¬∑
            <a href="https://www.asecho.org/wp-content/uploads/2025/07/Left-Ventricular-Diastolic-Function.pdf" target="_blank" rel="noopener">
              PDF de la gu√≠a
            </a><br />
            <small>DOI: <a href="https://doi.org/10.1016/j.echo.2025.03.011" target="_blank" rel="noopener">10.1016/j.echo.2025.03.011</a></small>
          </p>
        </div>
      </div>

      <div class="twitter-section">
        <a href="https://x.com/atomasyoung" target="_blank" rel="noopener" class="twitter-link">
          <svg class="twitter-icon" viewBox="0 0 1200 1227" fill="currentColor" width="24" height="24" aria-hidden="true"><path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"/></svg>
          @atomasyoung
        </a>
        <a href="https://www.linkedin.com/in/tomas-young" target="_blank" rel="noopener" class="linkedin-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor" width="24" height="24" aria-hidden="true"><path d="M100.28 448H7.4V148.9h92.88zm-46.44-340.7a53.66 53.66 0 1 1 53.66-53.66 53.66 53.66 0 0 1-53.66 53.66zM447.9 448h-92.68V302.4c0-34.7-12.4-58.4-43.4-58.4-23.7 0-37.8 15.9-44 31.3-2.3 5.6-2.9 13.4-2.9 21.3V448h-92.68s1.2-270.1 0-297.1h92.68v42.1c12.3-19 34.3-46 83.4-46 60.9 0 106.7 39.8 106.7 125.4z"/></svg>
          Tomas Young
        </a>
      </div>

      <div class="version-footer">v1.3.0 ¬∑ actualizada 13/08/2025</div>
    </div>
  </div>

  <!-- Modal -->
  <div id="algModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">√ó</button>
      <h2>üß† Algoritmo</h2>
      <div class="modal-body">
        <h4>1) Pilares (primarios ASE 2025)</h4>
        <p>1) e‚Ä≤ reducido (ajustado por edad) ¬∑ 2) E/e‚Ä≤ elevado ¬∑ 3) TR ‚â•2.8 m/s <em>o</em> PSAP ‚â•35 mmHg.</p>

        <h4>2) FEVI &lt;50%</h4>
        <p>Se asume disfunci√≥n diast√≥lica; estime LAP y, si corresponde, la gradaci√≥n seg√∫n E/A (ver abajo).</p>

        <h4>3) Ritmo sinusal (general)</h4>
        <ul>
          <li>Todos normales ‚Üí LAP normal (DF normal)</li>
          <li>Solo e‚Ä≤ reducido ‚Üí si E/A ‚â§0.8 ‚Üí <strong>Grado 1</strong>; si E/A &gt;0.8, use adicionales</li>
          <li>TR/PASP elevado solo, o E/e‚Ä≤ elevado solo, o ‚â•2 primarios anormales ‚Üí use adicionales</li>
          <li>Si ‚â•1 adicional anormal ‚Üí LAP elevada ‚Üí <strong>Grado 2</strong> si E/A &lt;2, <strong>Grado 3</strong> si E/A ‚â•2</li>
        </ul>

        <h4>4) Adicionales (ASE 2025)</h4>
        <p>PV S/D ‚â§0.67, LARS ‚â§18%, LAVi &gt;34 ml/m¬≤; alternativamente IVRT ‚â§70 ms.</p>

        <h4>5) Especiales</h4>
        <p>En <strong>MAC/MS/MR, AF, PH no cardiaca, LVAD, HTX, constricci√≥n</strong> no se usa el algoritmo general para gradaci√≥n.</p>

        <h4>6) Cortes de e‚Ä≤ por edad</h4>
        <table class="modal-table">
          <thead><tr><th>Edad</th><th>e‚Ä≤ septal</th><th>e‚Ä≤ lateral</th><th>e‚Ä≤ promedio</th></tr></thead>
          <tbody>
            <tr><td>20‚Äì39</td><td>‚â•7</td><td>‚â•10</td><td>‚â•9</td></tr>
            <tr><td>40‚Äì65</td><td>‚â•6</td><td>‚â•8</td><td>‚â•7</td></tr>
            <tr><td>&gt;65</td><td>‚â•6</td><td>‚â•7</td><td>‚â•6.5</td></tr>
          </tbody>
        </table>

        <p><strong>Independientes de edad:</strong> E/e‚Ä≤ ‚â§14, TR ‚â§2.8 m/s <em>o</em> PSAP &lt;35 mmHg, LAVi ‚â§34 ml/m¬≤ (√Årea ‚â§20 cm¬≤ proxy), LARS ‚â•18% (espec√≠fico) / ‚â•23% (normal).</p>
      </div>
    </div>
  </div>

  <script>
    // --- iOS hotfix: normaliza comas en iPhone/iPad ---
    function iosDecimalHotfix(){
      const isIOS = /iP(hone|od|ad)/.test(navigator.userAgent);
      const ids = [
        'velocidadE','velocidadA','eLateral','eSeptal',
        'volumenAI','areaAI','valorPresion','laStrain','ivrt','sd'
      ];
      ids.forEach(id=>{
        const el=document.getElementById(id);
        if(!el) return;
        if(isIOS){ el.type='text'; el.setAttribute('inputmode','decimal'); }
        else{ if(el.type==='number') el.setAttribute('step','any'); }
        el.addEventListener('input', ()=>{
          if (typeof el.value==='string' && el.value.includes(',')) {
            el.value = el.value.replace(/,/g,'.');
          }
        });
      });
    }

    // --- Parseo robusto coma/punto ---
    function parseNum(id){
      const el=document.getElementById(id); if(!el) return NaN;
      let raw=(el.value||'').trim();
      raw = raw.replace(/,/g,'.').replace(/[^0-9.\-]/g,'').replace(/(?!^)-/g,'').replace(/(\..*)\./g,'$1');
      const n=parseFloat(raw);
      return isNaN(n)?NaN:n;
    }

    // Modal
    function openModal(){ document.getElementById('algModal').style.display='block'; }
    function closeModal(){ document.getElementById('algModal').style.display='none'; }

    // Advanced
    function toggleAdvanced(){
      const c=document.getElementById('advancedContent');
      const chev=document.getElementById('advChevron');
      const open=c.style.display!=='block';
      c.style.display=open?'block':'none';
      chev.style.transform=open?'rotate(90deg)':'rotate(0deg)';
    }

    // UI toggles
    function toggleEASection(){
      const ritmo=document.getElementById('ritmo').value;
      const eRow=document.getElementById('velocidadE').closest('.input-row');
      const aRow=document.getElementById('velocidadA').closest('.input-row');
      const faWarn=document.getElementById('faWarning');
      if(ritmo==='fa'){ faWarn.style.display='block'; eRow.style.display='grid'; aRow.style.display='none'; document.getElementById('velocidadA').value=''; }
      else { faWarn.style.display='none'; eRow.style.display='grid'; aRow.style.display='grid'; }
    }
    function toggleAIInput(){
      const tipo=document.getElementById('tipoAI').value;
      const vol=document.getElementById('volumenRow');
      const area=document.getElementById('areaRow');
      if(tipo==='volumen'){ vol.style.display='grid'; area.style.display='none'; document.getElementById('areaAI').value=''; }
      else { vol.style.display='none'; area.style.display='grid'; document.getElementById('volumenAI').value=''; }
    }
    function syncPresionUI(){
      const sel=document.getElementById('parametroPresion').value;
      const label=document.getElementById('labelPresion');
      const unidad=document.getElementById('unidadPresion');
      const input=document.getElementById('valorPresion');
      if(sel==='PSAP'){ label.textContent='PSAP:'; unidad.textContent='mmHg'; input.min=0; input.max=120; input.step=0.1; }
      else { label.textContent='Velocidad pico TR:'; unidad.textContent='m/s'; input.min=0; input.max=6; input.step=0.01; }
    }

    // Hint por escenario
    function scenarioText(esc,ritmo){
      switch(esc){
        case 'MAC': return "MAC moderada/severa ‚Üí E/A ‚â§0.8 sugiere LAP normal; ‚â•1.8 sugiere LAP elevada. Si 0.8‚Äì1.8, use IVRT (‚â•80 ms normal, <80 ms elevada).";
        case 'MR': return "MR significativa ‚Üí priorice LARS, PV S/D ‚â§0.67 e IVRT bajo (‚â§60‚Äì70 ms); LAVi/√Årea pueden elevarse por volumen.";
        case 'MS': return "MS significativa ‚Üí apoyarse en TR/PSAP, PV S/D e IVRT; E y E/A se distorsionan.";
        case 'PHnoCard': return "HP no cardiaca ‚Üí TR/PSAP no cuentan para LAP; use e‚Ä≤, E/e‚Ä≤ y adicionales.";
        case 'LVAD': return "LVAD ‚Üí enfoque orientativo (PV S/D, LARS y cl√≠nica); convencionales poco fiables.";
        case 'HTX': return "Trasplante ‚Üí priorice LARS y PV S/D; e‚Ä≤/E/e‚Ä≤ pueden alterarse.";
        case 'Constriccion': return "Constrictiva ‚Üí no penalizar e‚Ä≤; priorizar PV S/D e IVRT.";
        case 'HCM': return "MCH ‚Üí E/e‚Ä≤ alto requiere soporte (LARS, PV S/D, LAVi) antes de concluir LAP elevada.";
        case 'BCRI_CRT': return "BCRI/CRT ‚Üí e‚Ä≤ lateral puede ser poco fiable; priorice e‚Ä≤ septal para el promedio.";
        case 'AF': return "FA ‚Üí no usar E/A; pilares: e‚Ä≤ por edad, E/e‚Ä≤ y TR/PSAP; soporte con LARS, PV S/D e IVRT.";
        default:
          return (ritmo==='fa')
            ? "FA ‚Üí no usar E/A; pilares: e‚Ä≤ por edad, E/e‚Ä≤ y TR/PSAP; soporte con LARS, PV S/D e IVRT."
            : "Caso general ‚Üí pilares e‚Ä≤ (por edad), E/e‚Ä≤ y TR/PSAP; desempate con LARS, LAVi/√Årea, PV S/D (‚â§0.67) e IVRT.";
      }
    }

    function updateAgeReferences(){
      const edad=document.getElementById('edad').value;
      const ritmo=document.getElementById('ritmo').value;
      const fevi=document.getElementById('fevi').value;
      const tipoAI=document.getElementById('tipoAI').value;
      const esc=document.getElementById('escenarioEspecial').value;

      let eSep,eLat,eAvg;
      if(edad==='1'){ eSep=7.0; eLat=10.0; eAvg=9.0; }
      else if(edad==='2'){ eSep=6.0; eLat=8.0; eAvg=7.0; }
      else { eSep=6.0; eLat=7.0; eAvg=6.5; }

      const aiRef=(tipoAI==='volumen')?"LAVi ‚â§34 ml/m¬≤":"√Årea AI ‚â§20 cm¬≤ (proxy)";
      const ritmoRef=(ritmo==='fa')?"<br>‚Ä¢ En FA no se utiliza E/A":"";
      const feviRef=(fevi==='menor')?"<br>‚Ä¢ FEVI reducida: se asume disfunci√≥n diast√≥lica":"";

      const content=`
        ‚Ä¢ e‚Ä≤ promedio ‚â• ${eAvg} cm/s (lateral ‚â• ${eLat}, septal ‚â• ${eSep})<br>
        ‚Ä¢ E/e‚Ä≤ ‚â§ 14<br>
        ‚Ä¢ ${aiRef}<br>
        ‚Ä¢ TR ‚â§ 2.8 m/s <em>o</em> PSAP &lt; 35 mmHg<br>
        ‚Ä¢ LA Strain ‚â• 18% (espec√≠fico), ‚â• 23% (normal)
        ${ritmoRef}${feviRef}
      `;
      document.getElementById('ageReferenceContent').innerHTML=content;
      document.getElementById('scenarioHint').innerHTML=scenarioText(esc,ritmo);
      document.getElementById('ageReferences').style.display='block';
    }

    // --- Algoritmo principal ASE 2025 ---
    function calcularFuncionDiastolica(){
      const ritmo=document.getElementById('ritmo').value;
      const edad=document.getElementById('edad').value;
      const fevi=document.getElementById('fevi').value;
      const tipoAI=document.getElementById('tipoAI').value;
      const paramP=document.getElementById('parametroPresion').value;
      const esc=document.getElementById('escenarioEspecial').value;

      const feviWarn=document.getElementById('feviWarning');
      const indNote=document.getElementById('indeterminateNote');
      feviWarn.style.display="none"; indNote.style.display="none";

      const v={
        eSeptal:parseNum('eSeptal'),
        eLateral:parseNum('eLateral'),
        volumenAI:parseNum('volumenAI'),
        areaAI:parseNum('areaAI'),
        parametroPresion:paramP,
        valorPresion:parseNum('valorPresion'),
        laStrain:parseNum('laStrain'),
        velocidadE:parseNum('velocidadE'),
        velocidadA:parseNum('velocidadA'),
        ivrt:parseNum('ivrt'),
        sd:parseNum('sd'),
        escenarioEspecial:esc
      };

      const faltan=[];
      if(isNaN(v.eSeptal)) faltan.push("e' septal");
      if(isNaN(v.eLateral)) faltan.push("e' lateral");
      if(tipoAI==='volumen' && isNaN(v.volumenAI)) faltan.push("Volumen AI indexado");
      if(tipoAI==='area' && isNaN(v.areaAI))     faltan.push("√Årea AI");
      if(v.parametroPresion==='TR' && isNaN(v.valorPresion))   faltan.push("Velocidad TR");
      if(v.parametroPresion==='PSAP' && isNaN(v.valorPresion)) faltan.push("PSAP");
      if(ritmo==='sinusal'){ if(isNaN(v.velocidadE)) faltan.push("Onda E"); if(isNaN(v.velocidadA)) faltan.push("Onda A"); }
      if(isNaN(v.laStrain)) faltan.push("LA Strain");

      // E/A
      let ea=null;
      if(ritmo==='sinusal' && !isNaN(v.velocidadE) && !isNaN(v.velocidadA) && v.velocidadA>0){
        ea=v.velocidadE/v.velocidadA;
      }

      // e' promedio (ajustes)
      let eLat=v.eLateral, eSep=v.eSeptal;
      if(esc==='BCRI_CRT' && !isNaN(eSep)) eLat=NaN;
      let eProm=null;
      if(!isNaN(eSep) && !isNaN(eLat)) eProm=(eSep+eLat)/2;
      else if(!isNaN(eSep)) eProm=eSep;
      else if(!isNaN(eLat)) eProm=eLat;

      // E/e'
      let ee=null; if(!isNaN(v.velocidadE) && eProm>0) ee=v.velocidadE/eProm;

      // Cortes por edad
      let eSepRef,eLatRef,eAvgRef;
      if(edad==='1'){ eSepRef=7; eLatRef=10; eAvgRef=9; }
      else if(edad==='2'){ eSepRef=6; eLatRef=8; eAvgRef=7; }
      else { eSepRef=6; eLatRef=7; eAvgRef=6.5; }

      // Mostrar par√°metros
      const params=[];
      let eLatOk=null,eSepOk=null,eAvgOk=null,eeOk=null,aiOk=null,presOk=null,larsOk=null;

      if(!isNaN(v.eLateral)){
        eLatOk=(esc==='BCRI_CRT')?null:(v.eLateral>=eLatRef);
        params.push({n:"e' lateral",val:v.eLateral.toFixed(1)+" cm/s",st:eLatOk===null?"indeterminate":(eLatOk?"normal":"abnormal"),ref:(esc==='BCRI_CRT')?"‚Äî (ignorado)":"‚â•"+eLatRef+" cm/s"});
      }
      if(!isNaN(v.eSeptal)){
        eSepOk=v.eSeptal>=eSepRef;
        params.push({n:"e' septal",val:v.eSeptal.toFixed(1)+" cm/s",st:eSepOk?"normal":"abnormal",ref:"‚â•"+eSepRef+" cm/s"});
      }
      if(eProm!==null){
        if(esc==='Constriccion'){
          eAvgOk=null;
          params.push({n:"e' promedio",val:eProm.toFixed(1)+" cm/s",st:"indeterminate",ref:"No penaliza en constricci√≥n"});
        }else{
          eAvgOk=eProm>=eAvgRef;
          params.push({n:"e' promedio",val:eProm.toFixed(1)+" cm/s",st:eAvgOk?"normal":"abnormal",ref:"‚â•"+eAvgRef+" cm/s"});
        }
      }
      if(ritmo==='sinusal' && ea!==null){
        params.push({n:"Relaci√≥n E/A",val:ea.toFixed(2),st:"indeterminate",ref:"Informativo p/gradaci√≥n"});
      }
      if(ee!==null){
        const lim=14; eeOk=ee<=lim;
        const refTxt=(esc==='HCM')?"‚â§14 (requiere soporte si >14)":"‚â§14";
        params.push({n:"E/e' promedio",val:ee.toFixed(1),st:eeOk?"normal":"abnormal",ref:refTxt});
      }
      if(tipoAI==='volumen' && !isNaN(v.volumenAI)){
        aiOk=v.volumenAI<=34; const note=(esc==='MR')?" (no primaria en MR)":"";
        params.push({n:"Volumen AI indexado",val:v.volumenAI+" ml/m¬≤",st:aiOk?"normal":"abnormal",ref:"‚â§34 ml/m¬≤"+note});
      }else if(tipoAI==='area' && !isNaN(v.areaAI)){
        aiOk=v.areaAI<=20; const note=(esc==='MR')?" (no primaria en MR)":"";
        params.push({n:"√Årea AI",val:v.areaAI+" cm¬≤",st:aiOk?"normal":"abnormal",ref:"‚â§20 cm¬≤ (proxy)"+note});
      }
      if(!isNaN(v.valorPresion)){
        if(v.parametroPresion==='TR'){
          presOk=v.valorPresion<=2.8;
          params.push({n:"Velocidad TR",val:v.valorPresion.toFixed(2)+" m/s",st:presOk?"normal":"abnormal",ref:"‚â§2.8 m/s"+(esc==='PHnoCard'?" (neutralizado)":"")});
        }else{
          presOk=v.valorPresion<35;
          params.push({n:"PSAP",val:v.valorPresion.toFixed(1)+" mmHg",st:presOk?"normal":"abnormal",ref:"<35 mmHg"+(esc==='PHnoCard'?" (neutralizado)":"")});
        }
      }
      if(!isNaN(v.laStrain)){
        larsOk=v.laStrain>=18;
        const refL=(v.laStrain>=23)?"‚â•23% (normal)":"‚â•18% (espec√≠fico)";
        params.push({n:"LA Strain",val:v.laStrain.toFixed(1)+" %",st:larsOk?"normal":"abnormal",ref:refL});
      }

      // Pilares (primarios) contables
      const eReduced = (eAvgOk===false); // e' por edad reducido
      const eeElevated = (eeOk===false) && !(esc==='HCM' && eeOk===false); // en HCM requiere soporte
      const presElevated = (presOk===false) && esc!=='PHnoCard';
      let abnormalPrimaries = 0;
      if(eReduced===true || eReduced===false) abnormalPrimaries += eReduced?1:0;
      if(eeElevated===true || eeElevated===false) abnormalPrimaries += eeElevated?1:0;
      if(presElevated===true || presElevated===false) abnormalPrimaries += presElevated?1:0;

      // Adicionales (ASE 2025)
      const pvSDlow = (!isNaN(v.sd) && v.sd <= 0.67); // PV S/D ‚â§0.67
      const cIV = (esc==='MR'||esc==='MS')?60:70;
      const ivrtLow = (!isNaN(v.ivrt) && v.ivrt<=cIV);
      const usarAIcomoPrimaria = (esc!=='MR');
      const laviHigh = (tipoAI==='volumen' && !isNaN(v.volumenAI) && v.volumenAI>34) || (tipoAI==='area' && !isNaN(v.areaAI) && v.areaAI>20);
      const larsLow = (!isNaN(v.laStrain) && v.laStrain<=18);

      const additionalPositive = (pvSDlow || larsLow || laviHigh || ivrtLow);

      // Reglas MAC expl√≠citas (se mantiene)
      let macHint="";
      if(esc==='MAC' && ritmo==='sinusal' && ea!==null){
        if(ea<0.8){ macHint="E/A ‚â§0.8 (MAC) ‚Üí LAP normal"; }
        else if(ea>1.8){ macHint="E/A ‚â•1.8 (MAC) ‚Üí LAP elevada"; }
        else if(isNaN(v.ivrt)){ macHint="E/A 0.8‚Äì1.8 (MAC) ‚Üí mida IVRT (80 ms)"; }
      }

      // Diagn√≥stico base + gradaci√≥n ASE 2025
      let dx="", ptxt="", comments=[];
      const tieneTRoPSAP=(presOk!==null);

      if(fevi==='menor'){ feviWarn.style.display="block"; }

      const isSpecial = ['MAC','MR','MS','AF','PHnoCard','LVAD','HTX','Constriccion'].includes(esc);
      const canGrade = (ritmo==='sinusal' && !isSpecial && ea!==null);

      if(ritmo==='fa' || esc==='AF'){
        // FA: sin gradaci√≥n
        let a=0,n=0;
        if(eReduced!==null){ a+=eReduced?1:0; n+=eReduced?0:1; }
        if(eeOk!==null){ a+=eeElevated?1:0; n+=eeElevated?0:1; }
        if(presOk!==null && esc!=='PHnoCard'){ a+=presElevated?1:0; n+=presElevated?0:1; }
        if(a>=2){ dx="FA: LAP elevada"; ptxt="Presi√≥n de llenado elevada"; }
        else if(n>=2){ dx="FA: LAP normal"; ptxt="Presi√≥n de llenado normal"; }
        else { dx="FA: Indeterminado"; indNote.style.display="block"; }
        comments.push("FA: no se grad√∫a la disfunci√≥n.");
      } else {
        // RS, algoritmo ASE 2025 (Figura 3)
        if(eReduced===false && !eeElevated && !presElevated){
          dx="Funci√≥n diast√≥lica normal"; ptxt="Presi√≥n de llenado normal";
        } else if(eReduced===true && !eeElevated && !presElevated){
          // Solo e' reducido
          if(canGrade && ea<=0.8){
            dx="LAP normal; disfunci√≥n diast√≥lica (Grado 1)";
            ptxt="Presi√≥n de llenado normal";
          } else {
            dx="Posible disfunci√≥n (solo e‚Ä≤ reducido)";
            ptxt="LAP a definir con adicionales";
            if(additionalPositive){
              // Si adicional(+) ‚Üí LAP elevada ‚Üí Grado 2/3 seg√∫n E/A
              if(canGrade){
                dx = (ea>=2.0) ? "Disfunci√≥n diast√≥lica; LAP elevada (Grado 3)" : "Disfunci√≥n diast√≥lica; LAP elevada (Grado 2)";
                ptxt="Presi√≥n de llenado elevada";
              } else {
                dx="Disfunci√≥n diast√≥lica; LAP elevada";
                ptxt="Presi√≥n de llenado elevada";
              }
            } else {
              indNote.style.display="block";
              comments.push("e‚Ä≤ reducido con E/e‚Ä≤ y TR/PSAP normales: si E/A ‚â§0.8 ‚Üí Grado 1; de lo contrario, requiera adicionales (LARS ‚â§18%, PV S/D ‚â§0.67, LAVi >34, IVRT ‚â§70 ms).");
            }
          }
        } else {
          // TR/PASP solo, E/e' solo, o ‚â•2 primarios anormales
          let lapElevada=false;
          if((eeElevated && !presElevated && !eReduced) || (presElevated && !eeElevated && !eReduced) || (abnormalPrimaries>=2)){
            if(additionalPositive || abnormalPrimaries===3){
              lapElevada=true;
            } else {
              indNote.style.display="block";
              comments.push("Discordancia: faltan/negativos adicionales; considere eco de ejercicio si hay s√≠ntomas.");
            }
          }
          if(lapElevada){
            if(canGrade){
              dx = (ea>=2.0) ? "Disfunci√≥n diast√≥lica; LAP elevada (Grado 3)" : "Disfunci√≥n diast√≥lica; LAP elevada (Grado 2)";
            } else {
              dx = "Disfunci√≥n diast√≥lica; LAP elevada";
            }
            ptxt="Presi√≥n de llenado elevada";
          } else if(!dx){
            dx="Indeterminado"; indNote.style.display="block";
          }
        }
      }

      // Nota t√©cnica si TR/PSAP alto pero resto normal
      if((dx.includes("LAP normal") || (ptxt||"").toLowerCase().includes("normal")) && presOk===false){
        comments.push("TR/PSAP elevados con E/e‚Ä≤ bajo y LAVi/√Årea normal sugieren LAP normal; verifique t√©cnica y confirme con adicionales.");
      }

      if(fevi==='menor'){
        comments.unshift("Con FEVI <50% se asume disfunci√≥n diast√≥lica; se informa LAP y, en RS, la gradaci√≥n seg√∫n E/A.");
      }

      // Advertencias por faltantes
      let adv="";
      if(faltan.length>0) adv+=`<div class="indeterminate-note"><strong>‚ö†Ô∏è Par√°metros no ingresados:</strong> ${faltan.join(", ")}.</div>`;
      if(isNaN(v.velocidadE)) adv+="<br>‚ö†Ô∏è Falta Onda E ‚Üí no se puede calcular E/e‚Ä≤.";
      if(macHint) adv+=`<div class="indeterminate-note" style="background:#e8f4fd;border-color:#b3d8f7;color:#1e3a5f;">${macHint}</div>`;

      // Render
      const results=document.getElementById('results');
      const h=document.getElementById('diagnostico');
      const p=document.getElementById('pressureStatus');

      h.textContent=dx||"Resultado"; p.textContent=ptxt||"";
      results.className="results";
      const dl=(dx||"").toLowerCase(); const pl=(ptxt||"").toLowerCase();
      if(dl.includes("normal") && !dl.includes("disfunci√≥n")) results.classList.add("normal");
      else if(dl.includes("disfunci√≥n") || pl.includes("elevada")) results.classList.add("abnormal");
      else results.classList.add("indeterminate");

      p.className="pressure-status";
      if(pl.includes("elevada")) p.classList.add("elevated");
      else if(pl.includes("normal")) p.classList.add("normal");

      let html="";
      params.forEach(pp=>{
        html+=`<div class="parameter-item ${pp.st}"><strong>${pp.n}:</strong> ${pp.val} <span style="color:#888;font-size:.95em;">(${pp.ref})</span></div>`;
      });
      document.getElementById('parametros-status').innerHTML=html;

      const commentHTML = comments.length ? ("<ul style='margin:8px 0 0 18px; padding:0'>" + comments.map(c=>`<li>${c}</li>`).join("") + "</ul>") : "";
      document.getElementById('recomendaciones').innerHTML=adv + commentHTML;

      results.style.display="block";
      h.focus({preventScroll:true});
      results.scrollIntoView({behavior:"smooth",block:"start"});
    }

    // Eventos
    document.addEventListener('DOMContentLoaded',()=>{
      iosDecimalHotfix(); // iPhone listo

      document.getElementById('openAlgInfo').addEventListener('click',openModal);
      document.getElementById('algModal').addEventListener('click',(e)=>{if(e.target===e.currentTarget) closeModal();});
      document.addEventListener('keydown',(e)=>{if(e.key==="Escape"){const m=document.getElementById('algModal');if(m.style.display==='block') closeModal();}});

      document.getElementById('diastolicForm').addEventListener('submit',(e)=>{e.preventDefault();calcularFuncionDiastolica();});
      document.querySelectorAll('input,select').forEach(el=>{
        el.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); calcularFuncionDiastolica(); }});
      });

      updateAgeReferences();
      toggleEASection();
      toggleAIInput();
      syncPresionUI();
      document.getElementById('advancedContent').style.display='none';
    });
  </script>
</body>
</html>
