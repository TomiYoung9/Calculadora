<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Función Diastólica </title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-bg: #b7d0e8;
            --header-bg: #3a5a7a;
            --card-bg: #fff;
            --accent: #27ae60;
            --accent-dark: #219150;
            --accent-light: #e9f7ef;
            --text-main: #1a2a36;
            --text-soft: #5a6e7f;
            --border: #e3eaf2;
            --shadow: 0 4px 24px rgba(74,144,226,0.08);
            --red: #e74c3c;
            --green: #27ae60;
            --yellow: #f7b731;
            --blue: #3498db;
        }
        body {
            font-family: 'Inter', Arial, sans-serif;
            background: var(--main-bg);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 40px auto 0 auto;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .header {
            background: var(--header-bg);
            color: #fff;
            padding: 36px 20px 24px 20px;
            text-align: center;
            position: relative;
        }
        .header h1 {
            font-family: 'Inter', Arial, sans-serif;
            font-size: 2.1em;
            font-weight: 700;
            margin: 0 0 8px 0;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            color: #fff;
        }
        .header .subtitle {
            font-size: 1.08em;
            font-weight: 500;
            color: #fff;
            margin-top: 6px;
            letter-spacing: 0.2px;
        }
        .form-container {
            padding: 36px 22px 28px 22px;
        }
        .info-box {
            background: var(--accent-light);
            color: var(--text-main);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 24px;
            font-size: 1.05em;
            box-shadow: 0 2px 8px #4a90e211;
            position: relative;
        }
        .alg-link {
            display: block;
            text-align: right;
            margin-top: 6px;
            color: #3a5a7a;
            font-size: 0.97em;
            text-decoration: underline dotted;
            cursor: pointer;
            transition: color 0.2s;
        }
        .alg-link:hover {
            color: #27ae60;
        }
        .form-card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px #4a90e211;
            border: 1.5px solid var(--border);
            margin-bottom: 20px;
            padding: 22px 18px 12px 18px;
            transition: box-shadow 0.2s;
        }
        .form-card h3 {
            color: var(--text-main);
            font-size: 1.13em;
            font-weight: 600;
            margin-bottom: 14px;
            letter-spacing: 0.3px;
        }
        .input-row-group {
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
        }
        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
            flex: 1 1 220px;
            min-width: 220px;
        }
        .input-row label {
            font-weight: 500;
            color: var(--text-main);
            font-size: 1em;
            flex: 1 1 120px;
        }
        .input-row input, .input-row select {
            flex: 0 0 90px;
            padding: 9px 10px;
            border: 1.5px solid var(--border);
            border-radius: 6px;
            font-size: 1em;
            background: #f7fbfd;
            color: var(--text-main);
            transition: border-color 0.2s;
        }
        .input-row input:focus, .input-row select:focus {
            outline: none;
            border-color: var(--accent);
        }
        .unit {
            margin-left: 7px;
            color: var(--text-soft);
            font-weight: 500;
            font-size: 0.97em;
        }
        .ai-option-note {
            font-size: 0.92em;
            color: #5a6e7f;
            margin-top: 7px;
            font-style: italic;
        }
        .calculate-btn {
            width: 100%;
            padding: 13px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 9px;
            font-size: 1.13em;
            font-weight: 700;
            cursor: pointer;
            margin-top: 14px;
            box-shadow: 0 2px 8px #4a90e211;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .calculate-btn:hover {
            background: var(--accent-dark);
            box-shadow: 0 6px 24px #4a90e122;
        }
        .results {
            margin-top: 26px;
            padding: 22px 18px;
            border-radius: 10px;
            display: none;
        }
        .results.normal { background: #eafaf1; color: var(--green); border: 2px solid var(--green);}
        .results.abnormal { background: #fdeaea; color: var(--red); border: 2px solid var(--red);}
        .results.indeterminate { background: #fffbe6; color: var(--yellow); border: 2px solid var(--yellow);}
        .results h3 { font-size: 1.2em; margin-bottom: 10px; }
        .parameter-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 6px;
            margin-top: 12px;
        }
        .parameter-item {
            background: rgba(255,255,255,0.13);
            padding: 7px 10px;
            border-radius: 7px;
            border-left: 4px solid #fff;
            font-size: 1em;
            margin-bottom: 0;
        }
        .parameter-item.abnormal { border-left-color: var(--red); background: #fdeaea;}
        .parameter-item.normal { border-left-color: var(--green); background: #eafaf1;}
        .parameter-item.indeterminate { border-left-color: var(--yellow); background: #fffbe6;}
        .recommendations {
            margin-top: 12px;
            padding: 12px 10px;
            background: rgba(255,255,255,0.13);
            border-radius: 7px;
        }
        .fa-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px 12px;
            border-radius: 7px;
            margin-bottom: 12px;
            color: #856404;
            font-size: 1em;
        }
        .fevi-warning {
            background: #fff8e1;
            border: 1px solid #ffecb3;
            padding: 10px 12px;
            border-radius: 7px;
            margin-bottom: 12px;
            color: #6d4c41;
            font-size: 1em;
        }
        .tr-warning {
            background: #e3f1fd;
            border: 1.5px solid #b3d8f7;
            color: #357ab8;
            padding: 10px 12px;
            border-radius: 7px;
            margin-bottom: 12px;
            font-size: 1em;
            display: none;
        }
        .indeterminate-note {
            background: #fffbe6;
            border: 1.5px solid var(--yellow);
            color: #b38600;
            padding: 10px 12px;
            border-radius: 7px;
            margin-bottom: 12px;
            font-size: 1em;
        }
        .age-reference {
            background: #e8f4fd;
            padding: 10px 12px;
            border-radius: 7px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent);
        }
        .missing-params-warning {
            background: #fffbe6;
            border: 1.5px solid var(--yellow);
            color: #b38600;
            padding: 10px 12px;
            border-radius: 7px;
            margin-bottom: 12px;
            font-size: 1em;
        }
        .referencias {
            margin-top: 28px;
            padding: 16px 12px;
            background: #f8f9fa;
            border-radius: 9px;
            border-left: 5px solid var(--accent-light);
        }
        .referencias h3 {
            color: var(--text-main);
            margin-bottom: 12px;
            font-size: 1.08em;
        }
        .referencia-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 7px;
            box-shadow: 0 2px 5px #4a90e20a;
        }
        .referencia-item p { margin: 0; line-height: 1.6; color: var(--text-main); }
        .referencia-item a { color: var(--accent); text-decoration: none; font-weight: 500; }
        .referencia-item a:hover { color: var(--accent-dark); text-decoration: underline; }
        .twitter-section {
            text-align: center;
            padding: 10px;
            margin-bottom: 6px;
        }
        .twitter-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #111;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }
        .twitter-link:hover { color: var(--accent); }
        .twitter-icon { width: 24px; height: 24px; }
        .pressure-status {
            font-size: 1.08em;
            font-weight: bold;
            margin-top: 8px;
            padding: 7px;
            border-radius: 7px;
            text-align: center;
        }
        .pressure-status.normal { background: #eafaf1; color: var(--green);}
        .pressure-status.elevated { background: #fdeaea; color: var(--red);}

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: #fff;
            max-width: 700px;
            margin: 30px auto;
            border-radius: 14px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            padding: 28px 24px 22px 24px;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-close {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            font-size: 1.8em;
            color: #888;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }
        .modal h2 {
            margin-top: 0;
            color: var(--text-main);
            font-size: 1.4em;
            margin-bottom: 20px;
        }
        .modal-body {
            font-size: 0.95em;
            color: var(--text-main);
            line-height: 1.6;
        }
        .modal-body h4 {
            color: var(--accent-dark);
            margin-top: 20px;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        .modal-body hr {
            border: none;
            border-top: 1px solid #e0e0e0;
            margin: 16px 0;
        }
        .modal-body ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        .modal-body li {
            margin-bottom: 4px;
        }
        .modal-table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 0.9em;
        }
        .modal-table th, .modal-table td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            text-align: left;
        }
        .modal-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--text-main);
        }

        @media (max-width: 768px) {
            .container { margin: 0; border-radius: 0; }
            .form-container { padding: 2px 0.5vw 2px 0.5vw; }
            .form-card { 
                padding: 6px 2px 2px 2px; 
                margin-bottom: 2px;
            }
            .form-card h3 {
                font-size: 1em;
                margin-bottom: 6px;
            }
            .input-row-group { 
                flex-direction: column; 
                gap: 0; 
                margin: 0;
            }
            .input-row { 
                flex-direction: column; 
                align-items: stretch; 
                gap: 0; 
                min-width: 0; 
                margin-bottom: 1px;
                padding: 0;
            }
            .input-row label { 
                margin-bottom: 1px; 
                font-size: 0.97em;
            }
            .input-row input, .input-row select { 
                width: 100%; 
                font-size: 0.97em;
                padding: 7px 7px;
            }
            .parameter-status { 
                grid-template-columns: 1fr; 
                gap: 0; 
                margin-top: 2px;
            }
            .parameter-item { 
                padding: 2px 3px; 
                font-size: 0.95em; 
                margin-bottom: 0;
            }
            .results { 
                padding: 3px 1px; 
            }
            .info-box, .fa-warning, .fevi-warning, .tr-warning, .indeterminate-note, .age-reference, .recommendations, .missing-params-warning {
                padding: 7px 6px;
                font-size: 0.97em;
            }
            .referencias {
                padding: 7px 6px;
                font-size: 0.97em;
            }
            .modal-content {
                margin: 10px;
                max-width: none;
                padding: 20px 16px;
                max-height: 90vh;
            }
            .modal-table {
                font-size: 0.8em;
            }
            .modal-table th, .modal-table td {
                padding: 6px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🫀 Calculadora de Función Diastólica</h1>
            <div class="subtitle">ASE 2025 </div>
        </div>
        <div class="form-container">
            <div class="info-box">
                <strong>📋 Instrucciones:</strong> Complete los parámetros ecocardiográficos disponibles. Todos los campos son opcionales. Los valores de velocidad deben estar en <b>cm/s</b> para E, A, e' y en <b>m/s</b> para la velocidad de regurgitación tricuspídea (TR).
                <a id="openAlgInfo" class="alg-link" href="javascript:void(0)">¿Cómo funciona el algoritmo?</a>
            </div>
            <form id="diastolicForm">
                <div class="form-card">
                    <h3>🩺 Contexto clínico</h3>
                    <div class="input-row-group">
                        <div class="input-row">
                            <label>Ritmo:</label>
                            <select id="ritmo" onchange="toggleEASection();updateAgeReferences();">
                                <option value="sinusal">Ritmo sinusal</option>
                                <option value="fa">Fibrilación auricular</option>
                            </select>
                        </div>
                        <div class="input-row">
                            <label>Edad:</label>
                            <select id="edad" onchange="updateAgeReferences()">
                                <option value="1">&lt;50 años</option>
                                <option value="2">50-64 años</option>
                                <option value="3">&ge;65 años</option>
                            </select>
                        </div>
                        <div class="input-row">
                            <label>FEVI:</label>
                            <select id="fevi" onchange="updateAgeReferences()">
                                <option value="mayorigual">≥50%</option>
                                <option value="menor">&lt;50%</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="ageReferences" class="age-reference" style="display:none;">
                    <strong>📊 Valores de referencia para este perfil:</strong>
                    <div id="ageReferenceContent"></div>
                </div>
                <div class="form-card" id="eaSection">
                    <h3>🔄 Flujo mitral (Doppler pulsado)</h3>
                    <div class="input-row-group">
                        <div class="input-row">
                            <label>Onda E:</label>
                            <input type="number" id="velocidadE" step="0.1" min="0" max="300" placeholder="Opcional">
                            <span class="unit">cm/s</span>
                        </div>
                        <div class="input-row">
                            <label>Onda A:</label>
                            <input type="number" id="velocidadA" step="0.1" min="0" max="300" placeholder="Opcional">
                            <span class="unit">cm/s</span>
                        </div>
                    </div>
                </div>
                <div id="faWarning" class="fa-warning" style="display:none;">
                   ⚠️ <strong>Fibrilación auricular:</strong> No se utiliza la relación E/A para el diagnóstico. La onda E sí se usa para calcular E/e' según ASE 2025.
                </div>
                <div class="form-card">
                    <h3>🎯 Doppler tisular</h3>
                    <div class="input-row-group">
                        <div class="input-row">
                            <label>e' lateral:</label>
                            <input type="number" id="eLateral" step="0.1" min="0" max="30" placeholder="Opcional">
                            <span class="unit">cm/s</span>
                        </div>
                        <div class="input-row">
                            <label>e' septal:</label>
                            <input type="number" id="eSeptal" step="0.1" min="0" max="30" placeholder="Opcional">
                            <span class="unit">cm/s</span>
                        </div>
                    </div>
                </div>
                <div class="form-card">
                    <h3>📏 Aurícula izquierda</h3>
                    <div class="input-row-group">
                        <div class="input-row">
                            <label>Tipo de medición:</label>
                            <select id="tipoAI" onchange="toggleAIInput();updateAgeReferences();">
                                <option value="volumen">Volumen indexado</option>
                                <option value="area">Área</option>
                            </select>
                        </div>
                        <div class="input-row" id="volumenRow">
                            <label>Vol AI indexado:</label>
                            <input type="number" id="volumenAI" step="1" min="0" max="200" placeholder="Opcional">
                            <span class="unit">ml/m²</span>
                        </div>
                        <div class="input-row" id="areaRow" style="display:none;">
                            <label>Área auricular izquierda:</label>
                            <input type="number" id="areaAI" step="0.1" min="0" max="50" placeholder="Opcional">
                            <span class="unit">cm²</span>
                        </div>
                    </div>
                    <div class="ai-option-note">
                        <em>Complete uno u otro parámetro. Valores de referencia: Volumen ≤34 ml/m² o Área ≤20 cm²</em>
                    </div>
                </div>
                <div class="form-card">
                    <h3>🌊 Regurgitación tricuspídea</h3>
                    <div class="input-row-group">
                        <div class="input-row">
                            <label>Velocidad pico de regurgitación tricuspídea:</label>
                            <input type="number" id="velocidadRT" step="0.01" min="0" max="6" placeholder="Opcional">
                            <span class="unit">m/s</span>
                        </div>
                    </div>
                </div>
                <div class="form-card">
                    <h3>⭐ Strain auricular izquierdo</h3>
                    <div class="input-row-group">
                        <div class="input-row">
                            <label>LA Strain:</label>
                            <input type="number" id="laStrain" step="1" min="0" max="60" placeholder="Opcional">
                            <span class="unit">%</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="calculate-btn" onclick="calcularFuncionDiastolica()">
                    🧮 Calcular función diastólica
                </button>
            </form>
            <div id="results" class="results">
                <div id="feviWarning" class="fevi-warning" style="display:none;">
                    ⚠️ <strong>FEVI reducida:</strong> En pacientes con FEVI &lt;50%, se asume disfunción diastólica. Lo relevante es estimar la presión de llenado.
                </div>
                <div id="indeterminateNote" class="indeterminate-note" style="display:none;">
                    Resultado indeterminado según algoritmo ASE 2025. Considere eco de ejercicio si hay síntomas o parámetros morfológicos/funcionales anormales.
                </div>
                <h3 id="diagnostico"></h3>
                <div id="pressureStatus" class="pressure-status"></div>
                <div id="parametros-status" class="parameter-status"></div>
                <div id="recomendaciones" class="recommendations"></div>
            </div>
            <div class="referencias">
                <h3>📚 Referencia</h3>
                <div class="referencia-item">
                    <p>
                        <strong>ASE 2025. Left Ventricular Diastolic Function by Echo</strong><br>
                        <a href="https://onlinejase.com/article/S0894-7317(25)00157-9/fulltext" target="_blank" rel="noopener">
                            https://onlinejase.com/article/S0894-7317(25)00157-9/fulltext
                        </a>
                    </p>
                </div>
            </div>
            <div class="twitter-section">
                <a href="https://x.com/atomasyoung" target="_blank" rel="noopener" class="twitter-link">
                    <svg class="twitter-icon" viewBox="0 0 1200 1227" fill="currentColor">
                        <path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"/>
                    </svg>
                    @atomasyoung
                </a>
            </div>
        </div>
    </div>

    <!-- Modal de información del algoritmo -->
    <div id="algModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">×</button>
            <h2>🧠 Algoritmo </h2>
            <div class="modal-body">
                <h4>1. Flujo principal según la nueva guía</h4>
                <p>El algoritmo ASE 2025 comienza evaluando <strong>e', E/e', y TR velocity</strong> como parámetros principales. Si hay discordancia, se evalúan parámetros adicionales.</p>

                <hr>

                <h4>2. Si FEVI < 50% (cualquier ritmo)</h4>
                <p><strong>Diagnóstico:</strong> Se asume disfunción diastólica. El objetivo es estimar la <strong>presión de llenado</strong>.</p>
                <p><strong>Criterio:</strong> ≥2 parámetros alterados → Presión elevada</p>
<div style="background:#eafaf1; border-left:4px solid #27ae60; padding:10px 12px; margin:10px 0; border-radius:7px;">
    <strong>Nota de la calculadora:</strong> Además de estimar presión de llenado, esta herramienta también determina el <b>grado de disfunción diastólica (I, II, III)</b> en FEVI reducida, usando el mismo algoritmo de gradación que para FEVI preservada, para aportar mayor información clínica.
</div>
                <hr>

                <h4>3. Si FEVI ≥ 50% y Ritmo Sinusal</h4>
                <p><strong>Paso 1:</strong> Evaluar e' promedio, E/e', y TR velocity</p>
                <ul>
                    <li>Si los <strong>3 están alterados</strong> → LAP elevado</li>
                    <li>Si los <strong>3 están normales</strong> → LAP normal</li>
                    <li>Si hay <strong>1-2 alterados</strong> → Evaluar parámetros adicionales</li>
                </ul>

                <p><strong>Paso 2:</strong> Parámetros adicionales (si hay duda)</p>
                <ul>
                    <li>LA Strain ≤18% → LAP elevado</li>
                    <li>LAVi >34 ml/m² → LAP elevado</li>
                    <li>Si parámetros adicionales normales → LAP normal</li>
                </ul>

                <p><strong>Gradación (si hay disfunción):</strong></p>
                <ul>
                    <li><strong>Grado I:</strong> E/A < 0.8 y E < 50 cm/s</li>
                    <li><strong>Grado III:</strong> E/A ≥ 2.0</li>
                    <li><strong>Grado II:</strong> Resto de casos</li>
                </ul>

                <hr>

                <h4>4. Si Fibrilación Auricular</h4>
                <p><strong>No se gradúa</strong> la disfunción. Solo se estima presión de llenado.</p>
                <p><strong>Criterio:</strong> ≥2 parámetros alterados → Presión elevada</p>
                <p><em>No se utiliza E/A en FA.</em></p>

                <hr>

                <h4>5. Valores de referencia por edad</h4>
                <table class="modal-table">
                    <thead>
                        <tr>
                            <th>Parámetro</th>
                            <th>&lt;50 años</th>
                            <th>50-64 años</th>
                            <th>≥65 años</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>e' lateral</td>
                            <td>≥10 cm/s</td>
                            <td>≥8.5 cm/s</td>
                            <td>≥7.0 cm/s</td>
                        </tr>
                        <tr>
                            <td>e' septal</td>
                            <td>≥8.0 cm/s</td>
                            <td>≥6.5 cm/s</td>
                            <td>≥5.0 cm/s</td>
                        </tr>
                        <tr>
                            <td>e' promedio</td>
                            <td>≥10 cm/s</td>
                            <td>≥8 cm/s</td>
                            <td>≥6 cm/s</td>
                        </tr>
                        <tr>
                            <td>E/A</td>
                            <td>≥1.0</td>
                            <td>0.8–2.0</td>
                            <td>0.7–2.0</td>
                        </tr>
                    </tbody>
                </table>

                <p><strong>Parámetros independientes de edad:</strong></p>
                <ul>
                    <li><strong>E/e' promedio:</strong> ≤14</li>
                    <li><strong>Velocidad TR:</strong> ≤2.8 m/s</li>
                    <li><strong>LAVi:</strong> ≤34 ml/m²</li>
                    <li><strong>LA Strain:</strong> ≥18% (específico), ≥23% (normal)</li>
                </ul>

                <hr>

                <p style="font-size:0.9em; color:#666; text-align:center; margin-top:20px;">
                    <strong>Basado en las guías ASE 2025</strong><br>
                    <em>Left Ventricular Diastolic Function by Echo</em>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Función para detectar parámetros faltantes
        function getMissingParams(ritmo, fevi, tipoAI, valores) {
            let faltan = [];
            
            // Parámetros siempre relevantes
            if (isNaN(valores.eSeptal)) faltan.push("e' septal");
            if (isNaN(valores.eLateral)) faltan.push("e' lateral");
            
            // Aurícula izquierda
            if (tipoAI === "volumen" && isNaN(valores.volumenAI)) faltan.push("Volumen AI indexado");
            if (tipoAI === "area" && isNaN(valores.areaAI)) faltan.push("Área AI");
            
            // Velocidad TR
            if (isNaN(valores.velocidadRT)) faltan.push("Velocidad TR");
            
            // E/A solo en ritmo sinusal
            if (ritmo === "sinusal") {
                if (isNaN(valores.velocidadE)) faltan.push("Onda E");
                if (isNaN(valores.velocidadA)) faltan.push("Onda A");
            }
            
            // LA Strain es opcional pero se menciona si no está
            if (isNaN(valores.laStrain)) faltan.push("LA Strain");
            
            return faltan;
        }

        // FUNCIÓN CORREGIDA: Mostrar/ocultar sección E/A según ritmo
        function toggleEASection() {
            const ritmo = document.getElementById('ritmo').value;
            const eaSection = document.getElementById('eaSection');
            const faWarning = document.getElementById('faWarning');
            
            // Buscar las filas específicas de Onda E y Onda A
            const velocidadEInput = document.getElementById('velocidadE');
            const velocidadAInput = document.getElementById('velocidadA');
            
            // Encontrar las filas padre (input-row) de cada input
            let velocidadERow = velocidadEInput.closest('.input-row');
            let velocidadARow = velocidadAInput.closest('.input-row');

            if (ritmo === 'fa') {
                eaSection.style.display = 'block';
                faWarning.style.display = 'block';
                
                // En FA: mostrar Onda E, ocultar Onda A
                velocidadERow.style.display = 'flex';
                velocidadARow.style.display = 'none';
                
                // Limpiar solo el valor de Onda A
                velocidadAInput.value = '';
            } else {
                eaSection.style.display = 'block';
                faWarning.style.display = 'none';
                
                // En ritmo sinusal: mostrar ambas
                velocidadERow.style.display = 'flex';
                velocidadARow.style.display = 'flex';
            }
        }

        // Mostrar/ocultar input de área/volumen AI
        function toggleAIInput() {
            const tipoAI = document.getElementById('tipoAI').value;
            const volumenRow = document.getElementById('volumenRow');
            const areaRow = document.getElementById('areaRow');
            if (tipoAI === 'volumen') {
                volumenRow.style.display = 'flex';
                areaRow.style.display = 'none';
                document.getElementById('areaAI').value = '';
            } else {
                volumenRow.style.display = 'none';
                areaRow.style.display = 'flex';
                document.getElementById('volumenAI').value = '';
            }
        }

        // Mostrar valores de referencia según edad, ritmo, FEVI y tipo de AI
        function updateAgeReferences() {
            const edad = document.getElementById('edad').value;
            const ritmo = document.getElementById('ritmo').value;
            const fevi = document.getElementById('fevi').value;
            const tipoAI = document.getElementById('tipoAI').value;
            const ageReferences = document.getElementById('ageReferences');
            const ageReferenceContent = document.getElementById('ageReferenceContent');

            let eRef, eaRef, edadTexto, eSeptalRef, eLateralRef, aiRef;

            if (edad === "1") {
                edadTexto = "&lt;50 años";
                eRef = "e' promedio ≥ 10 cm/s";
                eaRef = 'E/A ≥ 1.0';
                eSeptalRef = "≥8.0";
                eLateralRef = "≥10.0";
            } else if (edad === "2") {
                edadTexto = "50-64 años";
                eRef = "e' promedio ≥ 8 cm/s";
                eaRef = 'E/A: 0.8-2.0';
                eSeptalRef = "≥6.5";
                eLateralRef = "≥8.5";
            } else {
                edadTexto = "&ge;65 años";
                eRef = "e' promedio ≥ 6 cm/s";
                eaRef = 'E/A: 0.7-2.0';
                eSeptalRef = "≥5.0";
                eLateralRef = "≥7.0";
            }

            aiRef = tipoAI === "volumen" ? "Volumen AI indexado ≤34 ml/m²" : "Área AI ≤20 cm²";

            let ritmoRef = "";
            if (ritmo === "fa") {
                ritmoRef = "<br>• En FA no se utiliza E/A";
            }

            let feviRef = "";
            if (fevi === "menor") {
                feviRef = "<br>• FEVI reducida: se asume disfunción diastólica";
            }

            ageReferenceContent.innerHTML = `
                <strong>Edad ${edadTexto}:</strong><br>
                • ${eRef} (lateral ${eLateralRef} cm/s, septal ${eSeptalRef} cm/s)<br>
                • ${eaRef}${ritmoRef}<br>
                • E/e' ≤ 14<br>
                • ${aiRef}<br>
                • Velocidad TR ≤ 2.8 m/s<br>
                • LA Strain ≥ 18% (específico), ≥ 23% (normal)
                ${feviRef}
            `;

            ageReferences.style.display = 'block';
        }

        // Modal functionality
        function openModal() {
            document.getElementById('algModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('algModal').style.display = 'none';
        }

        // Salto automático al siguiente input
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('input,select').forEach((el, idx, arr) => {
                el.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        let next = arr[idx + 1];
                        while (next && next.offsetParent === null) next = arr[++idx + 1];
                        if (next) next.focus();
                    }
                });
            });

            // Configurar el botón del modal
            document.getElementById('openAlgInfo').addEventListener('click', openModal);

            // Cerrar modal al hacer clic fuera
            document.getElementById('algModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            updateAgeReferences();
        });

        // Función principal de cálculo - ALGORITMO ASE 2025
      function calcularFuncionDiastolica() {
    const ritmo = document.getElementById('ritmo').value;
    const edad = document.getElementById('edad').value;
    const fevi = document.getElementById('fevi').value;
    const tipoAI = document.getElementById('tipoAI').value;

    // Solo una vez estas variables
    const feviWarning = document.getElementById('feviWarning');
    const indeterminateNote = document.getElementById('indeterminateNote');
    feviWarning.style.display = "none";
    indeterminateNote.style.display = "none";

    const valores = {
        eSeptal: parseFloat(document.getElementById('eSeptal').value),
        eLateral: parseFloat(document.getElementById('eLateral').value),
        volumenAI: parseFloat(document.getElementById('volumenAI').value),
        areaAI: parseFloat(document.getElementById('areaAI').value),
        velocidadRT: parseFloat(document.getElementById('velocidadRT').value),
        laStrain: parseFloat(document.getElementById('laStrain').value),
        velocidadE: parseFloat(document.getElementById('velocidadE').value),
        velocidadA: parseFloat(document.getElementById('velocidadA').value)
    };

    const faltan = getMissingParams(ritmo, fevi, tipoAI, valores);

    let ea = null, ee = null;
    if (ritmo === "sinusal" && !isNaN(valores.velocidadE) && !isNaN(valores.velocidadA) && valores.velocidadA > 0) {
        ea = valores.velocidadE / valores.velocidadA;
    }

    let eProm = null;
    if (!isNaN(valores.eSeptal) && !isNaN(valores.eLateral)) {
        eProm = (valores.eSeptal + valores.eLateral) / 2;
        if (!isNaN(valores.velocidadE) && eProm > 0) {
            ee = valores.velocidadE / eProm;
        }
    }

    let eSeptalRef, eLateralRef, ePromRef, eaMin, eaMax;
    if (edad === "1") {
        eSeptalRef = 8.0; eLateralRef = 10.0; ePromRef = 10;
        eaMin = 1.0; eaMax = 99;
    } else if (edad === "2") {
        eSeptalRef = 6.5; eLateralRef = 8.5; ePromRef = 8;
        eaMin = 0.8; eaMax = 2.0;
    } else {
        eSeptalRef = 5.0; eLateralRef = 7.0; ePromRef = 6;
        eaMin = 0.7; eaMax = 2.0;
    }

    let parametros = [];

    let eLateralNormal = null;
    if (!isNaN(valores.eLateral)) {
        eLateralNormal = valores.eLateral >= eLateralRef;
        parametros.push({
            nombre: "e' lateral",
            valor: valores.eLateral.toFixed(1) + " cm/s",
            estado: eLateralNormal ? "normal" : "abnormal",
            referencia: "≥" + eLateralRef + " cm/s"
        });
    }

    let eSeptalNormal = null;
    if (!isNaN(valores.eSeptal)) {
        eSeptalNormal = valores.eSeptal >= eSeptalRef;
        parametros.push({
            nombre: "e' septal",
            valor: valores.eSeptal.toFixed(1) + " cm/s",
            estado: eSeptalNormal ? "normal" : "abnormal",
            referencia: "≥" + eSeptalRef + " cm/s"
        });
    }

    let ePromNormal = null;
    if (eProm !== null) {
        ePromNormal = eProm >= ePromRef;
        parametros.push({
            nombre: "e' promedio",
            valor: eProm.toFixed(1) + " cm/s",
            estado: ePromNormal ? "normal" : "abnormal",
            referencia: "≥" + ePromRef + " cm/s"
        });
    }

    let eaNormal = null;
    if (ritmo === "sinusal" && ea !== null) {
        if (edad === "1") {
            eaNormal = ea >= eaMin;
        } else {
            eaNormal = ea >= eaMin && ea <= eaMax;
        }
        parametros.push({
            nombre: "Relación E/A",
            valor: ea.toFixed(2),
            estado: eaNormal ? "normal" : "abnormal",
            referencia: (edad === "1" ? "≥" + eaMin : eaMin + "–" + eaMax)
        });
    }

    let eeNormal = null;
    if (ee !== null) {
        eeNormal = ee <= 14;
        parametros.push({
            nombre: "E/e' promedio",
            valor: ee.toFixed(1),
            estado: eeNormal ? "normal" : "abnormal",
            referencia: "≤14"
        });
    }

    let aiNormal = null;
    if (tipoAI === "volumen" && !isNaN(valores.volumenAI)) {
        aiNormal = valores.volumenAI <= 34;
        parametros.push({
            nombre: "Volumen AI indexado",
            valor: valores.volumenAI + " ml/m²",
            estado: aiNormal ? "normal" : "abnormal",
            referencia: "≤34 ml/m²"
        });
    } else if (tipoAI === "area" && !isNaN(valores.areaAI)) {
        aiNormal = valores.areaAI <= 20;
        parametros.push({
            nombre: "Área AI",
            valor: valores.areaAI + " cm²",
            estado: aiNormal ? "normal" : "abnormal",
            referencia: "≤20 cm²"
        });
    }

    let trNormal = null;
    if (!isNaN(valores.velocidadRT)) {
        trNormal = valores.velocidadRT < 2.8;
        parametros.push({
            nombre: "Velocidad TR",
            valor: valores.velocidadRT.toFixed(2) + " m/s",
            estado: trNormal ? "normal" : "abnormal",
            referencia: "<2.8 m/s"
        });
    }

    let laStrainNormal = null;
    if (!isNaN(valores.laStrain)) {
        laStrainNormal = valores.laStrain >= 18;
        parametros.push({
            nombre: "LA Strain",
            valor: valores.laStrain.toFixed(1) + " %",
            estado: laStrainNormal ? "normal" : "abnormal",
            referencia: "≥18% (específico), ≥23% (normal)"
        });
    }

    let diagnostico = "";
    let pressureStatus = "";
    let recomendaciones = "";

    if (ritmo === "fa") {
        let alterados = 0, normales = 0;
        if (ePromNormal !== null) { alterados += ePromNormal ? 0 : 1; normales += ePromNormal ? 1 : 0; }
        if (aiNormal !== null) { alterados += aiNormal ? 0 : 1; normales += aiNormal ? 1 : 0; }
        if (trNormal !== null) { alterados += trNormal ? 0 : 1; normales += trNormal ? 1 : 0; }
        if (eeNormal !== null) { alterados += eeNormal ? 0 : 1; normales += eeNormal ? 1 : 0; }
        if (laStrainNormal !== null) { alterados += laStrainNormal ? 0 : 1; normales += laStrainNormal ? 1 : 0; }

        if (alterados >= 2) {
            diagnostico = "Disfunción diastólica";
            pressureStatus = "Presión de llenado elevada";
        } else if (normales >= 2) {
            diagnostico = "Función diastólica normal";
            pressureStatus = "Presión de llenado normal";
        } else {
            diagnostico = "Indeterminado";
            pressureStatus = "";
            indeterminateNote.style.display = "block";
        }
        recomendaciones = "En FA no se gradúa la disfunción diastólica. Se estima presión de llenado.";
    } else {
        let principalesAlterados = 0, principalesNormales = 0, principalesTotal = 0;
        if (ePromNormal !== null) { 
            principalesTotal++; 
            principalesAlterados += ePromNormal ? 0 : 1; 
            principalesNormales += ePromNormal ? 1 : 0; 
        }
        if (eeNormal !== null) { 
            principalesTotal++; 
            principalesAlterados += eeNormal ? 0 : 1; 
            principalesNormales += eeNormal ? 1 : 0; 
        }
        if (trNormal !== null) { 
            principalesTotal++; 
            principalesAlterados += trNormal ? 0 : 1; 
            principalesNormales += trNormal ? 1 : 0; 
        }

        if (principalesTotal === 3 && principalesAlterados === 3) {
            diagnostico = "Disfunción diastólica";
            pressureStatus = "Presión de llenado elevada";
            recomendaciones = "Los 3 parámetros principales (e', E/e', TR) están alterados según ASE 2025.";
        } else if (principalesTotal === 3 && principalesNormales === 3) {
            diagnostico = "Función diastólica normal";
            pressureStatus = "Presión de llenado normal";
            recomendaciones = "Los 3 parámetros principales (e', E/e', TR) están normales según ASE 2025.";
        } else if (principalesTotal >= 2 && (principalesAlterados >= 1 && principalesAlterados < principalesTotal)) {
            let adicionalesAlterados = false;
            let adicionalesNormales = false;
            if (laStrainNormal === false) adicionalesAlterados = true;
            if (aiNormal === false) adicionalesAlterados = true;
            if (laStrainNormal === true) adicionalesNormales = true;
            if (aiNormal === true) adicionalesNormales = true;

            if (adicionalesAlterados) {
                diagnostico = "Disfunción diastólica";
                pressureStatus = "Presión de llenado elevada";
                recomendaciones = "Presión de llenado elevada por parámetros adicionales (LA Strain ≤18% o LAVi >34 ml/m²).";
            } else if (adicionalesNormales) {
                diagnostico = "Función diastólica normal";
                pressureStatus = "Presión de llenado normal";
                recomendaciones = "Presión de llenado normal por parámetros adicionales.";
            } else {
                diagnostico = "Indeterminado";
                indeterminateNote.style.display = "block";
                recomendaciones = "Considere eco de ejercicio si hay síntomas o parámetros morfológicos/funcionales anormales.";
            }
        } else {
            diagnostico = "Indeterminado";
            indeterminateNote.style.display = "block";
            recomendaciones = "No hay suficientes parámetros principales (e', E/e', TR) para diagnóstico según ASE 2025.";
        }

        // Grado de disfunción SIEMPRE, incluso FEVI <50%
        if ((diagnostico === "Disfunción diastólica" || fevi === "menor") && ea !== null && !isNaN(valores.velocidadE)) {
            if (ea < 0.8 && valores.velocidadE < 50) {
                diagnostico += " - Grado I (alteración de relajación)";
            } else if (ea >= 2.0) {
                diagnostico += " - Grado III (restrictivo)";
            } else {
                diagnostico += " - Grado II (pseudonormal)";
            }
        }
    }

    // Advertencia FEVI reducida
    if (fevi === "menor") {
        feviWarning.style.display = "block";
    } else {
        feviWarning.style.display = "none";
    }

    let advertenciaFaltantes = "";
    if (faltan.length > 0) {
        advertenciaFaltantes = `<div class="missing-params-warning">
            <strong>⚠️ Parámetros no ingresados:</strong> ${faltan.join(", ")}.<br>
            El diagnóstico puede ser menos preciso según las guías ASE 2025.
        </div>`;
    }

    // ADVERTENCIA ESPECÍFICA PARA ONDA E FALTANTE
    if (isNaN(valores.velocidadE)) {
        advertenciaFaltantes += "<br>⚠️ No se ingresó la onda E, por lo que no se puede calcular E/e'. El diagnóstico se basa en los parámetros disponibles, pero podría ser más preciso si se completa este dato.";
    }

    const results = document.getElementById('results');
    results.className = "results";
    if (diagnostico.includes("normal")) results.classList.add("normal");
    else if (diagnostico.includes("Disfunción") || diagnostico.includes("elevada")) results.classList.add("abnormal");
    else results.classList.add("indeterminate");

    document.getElementById('diagnostico').innerHTML = diagnostico;

    const pressureDiv = document.getElementById('pressureStatus');
    pressureDiv.innerHTML = pressureStatus;
    pressureDiv.className = "pressure-status";
    if (pressureStatus.includes("elevada")) pressureDiv.classList.add("elevated");
    else if (pressureStatus.includes("normal")) pressureDiv.classList.add("normal");

    let htmlParametros = "";
    parametros.forEach(p => {
        htmlParametros += `<div class="parameter-item ${p.estado}"><strong>${p.nombre}:</strong> ${p.valor} <span style="color:#888;font-size:0.95em;">(${p.referencia})</span></div>`;
    });
    document.getElementById('parametros-status').innerHTML = htmlParametros;

    document.getElementById('recomendaciones').innerHTML = advertenciaFaltantes + recomendaciones;

    results.style.display = "block";
    results.scrollIntoView({behavior: "smooth"});
}

        // Función para evaluar presión de llenado (para FEVI <50%)
        function evaluarPresionLlenado(ePromNormal, aiNormal, trNormal, eeNormal, laStrainNormal) {
            let alterados = 0, normales = 0;
            if (ePromNormal !== null) { alterados += ePromNormal ? 0 : 1; normales += ePromNormal ? 1 : 0; }
            if (aiNormal !== null) { alterados += aiNormal ? 0 : 1; normales += aiNormal ? 1 : 0; }
            if (trNormal !== null) { alterados += trNormal ? 0 : 1; normales += trNormal ? 1 : 0; }
            if (eeNormal !== null) { alterados += eeNormal ? 0 : 1; normales += eeNormal ? 1 : 0; }
            if (laStrainNormal !== null) { alterados += laStrainNormal ? 0 : 1; normales += laStrainNormal ? 1 : 0; }

            if (alterados >= 2) return "Presión de llenado elevada";
            if (normales >= 2) return "Presión de llenado normal";
            return "Indeterminado";
        }
    </script>
</body>
</html>
