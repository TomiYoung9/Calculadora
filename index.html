<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora de Funci√≥n Diast√≥lica</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --main-bg:#b7d0e8;--header-bg:#3a5a7a;--card-bg:#fff;--accent:#27ae60;--accent-dark:#219150;--accent-light:#e9f7ef;
      --text-main:#1a2a36;--text-soft:#5a6e7f;--border:#e3eaf2;--shadow:0 4px 24px rgba(74,144,226,0.08);
      --red:#e74c3c;--green:#27ae60;--yellow:#f7b731;--blue:#3498db;
    }
    body{font-family:'Inter',Arial,sans-serif;background:var(--main-bg);min-height:100vh;margin:0}
    .container{max-width:900px;margin:40px auto 0;background:var(--card-bg);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .header{background:var(--header-bg);color:#fff;padding:36px 20px 24px;text-align:center}
    .header h1{font-size:2.1em;font-weight:700;margin:0 0 8px;letter-spacing:.5px;display:flex;align-items:center;justify-content:center;gap:14px;color:#fff}
    .subtitle{font-size:1.08em;font-weight:500;margin-top:6px;letter-spacing:.2px}
    .form-container{padding:36px 22px 28px}
    .info-box{background:var(--accent-light);color:var(--text-main);padding:15px 20px;border-radius:10px;margin-bottom:24px;font-size:1.05em;box-shadow:0 2px 8px #4a90e211}
    .alg-link{display:block;text-align:right;margin-top:6px;color:#3a5a7a;font-size:.97em;text-decoration:underline dotted;cursor:pointer}
    .alg-link:hover{color:var(--accent)}
    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 2px 8px #4a90e211;border:1.5px solid var(--border);margin-bottom:20px;padding:22px 18px 12px}
    .form-card h3{color:var(--text-main);font-size:1.13em;font-weight:600;margin-bottom:14px;letter-spacing:.3px}
    .input-row-group{display:flex;gap:18px;flex-wrap:wrap}
    .input-row{display:flex;align-items:center;margin-bottom:10px;gap:10px;flex:1 1 220px;min-width:220px}
    .input-row--full{flex:1 1 100%;min-width:100%}
    .input-row label{font-weight:500;color:var(--text-main);font-size:1em;flex:1 1 120px}
    .input-row input,.input-row select{flex:0 0 90px;padding:9px 10px;border:1.5px solid var(--border);border-radius:6px;font-size:1em;background:#f7fbfd;color:var(--text-main)}
    .input-row input:focus,.input-row select:focus{outline:none;border-color:var(--accent)}
    .unit{margin-left:7px;color:var(--text-soft);font-weight:500;font-size:.97em}
    .ai-option-note{font-size:.92em;color:#5a6e7f;margin-top:7px;font-style:italic}
    .calculate-btn{width:100%;padding:13px;background:var(--green);color:#fff;border:none;border-radius:9px;font-size:1.13em;font-weight:700;cursor:pointer;margin-top:14px;box-shadow:0 2px 8px #4a90e211}
    .calculate-btn:hover{background:var(--accent-dark)}
    .results{margin-top:26px;padding:22px 18px;border-radius:10px;display:none}
    .results.normal{background:#eafaf1;color:var(--green);border:2px solid var(--green)}
    .results.abnormal{background:#fdeaea;color:var(--red);border:2px solid var(--red)}
    .results.indeterminate{background:#fffbe6;color:var(--yellow);border:2px solid var(--yellow)}
    .results h3{font-size:1.2em;margin-bottom:10px}
    .parameter-status{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:6px;margin-top:12px}
    .parameter-item{background:rgba(255,255,255,0.13);padding:7px 10px;border-radius:7px;border-left:4px solid #fff;font-size:1em}
    .parameter-item.abnormal{border-left-color:var(--red);background:#fdeaea}
    .parameter-item.normal{border-left-color:var(--green);background:#eafaf1}
    .parameter-item.indeterminate{border-left-color:var(--yellow);background:#fffbe6}
    .recommendations{margin-top:12px;padding:12px 10px;background:rgba(255,255,255,0.13);border-radius:7px}
    .fa-warning{background:#fff3cd;border:1px solid #ffeaa7;padding:10px 12px;border-radius:7px;margin-bottom:12px;color:#856404}
    .fevi-warning{background:#fff8e1;border:1px solid #ffecb3;padding:10px 12px;border-radius:7px;margin-bottom:12px;color:#6d4c41}
    .indeterminate-note{background:#fffbe6;border:1.5px solid var(--yellow);color:#b38600;padding:10px 12px;border-radius:7px;margin-bottom:12px}
    .age-reference{background:#e8f4fd;padding:10px 12px;border-radius:7px;margin-bottom:12px;border-left:4px solid var(--accent)}
    .missing-params-warning{background:#fffbe6;border:1.5px solid var(--yellow);color:#b38600;padding:10px 12px;border-radius:7px;margin-bottom:12px}
    .referencias{margin-top:28px;padding:16px 12px;background:#f8f9fa;border-radius:9px;border-left:5px solid var(--accent-light)}
    .referencias h3{color:var(--text-main);margin-bottom:12px;font-size:1.08em}
    .referencia-item{margin-bottom:10px;padding:10px;background:#fff;border-radius:7px;box-shadow:0 2px 5px #4a90e20a}
    .referencia-item a{color:#111;text-decoration:none;font-weight:500}
    .referencia-item a:hover{color:var(--accent);text-decoration:underline}
    .twitter-section{text-align:center;padding:10px;margin-bottom:6px}
    .twitter-link,.linkedin-link{display:inline-flex;align-items:center;gap:8px;color:#111;text-decoration:none;font-weight:600;font-size:1.1em}
    .twitter-link:hover,.linkedin-link:hover{color:var(--accent)}
    .twitter-link:visited,.linkedin-link:visited{color:#111}
    .pressure-status{font-size:1.08em;font-weight:bold;margin-top:8px;padding:7px;border-radius:7px;text-align:center}
    .pressure-status.normal{background:#eafaf1;color:var(--green)}
    .pressure-status.elevated{background:#fdeaea;color:var(--red)}
    /* Modal */
    .modal{display:none;position:fixed;z-index:1000;inset:0;overflow:auto;background:rgba(0,0,0,0.5);backdrop-filter:blur(3px)}
    .modal-content{background:#fff;margin:5% auto;padding:20px 30px;border-radius:12px;max-width:600px;box-shadow:0 4px 24px rgba(0,0,0,.2);position:relative}
    .modal-close{position:absolute;top:12px;right:16px;background:transparent;border:none;font-size:28px;font-weight:bold;cursor:pointer;color:#333;line-height:1}
    .modal-body{max-height:60vh;overflow-y:auto;font-size:.95em;line-height:1.4}
    .modal-table{width:100%;border-collapse:collapse;margin-top:10px}
    .modal-table th,.modal-table td{border:1px solid #ccc;padding:6px 10px;text-align:center}
    .modal-table th{background:#f0f4f8;font-weight:600}
    /* M√≥vil */
    @media (max-width:480px){
      body{font-size:14px;line-height:1.3}
      .container{width:95vw;max-width:400px;margin:8px auto;border-radius:10px;box-shadow:none}
      .form-container{padding:12px 10px}
      .form-card{padding:14px 12px 8px;margin-bottom:8px;border:1px solid var(--border);box-shadow:none}
      .form-card h3{font-size:1.1em;margin-bottom:8px;line-height:1.3}
      .input-row-group{display:block}
      .input-row{flex-direction:column;align-items:flex-start;margin-bottom:12px;gap:4px;width:100%;min-width:0 !important}
      .input-row--full{flex:none;min-width:0}
      .input-row input,.input-row select{width:100%;height:36px}
      .unit{margin-left:0;margin-top:4px;font-size:.85em;display:inline-block}
      .results{padding:12px 10px;font-size:1em;margin-top:14px;line-height:1.3}
      .parameter-status{grid-template-columns:1fr;gap:6px;margin-top:8px}
      .parameter-item{font-size:.9em;padding:5px 8px;margin-bottom:4px;line-height:1.2}
      .info-box,.referencias,.fa-warning,.fevi-warning,.indeterminate-note,.age-reference,.recommendations,.missing-params-warning{font-size:.9em;padding:8px 10px;margin-bottom:8px;line-height:1.2}
      .modal-content{margin:10px 5px;max-width:95vw;padding:18px 14px;max-height:90vh}
      .modal-table{font-size:.85em}
      input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü´Ä Calculadora de Funci√≥n Diast√≥lica</h1>
      <div class="subtitle">ASE 2025</div>
    </div>

    <div class="form-container">
      <div class="info-box">
        <strong>üìã Instrucciones:</strong> Complete los par√°metros ecocardiogr√°ficos disponibles. Todos los campos son opcionales. Las velocidades de E, A y e‚Ä≤ en <b>cm/s</b>; TR en <b>m/s</b> (o <b>PSAP</b> en mmHg si lo ingresa manualmente).
        <a id="openAlgInfo" class="alg-link" href="javascript:void(0)">¬øC√≥mo funciona el algoritmo?</a>
      </div>

      <form id="diastolicForm">
        <div class="form-card">
          <h3>ü©∫ Contexto cl√≠nico</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Ritmo:</label>
              <select id="ritmo" onchange="toggleEASection();updateAgeReferences();">
                <option value="sinusal">Ritmo sinusal</option>
                <option value="fa">Fibrilaci√≥n auricular</option>
              </select>
            </div>
            <div class="input-row">
              <label>FEVI:</label>
              <select id="fevi" onchange="updateAgeReferences()">
                <option value="mayorigual">‚â•50%</option>
                <option value="menor">&lt;50%</option>
              </select>
            </div>
            <div class="input-row">
              <label>Edad:</label>
              <select id="edad" onchange="updateAgeReferences()">
                <option value="1">20‚Äì39 a√±os</option>
                <option value="2">40‚Äì65 a√±os</option>
                <option value="3">&gt;65 a√±os</option>
              </select>
            </div>
          </div>
        </div>

        <div id="ageReferences" class="age-reference" style="display:none;">
          <strong>üìä Valores de referencia para este perfil:</strong>
          <div id="ageReferenceContent"></div>
        </div>

        <div class="form-card" id="eaSection">
          <h3>üîÑ Flujo mitral (Doppler pulsado)</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Onda E:</label>
              <input type="number" id="velocidadE" step="0.1" min="0" max="300" placeholder="Opcional" />
              <span class="unit">cm/s</span>
            </div>
            <div class="input-row">
              <label>Onda A:</label>
              <input type="number" id="velocidadA" step="0.1" min="0" max="300" placeholder="Opcional" />
              <span class="unit">cm/s</span>
            </div>
          </div>
        </div>

        <div id="faWarning" class="fa-warning" style="display:none;">
          ‚ö†Ô∏è <strong>Fibrilaci√≥n auricular:</strong> No se utiliza la relaci√≥n E/A para el diagn√≥stico. La onda E s√≠ se usa para calcular E/e‚Ä≤.
        </div>

        <div class="form-card">
          <h3>üéØ Doppler tisular</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>e‚Ä≤ lateral:</label>
              <input type="number" id="eLateral" step="0.1" min="0" max="30" placeholder="Opcional" />
              <span class="unit">cm/s</span>
            </div>
            <div class="input-row">
              <label>e‚Ä≤ septal:</label>
              <input type="number" id="eSeptal" step="0.1" min="0" max="30" placeholder="Opcional" />
              <span class="unit">cm/s</span>
            </div>
          </div>
        </div>

        <div class="form-card">
          <h3>üìè Aur√≠cula izquierda</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Tipo de medici√≥n:</label>
              <select id="tipoAI" onchange="toggleAIInput();updateAgeReferences();">
                <option value="volumen">Volumen indexado</option>
                <option value="area">√Årea</option>
              </select>
            </div>
            <div class="input-row" id="volumenRow">
              <label>Vol AI indexado:</label>
              <input type="number" id="volumenAI" step="1" min="0" max="200" placeholder="Opcional" />
              <span class="unit">ml/m¬≤</span>
            </div>
            <div class="input-row" id="areaRow" style="display:none;">
              <label>√Årea auricular izquierda:</label>
              <input type="number" id="areaAI" step="0.1" min="0" max="50" placeholder="Opcional" />
              <span class="unit">cm¬≤</span>
            </div>
          </div>
          <div class="ai-option-note">
            <em>Complete uno u otro par√°metro. Referencias: LAVi ‚â§34 ml/m¬≤ o √Årea AI ‚â§20 cm¬≤ (proxy).</em>
          </div>
        </div>

        <div class="form-card">
          <h3>üåä TR / PSAP</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Par√°metro:</label>
              <select id="parametroPresion" onchange="syncPresionUI()">
                <option value="TR" selected>Velocidad pico TR</option>
                <option value="PSAP">PSAP</option>
              </select>
            </div>
            <div class="input-row">
              <label id="labelPresion">Velocidad pico TR:</label>
              <input type="number" id="valorPresion" step="0.01" min="0" max="6" placeholder="Opcional" />
              <span class="unit" id="unidadPresion">m/s</span>
            </div>
          </div>
          <div class="ai-option-note" id="trNote">
            Corte: <strong>TR ‚â§2.8 m/s</strong> o <strong>PSAP &lt;35 mmHg</strong>.
          </div>
        </div>

        <div class="form-card">
          <h3>‚≠ê Strain auricular izquierdo</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>LA Strain (LARS):</label>
              <input type="number" id="laStrain" step="1" min="0" max="60" placeholder="Opcional" />
              <span class="unit">%</span>
            </div>
          </div>
        </div>

        <!-- Calculadora avanzada -->
        <div class="form-card">
          <h3>üß© Calculadora avanzada</h3>
          <div class="input-row-group">
            <div class="input-row input-row--full">
              <label>Escenario especial:</label>
              <select id="escenarioEspecial" onchange="renderEscenarioInfo()">
                <option value="normal" selected>‚Äî Caso general ‚Äî</option>
                <option value="AF">Fibrilaci√≥n auricular</option>
                <option value="MAC">MAC moderada/severa</option>
                <option value="MR">Insuficiencia mitral significativa</option>
                <option value="MS">Estenosis mitral significativa</option>
                <option value="PHnoCard">Hipertensi√≥n pulmonar no cardiaca</option>
                <option value="LVAD">LVAD</option>
                <option value="HTX">Trasplante card√≠aco</option>
                <option value="Constriccion">Pericarditis constrictiva</option>
                <option value="HCM">Miocardiopat√≠a hipertr√≥fica</option>
                <option value="BCRI_CRT">BCRI / CRT / marcapaseo</option>
              </select>
            </div>
            <div class="input-row">
              <label>IVRT:</label>
              <input type="number" id="ivrt" step="1" min="20" max="200" placeholder="Opcional" />
              <span class="unit">ms</span>
            </div>
            <div class="input-row">
              <label>Relaci√≥n S/D:</label>
              <input type="number" id="sd" step="0.01" min="0" max="3" placeholder="Opcional" />
              <span class="unit">‚Äî</span>
            </div>
          </div>
          <div class="ai-option-note" id="escenarioInfo" style="margin-top:8px;"></div>
        </div>

        <button type="button" class="calculate-btn" onclick="calcularFuncionDiastolica()">
          üßÆ Calcular funci√≥n diast√≥lica
        </button>
      </form>

      <div id="results" class="results" aria-live="polite">
        <div id="feviWarning" class="fevi-warning" style="display:none;">
          ‚ö†Ô∏è <strong>FEVI reducida:</strong> En FEVI &lt;50% se asume disfunci√≥n diast√≥lica. Lo relevante es estimar LAP.
        </div>
        <div id="indeterminateNote" class="indeterminate-note" style="display:none;">
          Resultado discordante/indeterminado. Considere LARS, LAVi, S/D, IVRT o eco de ejercicio si hay s√≠ntomas.
        </div>
        <h3 id="diagnostico" tabindex="-1"></h3>
        <div id="pressureStatus" class="pressure-status"></div>
        <div id="parametros-status" class="parameter-status"></div>
        <div id="recomendaciones" class="recommendations"></div>
      </div>

      <div class="referencias">
        <h3>üìö Referencia</h3>
        <div class="referencia-item">
          <p>
            <strong>ASE 2025. Left Ventricular Diastolic Function by Echo</strong><br />
            DOI: <a href="https://doi.org/10.1016/j.echo.2025.03.011" target="_blank" rel="noopener">10.1016/j.echo.2025.03.011</a><br />
            <a href="https://www.asecho.org/guideline/left-ventricular-diastolic-function-by-echo/" target="_blank" rel="noopener">Resumen oficial ASE</a>
          </p>
        </div>
      </div>

      <div class="twitter-section" style="display:flex;justify-content:center;gap:20px;padding:10px;margin-bottom:6px;">
        <a href="https://x.com/atomasyoung" target="_blank" rel="noopener" class="twitter-link">
          <svg class="twitter-icon" viewBox="0 0 1200 1227" fill="currentColor" width="24" height="24" aria-hidden="true"><path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"/></svg>
          @atomasyoung
        </a>
        <a href="https://www.linkedin.com/in/tomas-young" target="_blank" rel="noopener" class="linkedin-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor" width="24" height="24" aria-hidden="true"><path d="M100.28 448H7.4V148.9h92.88zm-46.44-340.7a53.66 53.66 0 1 1 53.66-53.66 53.66 53.66 0 0 1-53.66 53.66zM447.9 448h-92.68V302.4c0-34.7-12.4-58.4-43.4-58.4-23.7 0-37.8 15.9-44 31.3-2.3 5.6-2.9 13.4-2.9 21.3V448h-92.68s1.2-270.1 0-297.1h92.68v42.1c12.3-19 34.3-46 83.4-46 60.9 0 106.7 39.8 106.7 125.4z"/></svg>
          Tomas Young
        </a>
      </div>

      <div style="text-align:center;color:#6b7280;font-size:12px;margin:6px 0 12px;">
        v1.0.1 ¬∑ actualizada 11/08/2025
      </div>
    </div>
  </div>

  <!-- Modal: ¬øC√≥mo funciona? -->
  <div id="algModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">√ó</button>
      <h2>üß† Algoritmo</h2>
      <div class="modal-body">
        <h4>1) Flujo principal (RS)</h4>
        <p>Comienza con <strong>e‚Ä≤</strong> (ajustado por edad), <strong>E/e‚Ä≤</strong> y <strong>TR</strong> (<em>o PSAP si lo ingresa</em>). Si hay discordancia, pase a par√°metros adicionales.</p>

        <h4>2) Si FEVI &lt;50%</h4>
        <p>Se asume disfunci√≥n diast√≥lica. El objetivo es estimar <strong>LAP</strong>. ‚â•2 de 3 ‚Äúprincipales‚Äù alterados ‚Üí LAP elevada.</p>

        <h4>3) RS (detalle)</h4>
        <ul>
          <li>3/3 alterados ‚Üí LAP elevada ‚Üí gradar por E/A (‚â•2 ‚Üí G3; &lt;2 ‚Üí G2).</li>
          <li>3/3 normales ‚Üí LAP normal ‚Üí funci√≥n diast√≥lica normal.</li>
          <li>Discordantes ‚Üí use <em>adicionales</em>: <strong>LARS ‚â§18%</strong>, <strong>LAVi &gt;34</strong> (o √Årea AI &gt;20), <strong>S/D &lt;1</strong>, <strong>IVRT ‚â§70 ms</strong>.
            Si <em>no</em> alcanzan umbral de LAP elevada ‚Üí <strong>LAP probablemente normal (discordante)</strong>; puede no asignarse grado.</li>
        </ul>
        <p><strong>Grado I (RS):</strong> e‚Ä≤ reducido + E/e‚Ä≤ normal + PASP/TR normal + E/A ‚â§0.8.</p>

        <h4>4) FA</h4>
        <p>Algoritmo espec√≠fico (sin gradaci√≥n): ‚Äúprincipales‚Äù ‚Üí E ‚â•100, E/e‚Ä≤ septal &gt;11, TR ‚â•2.8 o PSAP ‚â•35, DT ‚â§160; soporte ‚Üí LARS &lt;18%, S/D &lt;1, IMC &gt;30.</p>

        <h4>5) e‚Ä≤ por edad</h4>
        <table class="modal-table">
          <thead><tr><th>Edad</th><th>e‚Ä≤ septal</th><th>e‚Ä≤ lateral</th><th>e‚Ä≤ promedio</th></tr></thead>
          <tbody>
            <tr><td>20‚Äì39</td><td>‚â•7</td><td>‚â•10</td><td>‚â•9</td></tr>
            <tr><td>40‚Äì65</td><td>‚â•6</td><td>‚â•8</td><td>‚â•7</td></tr>
            <tr><td>&gt;65</td><td>‚â•6</td><td>‚â•7</td><td>‚â•6.5</td></tr>
          </tbody>
        </table>

        <p><strong>Independientes de edad:</strong> E/e‚Ä≤ ‚â§14; TR ‚â§2.8 m/s (<em>o PSAP &lt;35 mmHg</em>); LAVi ‚â§34 ml/m¬≤ (√Årea AI ‚â§20 cm¬≤ como aproximaci√≥n); LARS ‚â•18% (espec√≠fico, ‚â•23% normal).</p>

        <p style="font-size:.9em;color:#666;text-align:center;margin-top:16px;">
          <strong>Basado en ASE 2025</strong>
        </p>
      </div>
    </div>
  </div>

  <script>
    // ---- helpers ----
    const $ = (id)=>document.getElementById(id);
    const num = (id)=>{ const el=$(id); if(!el) return NaN; const v=(el.value||"").replace(",","."); return parseFloat(v); };

    function getMissingParams(ritmo, tipoAI, valores){
      const faltan=[];
      if(isNaN(valores.eSeptal)) faltan.push("e‚Ä≤ septal");
      if(isNaN(valores.eLateral)) faltan.push("e‚Ä≤ lateral");
      if(tipoAI==="volumen" && isNaN(valores.volumenAI)) faltan.push("LAVi");
      if(tipoAI==="area" && isNaN(valores.areaAI)) faltan.push("√Årea AI");
      if(valores.parametroPresion==="TR" && isNaN(valores.valorPresion)) faltan.push("Velocidad TR");
      if(valores.parametroPresion==="PSAP" && isNaN(valores.valorPresion)) faltan.push("PSAP");
      if(ritmo==="sinusal"){
        if(isNaN(valores.velocidadE)) faltan.push("Onda E");
        if(isNaN(valores.velocidadA)) faltan.push("Onda A");
      }
      if(isNaN(valores.laStrain)) faltan.push("LARS");
      return faltan;
    }

    function toggleEASection(){
      const ritmo = $('ritmo').value;
      const velocidadERow = $('velocidadE').closest('.input-row');
      const velocidadARow = $('velocidadA').closest('.input-row');
      if(ritmo==='fa'){
        $('faWarning').style.display='block';
        velocidadERow.style.display='flex';
        velocidadARow.style.display='none';
        $('velocidadA').value='';
      }else{
        $('faWarning').style.display='none';
        velocidadERow.style.display='flex';
        velocidadARow.style.display='flex';
      }
    }
    function toggleAIInput(){
      const t = $('tipoAI').value;
      $('volumenRow').style.display = (t==='volumen')?'flex':'none';
      $('areaRow').style.display = (t==='area')?'flex':'none';
      if(t==='volumen') $('areaAI').value=''; else $('volumenAI').value='';
    }
    function updateAgeReferences(){
      const edad=$('edad').value, ritmo=$('ritmo').value, fevi=$('fevi').value, tipoAI=$('tipoAI').value;
      let edadTxt,eSeptalRef,eLateralRef,ePromRef;
      if(edad==="1"){edadTxt="20‚Äì39 a√±os"; eSeptalRef=7; eLateralRef=10; ePromRef=9;}
      else if(edad==="2"){edadTxt="40‚Äì65 a√±os"; eSeptalRef=6; eLateralRef=8; ePromRef=7;}
      else {edadTxt=">65 a√±os"; eSeptalRef=6; eLateralRef=7; ePromRef=6.5;}
      const aiRef=(tipoAI==="volumen")?"LAVi ‚â§34 ml/m¬≤":"√Årea AI ‚â§20 cm¬≤ (proxy)";
      const ritmoRef=(ritmo==="fa")?"<br>‚Ä¢ En FA no se utiliza E/A":"";
      const feviRef=(fevi==="menor")?"<br>‚Ä¢ FEVI reducida: se asume disfunci√≥n diast√≥lica":"";
      $('ageReferenceContent').innerHTML = `
        <strong>Edad ${edadTxt}:</strong><br>
        ‚Ä¢ e‚Ä≤ promedio ‚â• ${ePromRef} cm/s (lateral ‚â• ${eLateralRef}, septal ‚â• ${eSeptalRef})<br>
        ‚Ä¢ E/e‚Ä≤ ‚â§ 14<br>
        ‚Ä¢ ${aiRef}<br>
        ‚Ä¢ TR ‚â§ 2.8 m/s <em>o</em> PSAP &lt; 35 mmHg<br>
        ‚Ä¢ LARS ‚â• 18% (espec√≠fico), ‚â• 23% (normal)
        ${ritmoRef}${feviRef}`;
      $('ageReferences').style.display='block';
    }
    function openModal(){ $('algModal').style.display='block'; }
    function closeModal(){ $('algModal').style.display='none'; }
    function syncPresionUI(){
      const sel=$('parametroPresion').value;
      $('labelPresion').textContent = (sel==='PSAP')?'PSAP:':'Velocidad pico TR:';
      $('unidadPresion').textContent = (sel==='PSAP')?'mmHg':'m/s';
      const input=$('valorPresion');
      if(sel==='PSAP'){input.min=0;input.max=120;input.step=0.1;}
      else {input.min=0;input.max=6;input.step=0.01;}
    }
    function renderEscenarioInfo(){
      const esc=$('escenarioEspecial').value;
      const info={
        normal:"Caso general: 3 principales (e‚Ä≤, E/e‚Ä≤, TR/PSAP). Si discordantes, use LARS, LAVi, S/D e IVRT.",
        AF:"FA: sin gradaci√≥n; multipar√°metros (E‚â•100, E/e‚Ä≤ septal>11, TR‚â•2.8 o PSAP‚â•35, DT‚â§160; soporte LARS<18%, S/D<1, IMC>30).",
        MAC:"MAC: E/A<0.8 ‚Üí LAP normal; >1.8 ‚Üí LAP elevada; si 0.8‚Äì1.8 use IVRT (‚â•80 ms normal, <80 ms elevada).",
        MR:"MR: LAVi/√Årea pueden estar altos por volumen; priorice LARS, S/D<1, IVRT ‚â§60‚Äì70 ms.",
        MS:"MS: E y E/A distorsionan; apoyarse en TR/PSAP, S/D, IVRT; LARS/LAVi con cautela.",
        PHnoCard:"PH no cardiaca: TR/PSAP altos no se cuentan para LAP; use e‚Ä≤, E/e‚Ä≤ y adicionales.",
        LVAD:"LVAD: par√°metros convencionales menos fiables; foco en S/D, LARS y cl√≠nica.",
        HTX:"Trasplante: e‚Ä≤ y E/e‚Ä≤ alterables; priorice LARS y S/D; conclusi√≥n conservadora.",
        Constriccion:"Constrictiva: e‚Ä≤ puede ser relativamente alto; no penalizar e‚Ä≤ bajo; priorice S/D e IVRT.",
        HCM:"MCH: E/e‚Ä≤ alto requiere soporte (LARS, S/D, LAVi) antes de concluir LAP elevada.",
        BCRI_CRT:"BCRI/CRT: TDI lateral poco fiable; priorizar e‚Ä≤ septal (el promedio puede usar solo septal)."
      };
      $('escenarioInfo').textContent = info[esc]||info.normal;
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // Enter = calcular
      $('diastolicForm').addEventListener('keydown',(e)=>{
        if(e.key==='Enter'){ e.preventDefault(); calcularFuncionDiastolica(); }
      });
      $('openAlgInfo').addEventListener('click',openModal);
      $('algModal').addEventListener('click',(e)=>{ if(e.target===e.currentTarget) closeModal(); });
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeModal(); });

      updateAgeReferences(); toggleEASection(); toggleAIInput(); syncPresionUI(); renderEscenarioInfo();
    });

    // ---- n√∫cleo del algoritmo ----
    function calcularFuncionDiastolica(){
      const ritmo=$('ritmo').value, edad=$('edad').value, fevi=$('fevi').value, tipoAI=$('tipoAI').value;
      const parametroPresion=$('parametroPresion').value, esc=$('escenarioEspecial').value;

      $('feviWarning').style.display = (fevi==='menor')?'block':'none';
      $('indeterminateNote').style.display='none';

      const valores={
        eSeptal: num('eSeptal'),
        eLateral: num('eLateral'),
        volumenAI: num('volumenAI'),
        areaAI: num('areaAI'),
        parametroPresion,
        valorPresion: num('valorPresion'),
        laStrain: num('laStrain'),
        velocidadE: num('velocidadE'),
        velocidadA: num('velocidadA'),
        ivrt: num('ivrt'),
        sd: num('sd'),
        escenarioEspecial: esc
      };
      const faltan = getMissingParams(ritmo, tipoAI, valores);

      // E/A y e‚Ä≤ promedio (con ajustes de escenario)
      let ea = null;
      if(ritmo==="sinusal" && !isNaN(valores.velocidadE) && !isNaN(valores.velocidadA) && valores.velocidadA>0){
        ea = valores.velocidadE / valores.velocidadA;
      }
      let eLat=valores.eLateral, eSep=valores.eSeptal;
      if(esc==="BCRI_CRT" && !isNaN(eSep)) eLat = NaN;
      let eProm=null;
      if(!isNaN(eSep) && !isNaN(eLat)) eProm=(eSep+eLat)/2;
      else if(!isNaN(eSep)) eProm=eSep;
      else if(!isNaN(eLat)) eProm=eLat;

      let ee=null;
      if(!isNaN(valores.velocidadE) && eProm>0) ee = valores.velocidadE / eProm;

      // Cortes por edad
      let eSeptalRef,eLateralRef,ePromRef;
      if(edad==="1"){ eSeptalRef=7; eLateralRef=10; ePromRef=9; }
      else if(edad==="2"){ eSeptalRef=6; eLateralRef=8; ePromRef=7; }
      else { eSeptalRef=6; eLateralRef=7; ePromRef=6.5; }

      // Estados de par√°metros
      const parametros=[];
      let eLateralNormal=null;
      if(!isNaN(valores.eLateral)){
        const ref=(esc==="BCRI_CRT")?"‚Äî (ignorado)":"‚â•"+eLateralRef+" cm/s";
        eLateralNormal = (esc==="BCRI_CRT")?null:(valores.eLateral>=eLateralRef);
        parametros.push({nombre:"e‚Ä≤ lateral",valor:valores.eLateral.toFixed(1)+" cm/s",estado:eLateralNormal===null?"indeterminate":(eLateralNormal?"normal":"abnormal"),referencia:ref});
      }
      let eSeptalNormal=null;
      if(!isNaN(valores.eSeptal)){
        eSeptalNormal = valores.eSeptal>=eSeptalRef;
        parametros.push({nombre:"e‚Ä≤ septal",valor:valores.eSeptal.toFixed(1)+" cm/s",estado:eSeptalNormal?"normal":"abnormal",referencia:"‚â•"+eSeptalRef+" cm/s"});
      }
      let ePromNormal=null;
      if(eProm!==null){
        if(esc==="Constriccion"){
          ePromNormal=null;
          parametros.push({nombre:"e‚Ä≤ promedio",valor:eProm.toFixed(1)+" cm/s",estado:"indeterminate",referencia:"No penaliza en constricci√≥n"});
        }else{
          ePromNormal = eProm>=ePromRef;
          parametros.push({nombre:"e‚Ä≤ promedio",valor:eProm.toFixed(1)+" cm/s",estado:ePromNormal?"normal":"abnormal",referencia:"‚â•"+ePromRef+" cm/s"});
        }
      }
      if(ritmo==="sinusal" && ea!==null){
        parametros.push({nombre:"Relaci√≥n E/A",valor:ea.toFixed(2),estado:"indeterminate",referencia:"Informativo p/gradaci√≥n"});
      }
      let eeNormal=null;
      if(ee!==null){
        eeNormal = ee<=14;
        const refTxt = (esc==="HCM")?"‚â§14 (requiere soporte si >14)":"‚â§14";
        parametros.push({nombre:"E/e‚Ä≤ promedio",valor:ee.toFixed(1),estado:eeNormal?"normal":"abnormal",referencia:refTxt});
      }

      // LAVi / √Årea
      let aiNormal=null;
      if(tipoAI==="volumen" && !isNaN(valores.volumenAI)){
        aiNormal = valores.volumenAI<=34;
        const note=(esc==="MR")?" (no se usa como evidencia primaria en MR)":"";
        parametros.push({nombre:"LAVi",valor:valores.volumenAI+" ml/m¬≤",estado:aiNormal?"normal":"abnormal",referencia:"‚â§34 ml/m¬≤"+note});
      }else if(tipoAI==="area" && !isNaN(valores.areaAI)){
        aiNormal = valores.areaAI<=20;
        const note=(esc==="MR")?" (no se usa como evidencia primaria en MR)":"";
        parametros.push({nombre:"√Årea AI",valor:valores.areaAI+" cm¬≤",estado:aiNormal?"normal":"abnormal",referencia:"‚â§20 cm¬≤ (proxy)"+note});
      }

      // TR / PSAP
      let presionNormal=null, nombrePresion=null, refPresion=null, valorPresionFmt="";
      if(!isNaN(valores.valorPresion)){
        if(valores.parametroPresion==="TR"){
          presionNormal = valores.valorPresion<=2.8;
          nombrePresion="Velocidad TR"; refPresion="‚â§2.8 m/s"; valorPresionFmt=valores.valorPresion.toFixed(2)+" m/s";
        }else{
          presionNormal = valores.valorPresion<35;
          nombrePresion="PSAP"; refPresion="<35 mmHg"; valorPresionFmt=valores.valorPresion.toFixed(1)+" mmHg";
        }
        const note=(esc==="PHnoCard")?" (neutralizado en PH no cardiaca)":"";
        parametros.push({nombre:nombrePresion,valor:valorPresionFmt,estado:presionNormal?"normal":"abnormal",referencia:refPresion+note});
      }

      let laStrainNormal=null;
      if(!isNaN(valores.laStrain)){
        laStrainNormal = valores.laStrain>=18;
        parametros.push({nombre:"LARS",valor:valores.laStrain.toFixed(1)+" %",estado:laStrainNormal?"normal":"abnormal",referencia:"‚â•18% (espec√≠fico), ‚â•23% (normal)"});
      }

      // Conteo de principales
      let principalesAlterados=0, principalesNormales=0, principalesTotal=0;
      if(ePromNormal!==null){ principalesTotal++; principalesAlterados+=ePromNormal?0:1; principalesNormales+=ePromNormal?1:0; }
      if(eeNormal!==null && !(esc==="HCM" && eeNormal===false)){ principalesTotal++; principalesAlterados+=eeNormal?0:1; principalesNormales+=eeNormal?1:0; }
      if(presionNormal!==null && esc!=="PHnoCard"){ principalesTotal++; principalesAlterados+=presionNormal?0:1; principalesNormales+=presionNormal?1:0; }

      // Adicionales
      let soporteElevada=false, soporteNormal=false;
      if(laStrainNormal===false) soporteElevada=true;
      if(laStrainNormal===true)  soporteNormal=true;
      if(tipoAI==="volumen" && !isNaN(valores.volumenAI)){
        if(esc!=="MR" && valores.volumenAI>34) soporteElevada=true;
        if(valores.volumenAI<=34) soporteNormal=true;
      }else if(tipoAI==="area" && !isNaN(valores.areaAI)){
        if(esc!=="MR" && valores.areaAI>20) soporteElevada=true;
        if(valores.areaAI<=20) soporteNormal=true;
      }
      if(!isNaN(valores.sd) && valores.sd<1.0) soporteElevada=true;
      if(!isNaN(valores.ivrt)){
        const corte=(esc==="MR"||esc==="MS")?60:70;
        if(valores.ivrt<=corte) soporteElevada=true;
        if(esc==="MAC" && ea!==null && ea>=0.8 && ea<=1.8 && valores.ivrt>=80) soporteNormal=true;
      }

      // Decisi√≥n
      let diagnostico="", pressureStatus="", recomendaciones="";
      const isAF = (ritmo==='fa' || esc==='AF');

      if(isAF){
        // (AF: sin gradaci√≥n; mantenemos tu l√≥gica previa de presi√≥n por conteo)
        let alterados=0,normales=0;
        if(ePromNormal!==null){ alterados+=ePromNormal?0:1; normales+=ePromNormal?1:0; }
        if(eeNormal!==null && !(esc==="HCM" && eeNormal===false)){ alterados+=eeNormal?0:1; normales+=eeNormal?1:0; }
        if(presionNormal!==null && esc!=="PHnoCard"){ alterados+=presionNormal?0:1; normales+=presionNormal?1:0; }
        if(alterados>=2){ diagnostico="Disfunci√≥n diast√≥lica"; pressureStatus="Presi√≥n de llenado elevada"; }
        else if(normales>=2){ diagnostico="Funci√≥n diast√≥lica probablemente normal"; pressureStatus="Presi√≥n de llenado normal"; }
        else{ diagnostico="Indeterminado"; $('indeterminateNote').style.display='block'; }
        recomendaciones="FA: sin gradaci√≥n. Use LARS/S-D/IVRT/LAVi para desempatar si queda dudoso.";
      }else{
        if(principalesTotal===3 && principalesAlterados===3){
          diagnostico="Disfunci√≥n diast√≥lica";
          pressureStatus="Presi√≥n de llenado elevada";
          recomendaciones="Los 3 par√°metros principales (e‚Ä≤, E/e‚Ä≤, TR/PSAP) est√°n alterados.";
        }else if(principalesTotal===3 && principalesNormales===3){
          diagnostico="Funci√≥n diast√≥lica normal";
          pressureStatus="Presi√≥n de llenado normal";
          recomendaciones="Los 3 par√°metros principales est√°n normales.";
        }else if(principalesTotal>=2 && (principalesAlterados>=1 && principalesAlterados<principalesTotal)){
          if(soporteElevada){
            diagnostico="Disfunci√≥n diast√≥lica";
            pressureStatus="Presi√≥n de llenado elevada";
            recomendaciones="Discordancia resuelta por adicionales (LARS ‚â§18%, LAVi >34*, S/D <1 o IVRT bajo).";
          }else if(soporteNormal){
            // NUEVO: probablemente normal (discordante)
            pressureStatus="Presi√≥n de llenado probablemente normal (discordante)";
            if(ePromNormal===false) diagnostico="Relajaci√≥n alterada (sin evidencia de LAP elevada)";
            else diagnostico="Funci√≥n diast√≥lica probablemente normal";
            recomendaciones="Discordancia con adicionales no sugestivos de LAP elevada. Considere eco de ejercicio si hay s√≠ntomas.";
          }else{
            diagnostico="Indeterminado";
            $('indeterminateNote').style.display='block';
            recomendaciones="Mida LARS, LAVi, S/D o IVRT; si hay s√≠ntomas y LAP no elevada ‚Üí eco de ejercicio.";
          }
        }else{
          diagnostico="Indeterminado";
          $('indeterminateNote').style.display='block';
          recomendaciones="Faltan par√°metros principales (e‚Ä≤, E/e‚Ä≤, TR/PSAP) para definir LAP.";
        }

        // Gradaci√≥n
        // G3/G2 ya se abordan con LAP elevada seg√∫n E/A
        if(pressureStatus.includes("elevada") && ritmo==="sinusal" && ea!==null){
          if(ea>=2.0) diagnostico += " - Grado III";
          else diagnostico += " - Grado II";
        }else if(ritmo==="sinusal"){
          // G1 solo si se cumple el conjunto actualizado
          const ePrimeReducido = (ePromNormal===false);
          const paspOk = (presionNormal===true || presionNormal===null); // si no se ingres√≥, no forzamos
          if(ePrimeReducido && eeNormal===true && paspOk && ea!==null && ea<=0.8){
            diagnostico = "Disfunci√≥n diast√≥lica - Grado I";
            if(!pressureStatus) pressureStatus="Presi√≥n de llenado normal";
          }
        }
      }

      // Advertencias
      let advertencias="";
      if(faltan.length>0){
        advertencias = `<div class="missing-params-warning"><strong>‚ö†Ô∏è Par√°metros no ingresados:</strong> ${faltan.join(", ")}.</div>`;
      }
      if(isNaN(valores.velocidadE)){
        advertencias += "<br>‚ö†Ô∏è Falta Onda E ‚Üí no se puede calcular E/e‚Ä≤.";
      }

      // Render UI
      const results=$('results');
      // Clasificaci√≥n visual basada en presi√≥n
      results.className="results";
      const pressureTxt = (pressureStatus||"");
      if(pressureTxt.includes("normal")) results.classList.add("normal");
      else if(pressureTxt.includes("elevada")) results.classList.add("abnormal");
      else results.classList.add("indeterminate");

      $('diagnostico').innerHTML = diagnostico;
      $('pressureStatus').innerHTML = pressureStatus;
      $('pressureStatus').className="pressure-status";
      if(pressureTxt.includes("elevada")) $('pressureStatus').classList.add("elevated");
      else if(pressureTxt.includes("normal")) $('pressureStatus').classList.add("normal");

      let htmlParams="";
      parametros.forEach(p=>{
        htmlParams += `<div class="parameter-item ${p.estado}"><strong>${p.nombre}:</strong> ${p.valor} <span style="color:#888;font-size:.95em;">(${p.referencia})</span></div>`;
      });
      $('parametros-status').innerHTML = htmlParams;
      $('recomendaciones').innerHTML = advertencias + recomendaciones;

      results.style.display="block";
      results.scrollIntoView({behavior:"smooth", block:"start"});
      // Foco accesible al encabezado
      $('diagnostico').focus({preventScroll:true});
    }
  </script>
</body>
</html>
