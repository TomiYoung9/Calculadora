<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Funci√≥n Diast√≥lica</title>

  <!-- Performance / fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --main-bg:#b7d0e8; --header-bg:#3a5a7a; --card-bg:#fff;
      --accent:#27ae60; --accent-dark:#219150; --accent-light:#e9f7ef;
      --text-main:#1a2a36; --text-soft:#5a6e7f; --border:#e3eaf2; --shadow:0 4px 24px rgba(74,144,226,0.08);
      --red:#e74c3c; --green:#27ae60; --yellow:#f7b731; --blue:#3498db;
    }
    body{font-family:'Inter',Arial,sans-serif;background:var(--main-bg);min-height:100vh;margin:0}
    .container{max-width:900px;margin:40px auto 0;background:var(--card-bg);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .header{background:var(--header-bg);color:#fff;padding:36px 20px 24px;text-align:center;position:relative}
    .header h1{font-size:2.1em;font-weight:700;margin:0 0 8px;letter-spacing:.5px;display:flex;align-items:center;justify-content:center;gap:14px;color:#fff}
    .header .subtitle{font-size:1.08em;font-weight:500;color:#fff;margin-top:6px;letter-spacing:.2px}

    .form-container{padding:36px 22px 28px}
    .info-box{background:var(--accent-light);color:var(--text-main);padding:15px 20px;border-radius:10px;margin-bottom:24px;font-size:1.05em;box-shadow:0 2px 8px #4a90e211;position:relative}
    .alg-link{display:block;text-align:right;margin-top:6px;color:#3a5a7a;font-size:.97em;text-decoration:underline dotted;cursor:pointer;transition:color .2s}
    .alg-link:hover{color:var(--accent)}

    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 2px 8px #4a90e211;border:1.5px solid var(--border);margin-bottom:20px;padding:22px 18px 12px;transition:box-shadow .2s}
    .form-card h3{color:var(--text-main);font-size:1.13em;font-weight:600;margin-bottom:14px;letter-spacing:.3px}

    .input-row-group{display:flex;gap:18px;flex-wrap:wrap}
    .input-row{display:flex;align-items:center;margin-bottom:10px;gap:10px;flex:1 1 220px;min-width:220px}
    .input-row--full{flex:1 1 100%;min-width:100%}
    .input-row label{font-weight:500;color:var(--text-main);font-size:1em;flex:1 1 140px;min-width:0}
    .input-row input,.input-row select{flex:0 0 120px;padding:9px 10px;border:1.5px solid var(--border);border-radius:6px;font-size:1em;background:#f7fbfd;color:var(--text-main);transition:border-color .2s;min-width:0}
    .input-row input:focus,.input-row select:focus{outline:none;border-color:var(--accent)}
    .unit{margin-left:7px;color:var(--text-soft);font-weight:500;font-size:.97em;white-space:nowrap}

    .ai-option-note{font-size:.92em;color:#5a6e7f;margin-top:7px;font-style:italic}
    .calculate-btn{width:100%;padding:13px;background:var(--green);color:#fff;border:none;border-radius:9px;font-size:1.13em;font-weight:700;cursor:pointer;margin-top:14px;box-shadow:0 2px 8px #4a90e211;transition:background .2s, box-shadow .2s}
    .calculate-btn:hover{background:var(--accent-dark);box-shadow:0 6px 24px #4a90e122}

    .results{margin-top:26px;padding:22px 18px;border-radius:10px;display:none}
    .results.normal{background:#eafaf1;color:var(--green);border:2px solid var(--green)}
    .results.abnormal{background:#fdeaea;color:var(--red);border:2px solid var(--red)}
    .results.indeterminate{background:#fffbe6;color:var(--yellow);border:2px solid var(--yellow)}
    .results h3{font-size:1.2em;margin:0 0 10px}

    .parameter-status{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:6px;margin-top:12px}
    .parameter-item{background:rgba(255,255,255,.13);padding:7px 10px;border-radius:7px;border-left:4px solid #fff;font-size:1em;margin-bottom:0}
    .parameter-item.abnormal{border-left-color:var(--red);background:#fdeaea}
    .parameter-item.normal{border-left-color:var(--green);background:#eafaf1}
    .parameter-item.indeterminate{border-left-color:var(--yellow);background:#fffbe6}

    .recommendations{margin-top:12px;padding:12px 10px;background:rgba(255,255,255,.13);border-radius:7px}
    .fa-warning{background:#fff3cd;border:1px solid #ffeaa7;padding:10px 12px;border-radius:7px;margin-bottom:12px;color:#856404;font-size:1em}
    .fevi-warning{background:#fff8e1;border:1px solid #ffecb3;padding:10px 12px;border-radius:7px;margin-bottom:12px;color:#6d4c41;font-size:1em}
    .tr-warning{background:#e3f1fd;border:1.5px solid #b3d8f7;color:#357ab8;padding:10px 12px;border-radius:7px;margin-bottom:12px;font-size:1em;display:none}
    .indeterminate-note{background:#fffbe6;border:1.5px solid var(--yellow);color:#b38600;padding:10px 12px;border-radius:7px;margin-bottom:12px;font-size:1em}
    .age-reference{background:#e8f4fd;padding:10px 12px;border-radius:7px;margin-bottom:12px;border-left:4px solid var(--accent)}
    .missing-params-warning{background:#fffbe6;border:1.5px solid var(--yellow);color:#b38600;padding:10px 12px;border-radius:7px;margin-bottom:12px;font-size:1em}

    .referencias{margin-top:28px;padding:16px 12px;background:#f8f9fa;border-radius:9px;border-left:5px solid var(--accent-light)}
    .referencias h3{color:var(--text-main);margin-bottom:12px;font-size:1.08em}
    .referencia-item{margin-bottom:10px;padding:10px;background:#fff;border-radius:7px;box-shadow:0 2px 5px #4a90e20a}
    .referencia-item p{margin:0;line-height:1.6;color:var(--text-main)}
    .referencia-item a{color:var(--accent);text-decoration:none;font-weight:500}
    .referencia-item a:hover{color:var(--accent-dark);text-decoration:underline}

    .twitter-section{text-align:center;padding:10px;margin-bottom:6px}
    .twitter-link,.linkedin-link{display:inline-flex;align-items:center;gap:8px;color:#111;text-decoration:none;font-weight:600;font-size:1.1em;transition:all .3s ease}
    .twitter-link:hover,.linkedin-link:hover{color:var(--accent)}
    .twitter-icon{width:24px;height:24px}
    /* evitar color ‚Äúvisitado‚Äù violeta en los links sociales */
    .twitter-section a:visited{color:#111}

    .pressure-status{font-size:1.08em;font-weight:bold;margin-top:8px;padding:7px;border-radius:7px;text-align:center}
    .pressure-status.normal{background:#eafaf1;color:var(--green)}
    .pressure-status.elevated{background:#fdeaea;color:var(--red)}

    /* Modal */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;overflow:auto;background-color:rgba(0,0,0,.5);backdrop-filter:blur(3px)}
    .modal-content{background:#fff;margin:5% auto;padding:20px 30px;border-radius:12px;max-width:600px;box-shadow:0 4px 24px rgba(0,0,0,.2);position:relative}
    .modal-close{position:absolute;top:12px;right:16px;background:transparent;border:none;font-size:28px;font-weight:bold;cursor:pointer;color:#333;line-height:1}
    .modal-close:hover{color:#27ae60}
    .modal-body{max-height:60vh;overflow-y:auto;font-size:.95em;line-height:1.4}
    .modal-table{width:100%;border-collapse:collapse;margin-top:10px}
    .modal-table th,.modal-table td{border:1px solid #ccc;padding:6px 10px;text-align:center}
    .modal-table th{background:#f0f4f8;font-weight:600}

    /* Explain Mode */
    .explain{margin-top:12px;padding:12px;border-radius:10px;border:1.5px solid var(--border);background:#f9fafb}
    .explain h4{margin:0 0 8px;font-size:1.05em;display:flex;align-items:center;gap:8px;color:var(--text-main)}
    .explain ul{margin:0;padding-left:18px;color:var(--text-soft);line-height:1.5}
    .explain--normal{background:#eafaf1;border-color:var(--green)}
    .explain--elevada{background:#fdeaea;border-color:var(--red)}
    .explain--indet{background:#fffbe6;border-color:var(--yellow)}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.85em;font-weight:600;margin-left:6px}
    .chip--normal{background:#dff5e7;color:#1c7c4e}
    .chip--elevada{background:#ffe1df;color:#9b3126}
    .chip--indet{background:#fff1c7;color:#8a6a00}

    /* Footer versi√≥n */
    .version-footer{font-size:.85em;color:#6b7280;text-align:center;margin:12px 0 18px}

    /* M√≥vil */
    @media (max-width:480px){
      body{font-size:14px;line-height:1.3}
      .container{width:95vw;max-width:400px;margin:8px auto;border-radius:10px;box-shadow:none}
      .form-container{padding:12px 10px}
      .form-card{padding:14px 12px 8px;margin-bottom:8px;border:1px solid var(--border);box-shadow:none}
      .form-card h3{font-size:1.1em;margin-bottom:8px;line-height:1.3}
      .input-row-group{display:block}
      .input-row{flex-direction:column;align-items:flex-start;margin-bottom:12px;gap:4px;width:100%;min-width:0!important}
      .input-row--full{flex:none;min-width:0}
      .input-row label{font-size:1em;flex:none;width:100%;margin:0;white-space:normal;color:var(--text-main)}
      .input-row input,.input-row select{width:100%;flex:none;padding:8px 10px;font-size:1em;height:36px;box-sizing:border-box;border-radius:6px;border:1.5px solid var(--border);background:#f7fbfd;color:var(--text-main)}
      .unit{margin-left:0;margin-top:4px;font-size:.85em;color:var(--text-soft);display:inline-block}
      .calculate-btn{width:100%;font-size:1.1em;padding:10px 0;border-radius:7px;margin-top:10px;box-shadow:none}
      .results{padding:12px 10px;font-size:1em;margin-top:14px;line-height:1.3}
      .parameter-status{grid-template-columns:1fr;gap:6px;margin-top:8px}
      .parameter-item{font-size:.9em;padding:5px 8px;word-wrap:break-word;margin-bottom:4px;line-height:1.2}
      .info-box,.referencias,.fa-warning,.fevi-warning,.tr-warning,.indeterminate-note,.age-reference,.recommendations,.missing-params-warning{font-size:.9em;padding:8px 10px;margin-bottom:8px;line-height:1.2}
      .recommendations{margin-top:8px;padding:8px 10px}
      .modal-content{margin:10px 5px;max-width:95vw;padding:18px 14px;max-height:90vh}
      .modal-table{font-size:.85em}
      input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü´Ä Calculadora de Funci√≥n Diast√≥lica</h1>
      <div class="subtitle">ASE 2025</div>
    </div>

    <div class="form-container">
      <div class="info-box">
        <strong>üìã Instrucciones:</strong> Complete los par√°metros ecocardiogr√°ficos disponibles. Todos los campos son opcionales. Las velocidades van en <b>cm/s</b> (E, A, e‚Ä≤) y <b>m/s</b> (TR) o <b>mmHg</b> (PSAP).
        <a id="openAlgInfo" class="alg-link" href="javascript:void(0)">¬øC√≥mo funciona el algoritmo?</a>
      </div>

      <form id="diastolicForm">
        <div class="form-card">
          <h3>ü©∫ Contexto cl√≠nico</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Ritmo:</label>
              <select id="ritmo" onchange="toggleEASection();updateAgeReferences();">
                <option value="sinusal">Ritmo sinusal</option>
                <option value="fa">Fibrilaci√≥n auricular</option>
              </select>
            </div>
            <div class="input-row">
              <label>FEVI:</label>
              <select id="fevi" onchange="updateAgeReferences()">
                <option value="mayorigual">‚â•50%</option>
                <option value="menor">&lt;50%</option>
              </select>
            </div>
            <div class="input-row">
              <label>Edad:</label>
              <select id="edad" onchange="updateAgeReferences()">
                <option value="1">20‚Äì39 a√±os</option>
                <option value="2">40‚Äì65 a√±os</option>
                <option value="3">&gt;65 a√±os</option>
              </select>
            </div>
          </div>
        </div>

        <div id="ageReferences" class="age-reference" style="display:none;">
          <strong>üìä Valores de referencia para este perfil:</strong>
          <div id="ageReferenceContent"></div>
        </div>

        <div class="form-card" id="eaSection">
          <h3>üîÑ Flujo mitral (Doppler pulsado)</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Onda E:</label>
              <input type="number" id="velocidadE" step="0.1" min="0" max="300" placeholder="Opcional" inputmode="decimal" />
              <span class="unit">cm/s</span>
            </div>
            <div class="input-row">
              <label>Onda A:</label>
              <input type="number" id="velocidadA" step="0.1" min="0" max="300" placeholder="Opcional" inputmode="decimal" />
              <span class="unit">cm/s</span>
            </div>
          </div>
        </div>

        <div id="faWarning" class="fa-warning" style="display:none;">
          ‚ö†Ô∏è <strong>Fibrilaci√≥n auricular:</strong> No se utiliza la relaci√≥n E/A para el diagn√≥stico. La onda E s√≠ se usa para calcular E/e‚Ä≤.
        </div>

        <div class="form-card">
          <h3>üéØ Doppler tisular</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>e‚Ä≤ lateral:</label>
              <input type="number" id="eLateral" step="0.1" min="0" max="30" placeholder="Opcional" inputmode="decimal" />
              <span class="unit">cm/s</span>
            </div>
            <div class="input-row">
              <label>e‚Ä≤ septal:</label>
              <input type="number" id="eSeptal" step="0.1" min="0" max="30" placeholder="Opcional" inputmode="decimal" />
              <span class="unit">cm/s</span>
            </div>
          </div>
        </div>

        <div class="form-card">
          <h3>üìè Aur√≠cula izquierda</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Tipo de medici√≥n:</label>
              <select id="tipoAI" onchange="toggleAIInput();updateAgeReferences();">
                <option value="volumen">Volumen indexado</option>
                <option value="area">√Årea</option>
              </select>
            </div>
            <div class="input-row" id="volumenRow">
              <label>Vol AI indexado:</label>
              <input type="number" id="volumenAI" step="1" min="0" max="200" placeholder="Opcional" inputmode="decimal" />
              <span class="unit">ml/m¬≤</span>
            </div>
            <div class="input-row" id="areaRow" style="display:none;">
              <label>√Årea auricular izquierda:</label>
              <input type="number" id="areaAI" step="0.1" min="0" max="60" placeholder="Opcional" inputmode="decimal" />
              <span class="unit">cm¬≤</span>
            </div>
          </div>
          <div class="ai-option-note">
            <em>Complete uno u otro par√°metro. Referencias: LAVi ‚â§34 ml/m¬≤ o √Årea ‚â§20 cm¬≤ (proxy de LAVi).</em>
          </div>
        </div>

        <div class="form-card">
          <h3>üåä TR / PSAP</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Par√°metro:</label>
              <select id="parametroPresion" onchange="syncPresionUI()">
                <option value="TR" selected>Velocidad pico TR</option>
                <option value="PSAP">PSAP</option>
              </select>
            </div>
            <div class="input-row">
              <label id="labelPresion">Velocidad pico TR:</label>
              <input type="number" id="valorPresion" step="0.01" min="0" max="6" placeholder="Opcional" inputmode="decimal" />
              <span class="unit" id="unidadPresion">m/s</span>
            </div>
          </div>
          <div class="tr-warning" id="trNote">
            Puede usar <strong>PSAP</strong> como alternativa a la velocidad TR: criterio ‚Üí <strong>PSAP ‚â•35 mmHg</strong> o <strong>TR ‚â•2.8 m/s</strong>.
          </div>
        </div>

        <div class="form-card">
          <h3>‚≠ê Strain auricular izquierdo</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>LA Strain:</label>
              <input type="number" id="laStrain" step="1" min="0" max="60" placeholder="Opcional" inputmode="decimal" />
              <span class="unit">%</span>
            </div>
          </div>
        </div>

        <!-- Calculadora avanzada -->
        <div class="form-card">
          <h3>üß© Calculadora avanzada</h3>
          <div class="input-row-group">
            <div class="input-row input-row--full">
              <label>Escenario especial:</label>
              <select id="escenarioEspecial" onchange="renderEscenarioInfo()">
                <option value="normal" selected>‚Äî Caso general ‚Äî</option>
                <option value="AF">Fibrilaci√≥n auricular</option>
                <option value="MAC">MAC moderada/severa</option>
                <option value="MR">Insuficiencia mitral significativa</option>
                <option value="MS">Estenosis mitral significativa</option>
                <option value="PHnoCard">Hipertensi√≥n pulmonar no cardiaca</option>
                <option value="LVAD">LVAD</option>
                <option value="HTX">Trasplante card√≠aco</option>
                <option value="Constriccion">Pericarditis constrictiva</option>
                <option value="HCM">Miocardiopat√≠a hipertr√≥fica</option>
                <option value="BCRI_CRT">BCRI / CRT / marcapaseo</option>
              </select>
            </div>
            <div class="input-row">
              <label>IVRT:</label>
              <input type="number" id="ivrt" step="1" min="20" max="200" placeholder="Opcional" inputmode="decimal" />
              <span class="unit">ms</span>
            </div>
            <div class="input-row">
              <label>Relaci√≥n S/D:</label>
              <input type="number" id="sd" step="0.01" min="0" max="3" placeholder="Opcional" inputmode="decimal" />
              <span class="unit">‚Äî</span>
            </div>
          </div>
          <div class="ai-option-note" id="escenarioInfo" style="margin-top:8px;"></div>
        </div>

        <button id="btnCalcular" type="submit" class="calculate-btn">üßÆ Calcular funci√≥n diast√≥lica</button>
      </form>

      <div id="results" class="results" aria-live="polite">
        <div id="feviWarning" class="fevi-warning" style="display:none;">
          ‚ö†Ô∏è <strong>FEVI reducida:</strong> En pacientes con FEVI &lt;50%, se asume disfunci√≥n diast√≥lica. Lo relevante es estimar la presi√≥n de llenado.
        </div>
        <div id="indeterminateNote" class="indeterminate-note" style="display:none;">
          Resultado indeterminado/discordante. Considere par√°metros adicionales (LAVi, LARS, S/D, IVRT) o eco de ejercicio si hay s√≠ntomas.
        </div>
        <h3 id="diagnostico" tabindex="-1">Resultado</h3>
        <div id="pressureStatus" class="pressure-status"></div>
        <div id="parametros-status" class="parameter-status"></div>
        <div id="recomendaciones" class="recommendations"></div>
        <!-- Explain Mode din√°mico -->
        <div id="explainBox" class="explain" style="display:none;"></div>
      </div>

      <div class="referencias">
        <h3>üìö Referencia</h3>
        <div class="referencia-item">
          <p>
            <strong>ASE 2025. Left Ventricular Diastolic Function by Echo</strong><br />
            <a href="https://onlinejase.com/article/S0894-7317(25)00157-9/fulltext" target="_blank" rel="noopener">
              https://onlinejase.com/article/S0894-7317(25)00157-9/fulltext
            </a><br/>
            <small>DOI: 10.1016/j.echo.2025.03.011</small>
          </p>
        </div>
      </div>

      <div class="twitter-section" style="display:flex;justify-content:center;gap:20px;padding:10px;margin-bottom:6px;">
        <a href="https://x.com/atomasyoung" target="_blank" rel="noopener" class="twitter-link">
          <svg class="twitter-icon" viewBox="0 0 1200 1227" fill="currentColor" width="24" height="24" aria-hidden="true" focusable="false">
            <path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z" />
          </svg>
          @atomasyoung
        </a>
        <a href="https://www.linkedin.com/in/tomas-young" target="_blank" rel="noopener" class="linkedin-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor" width="24" height="24" aria-hidden="true" focusable="false">
            <path d="M100.28 448H7.4V148.9h92.88zm-46.44-340.7a53.66 53.66 0 1 1 53.66-53.66 53.66 53.66 0 0 1-53.66 53.66zM447.9 448h-92.68V302.4c0-34.7-12.4-58.4-43.4-58.4-23.7 0-37.8 15.9-44 31.3-2.3 5.6-2.9 13.4-2.9 21.3V448h-92.68s1.2-270.1 0-297.1h92.68v42.1c12.3-19 34.3-46 83.4-46 60.9 0 106.7 39.8 106.7 125.4z" />
          </svg>
          Tomas Young
        </a>
      </div>

      <div class="version-footer">v1.1.2 ¬∑ actualizada 11/08/2025</div>
    </div>
  </div>

  <!-- Modal -->
  <div id="algModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="algTitle">
      <button class="modal-close" onclick="closeModal()" aria-label="Cerrar">√ó</button>
      <h2 id="algTitle">üß† Algoritmo</h2>
      <div class="modal-body">
        <h4>1) Flujo principal seg√∫n la gu√≠a</h4>
        <p>El algoritmo ASE 2025 comienza evaluando <strong>e‚Ä≤</strong> (ajustado por edad), <strong>E/e‚Ä≤</strong> y <strong>TR</strong> <em>o</em> <strong>PSAP</strong>. Si hay discordancia, se usan par√°metros adicionales.</p>

        <h4>2) Si FEVI &lt;50% (cualquier ritmo)</h4>
        <p><strong>Diagn√≥stico:</strong> se asume disfunci√≥n diast√≥lica. Objetivo: estimar <strong>presi√≥n de llenado</strong>. ‚â•2 de 3 pilares alterados ‚Üí LAP elevada.</p>

        <h4>3) Si FEVI ‚â•50% y Ritmo Sinusal</h4>
        <p><strong>Paso 1:</strong> e‚Ä≤ medio (por edad), E/e‚Ä≤ y TR (o PSAP).</p>
        <ul>
          <li>3/3 alterados ‚Üí LAP elevada</li>
          <li>3/3 normales ‚Üí LAP normal</li>
          <li>1‚Äì2 alterados ‚Üí <em>Paso 2</em></li>
        </ul>
        <p><strong>Paso 2 (adicionales):</strong> LARS ‚â§18%, LAVi &gt;34 ml/m¬≤ (o √Årea AI &gt;20 cm¬≤ como <em>proxy</em>), S/D venas pulmonares &lt;1, IVRT ‚â§70 ms.<br/>
        <strong>Gradaci√≥n (si RS y datos):</strong> Grado I (E/A &lt;0.8 y E &lt;50 cm/s) ¬∑ Grado III (E/A ‚â•2.0) ¬∑ Grado II (resto).</p>

        <h4>4) Fibrilaci√≥n auricular</h4>
        <p>No se informa <em>grado</em>. Estime LAP con enfoque multipar√°metros; promedie varios ciclos representativos.</p>

        <h4>5) Valores de referencia de e‚Ä≤ por edad</h4>
        <table class="modal-table">
          <thead><tr><th>Grupo etario</th><th>e‚Ä≤ septal</th><th>e‚Ä≤ lateral</th><th>e‚Ä≤ promedio</th></tr></thead>
          <tbody>
            <tr><td>20‚Äì39 a√±os</td><td>‚â•7 cm/s</td><td>‚â•10 cm/s</td><td>‚â•9 cm/s</td></tr>
            <tr><td>40‚Äì65 a√±os</td><td>‚â•6 cm/s</td><td>‚â•8 cm/s</td><td>‚â•7 cm/s</td></tr>
            <tr><td>&gt;65 a√±os</td><td>‚â•6 cm/s</td><td>‚â•7 cm/s</td><td>‚â•6.5 cm/s</td></tr>
          </tbody>
        </table>

        <p><strong>Par√°metros independientes de edad:</strong></p>
        <ul>
          <li><strong>E/e‚Ä≤ promedio:</strong> ‚â§14</li>
          <li><strong>TR:</strong> ‚â§2.8 m/s <em>o</em> <strong>PSAP:</strong> &lt;35 mmHg</li>
          <li><strong>LAVi:</strong> ‚â§34 ml/m¬≤ (√Årea AI ‚â§20 cm¬≤ como aproximaci√≥n)</li>
          <li><strong>LA Strain:</strong> ‚â•18% (espec√≠fico), ‚â•23% (normal)</li>
        </ul>

        <h4>6) Escenarios especiales (ejemplos)</h4>
        <ul>
          <li><strong>MAC:</strong> E/A &lt;0.8 ‚Üí LAP normal; &gt;1.8 ‚Üí LAP elevada; si 0.8‚Äì1.8, use <strong>IVRT</strong> (‚â•80 ms normal, &lt;80 ms elevada).</li>
          <li><strong>MR significativa:</strong> LAVi/√Årea pueden estar altos por volumen; priorizar LARS, S/D &lt;1 e IVRT bajo (&lt;60‚Äì70 ms).</li>
          <li><strong>MS significativa:</strong> E y E/A se alteran por obstrucci√≥n; apoyarse en TR/PSAP, S/D e IVRT.</li>
        </ul>

        <p style="font-size:.9em;color:#666;text-align:center;margin-top:16px;">
          <strong>Basado en las gu√≠as ASE 2025</strong>
        </p>
      </div>
    </div>
  </div>

  <script>
    // ---------- Utilidades ----------
    function parseNumFromInput(id){
      const raw = (document.getElementById(id).value || "").trim().replace(',', '.');
      const n = parseFloat(raw);
      return isNaN(n) ? NaN : n;
    }

    function getMissingParams(ritmo, tipoAI, valores) {
      const faltan = [];
      if (isNaN(valores.eSeptal)) faltan.push("e' septal");
      if (isNaN(valores.eLateral)) faltan.push("e' lateral");
      if (tipoAI === "volumen" && isNaN(valores.volumenAI)) faltan.push("Volumen AI indexado");
      if (tipoAI === "area" && isNaN(valores.areaAI)) faltan.push("√Årea AI");
      if (valores.parametroPresion === "TR" && isNaN(valores.valorPresion)) faltan.push("Velocidad TR");
      if (valores.parametroPresion === "PSAP" && isNaN(valores.valorPresion)) faltan.push("PSAP");
      if (ritmo === "sinusal") {
        if (isNaN(valores.velocidadE)) faltan.push("Onda E");
        if (isNaN(valores.velocidadA)) faltan.push("Onda A");
      }
      if (isNaN(valores.laStrain)) faltan.push("LARS");
      return faltan;
    }

    function toggleEASection(){
      const ritmo = document.getElementById('ritmo').value;
      const eaSection = document.getElementById('eaSection');
      const faWarning = document.getElementById('faWarning');
      const eRow = document.getElementById('velocidadE').closest('.input-row');
      const aRow = document.getElementById('velocidadA').closest('.input-row');
      if (ritmo === 'fa') {
        eaSection.style.display='block';
        faWarning.style.display='block';
        eRow.style.display='flex';
        aRow.style.display='none';
        document.getElementById('velocidadA').value='';
      } else {
        faWarning.style.display='none';
        eRow.style.display='flex';
        aRow.style.display='flex';
      }
    }

    function toggleAIInput(){
      const tipoAI = document.getElementById('tipoAI').value;
      const vol = document.getElementById('volumenRow');
      const area = document.getElementById('areaRow');
      if (tipoAI === 'volumen'){ vol.style.display='flex'; area.style.display='none'; document.getElementById('areaAI').value=''; }
      else { vol.style.display='none'; area.style.display='flex'; document.getElementById('volumenAI').value=''; }
    }

    function updateAgeReferences(){
      const edad = document.getElementById('edad').value;
      const ritmo = document.getElementById('ritmo').value;
      const fevi = document.getElementById('fevi').value;
      const tipoAI = document.getElementById('tipoAI').value;
      const ageReferences = document.getElementById('ageReferences');
      const content = document.getElementById('ageReferenceContent');

      let edadTexto, eSeptalRef, eLateralRef, ePromRef;
      if (edad === "1"){ edadTexto="20‚Äì39 a√±os"; eSeptalRef=7.0; eLateralRef=10.0; ePromRef=9.0; }
      else if (edad === "2"){ edadTexto="40‚Äì65 a√±os"; eSeptalRef=6.0; eLateralRef=8.0; ePromRef=7.0; }
      else { edadTexto=">65 a√±os"; eSeptalRef=6.0; eLateralRef=7.0; ePromRef=6.5; }

      const aiRef = (tipoAI === "volumen") ? "LAVi ‚â§34 ml/m¬≤" : "√Årea AI ‚â§20 cm¬≤ (proxy)";
      const ritmoRef = (ritmo === "fa") ? "<br>‚Ä¢ En FA no se utiliza E/A" : "";
      const feviRef = (fevi === "menor") ? "<br>‚Ä¢ FEVI reducida: se asume disfunci√≥n diast√≥lica" : "";

      content.innerHTML = `
        <strong>Edad ${edadTexto}:</strong><br>
        ‚Ä¢ e‚Ä≤ promedio ‚â• ${ePromRef} cm/s (lateral ‚â• ${eLateralRef}, septal ‚â• ${eSeptalRef})<br>
        ‚Ä¢ E/e‚Ä≤ ‚â§ 14<br>
        ‚Ä¢ ${aiRef}<br>
        ‚Ä¢ TR ‚â§ 2.8 m/s <em>o</em> PSAP &lt; 35 mmHg<br>
        ‚Ä¢ LA Strain ‚â• 18% (espec√≠fico), ‚â• 23% (normal)
        ${ritmoRef}${feviRef}
      `;
      ageReferences.style.display='block';
    }

    function openModal(){ document.getElementById('algModal').style.display='block'; }
    function closeModal(){ document.getElementById('algModal').style.display='none'; }

    function syncPresionUI(){
      const sel = document.getElementById('parametroPresion').value;
      const label = document.getElementById('labelPresion');
      const unidad = document.getElementById('unidadPresion');
      const input = document.getElementById('valorPresion');
      const note = document.getElementById('trNote');
      if (sel === 'PSAP'){
        label.textContent = 'PSAP:';
        unidad.textContent = 'mmHg';
        input.placeholder = 'Opcional';
        input.min = 0; input.max = 120; input.step = 0.1;
        note.style.display='block';
      } else {
        label.textContent = 'Velocidad pico TR:';
        unidad.textContent = 'm/s';
        input.placeholder = 'Opcional';
        input.min = 0; input.max = 6; input.step = 0.01;
        note.style.display='block';
      }
    }

    function renderEscenarioInfo(){
      const esc = document.getElementById('escenarioEspecial').value;
      const box = document.getElementById('escenarioInfo');
      const info = {
        normal:"Caso general: use e‚Ä≤, E/e‚Ä≤ y TR/PSAP; si hay discordancia, LARS, LAVi/√Årea, S/D e IVRT ayudan.",
        AF:"FA: no se usa E/A; enfoque multipar√°metros y promediar ciclos (E‚â•100, E/e‚Ä≤ septal>11, TR‚â•2.8 o PSAP‚â•35, DT‚â§160; soporte: LARS<18%, S/D<1).",
        MAC:"MAC: E/A <0.8 ‚Üí LAP normal; >1.8 ‚Üí LAP elevada; si 0.8‚Äì1.8, use IVRT (‚â•80 ms normal, <80 ms elevada).",
        MR:"MR significativa: LAVi/√Årea pueden estar altos por volumen; priorice LARS, S/D <1, IVRT <60‚Äì70 ms.",
        MS:"MS significativa: E y E/A se distorsionan; apoyarse en TR/PSAP, S/D, IVRT <60‚Äì70 ms.",
        PHnoCard:"PH no cardiaca: TR/PSAP altos no cuentan para LAP (neutralizado). Use e‚Ä≤, E/e‚Ä≤ y adicionales.",
        LVAD:"LVAD: par√°metros convencionales poco fiables; reporte orientativo con foco en S/D, LARS y cl√≠nica.",
        HTX:"Trasplante: e‚Ä≤ y E/e‚Ä≤ pueden estar alterados; priorice LARS y S/D; conclusi√≥n conservadora.",
        Constriccion:"Constrictiva: e‚Ä≤ suele ser relativamente alto; no penaliza e‚Ä≤ bajo; priorice S/D e IVRT.",
        HCM:"MCH: E/e‚Ä≤ alto requiere soporte (LARS, S/D, LAVi) antes de concluir LAP elevada.",
        BCRI_CRT:"BCRI/CRT: TDI lateral poco fiable; se prioriza e‚Ä≤ septal (el promedio puede usar solo septal)."
      };
      box.textContent = info[esc] || info.normal;
    }

    // Explain Mode (determin√≠stico, sin valores)
    function renderExplain(lap, contexto){
      const box = document.getElementById('explainBox');
      if (!box) return;
      let cls="explain ", chip="", bullets=[];
      if (lap==="elevada"){
        cls+="explain--elevada"; chip='<span class="chip chip--elevada">LAP elevada</span>';
        bullets=[
          "<strong>Decisi√≥n:</strong> ‚â•2 marcadores principales sugieren LAP alta (e‚Ä≤ por edad reducido, E/e‚Ä≤ elevado y/o TR/PSAP elevada) seg√∫n ASE 2025.",
          "<strong>Soporte:</strong> LARS bajo y/o aur√≠cula izquierda aumentada, si se midieron.",
          (contexto.ritmo==="sinusal" ? "<strong>Ahora:</strong> En RS, gradar con E/A (‚â•2 ‚áí III; 0.8‚Äì2 con LAP alta ‚áí II)." : "<strong>Ahora:</strong> En FA no se grad√∫a; mantener enfoque multipar√°metros.")
        ];
      } else if (lap==="normal"){
        cls+="explain--normal"; chip='<span class="chip chip--normal">LAP normal</span>';
        bullets=[
          "<strong>Decisi√≥n:</strong> Marcadores principales disponibles concordantes con presi√≥n normal.",
          "<strong>Soporte:</strong> LARS conservado y aur√≠cula izquierda no aumentada, cuando est√°n medidos.",
          "<strong>Ahora:</strong> Si hay s√≠ntomas, usar par√°metros adicionales o eco de ejercicio."
        ];
      } else {
        cls+="explain--indet"; chip='<span class="chip chip--indet">Indeterminado</span>';
        bullets=[
          "<strong>Decisi√≥n:</strong> Marcadores principales discordantes o insuficientes.",
          "<strong>Desempate:</strong> LARS, LAVi/√Årea (evitar como primaria en MR significativa), S/D &lt;1 o IVRT bajo.",
          "<strong>Ahora:</strong> Si hay s√≠ntomas y LAP no elevada en reposo, considerar eco de ejercicio."
        ];
      }
      box.className=cls;
      box.innerHTML=`<h4>üí° Explain Mode ${chip}</h4><ul><li>${bullets.join("</li><li>")}</li></ul>`;
      box.style.display="block";
    }

    // ---------- Algoritmo principal ----------
    function calcularFuncionDiastolica(){
      const ritmo = document.getElementById('ritmo').value;
      const edad = document.getElementById('edad').value;
      const fevi = document.getElementById('fevi').value;
      const tipoAI = document.getElementById('tipoAI').value;
      const parametroPresion = document.getElementById('parametroPresion').value;
      const esc = document.getElementById('escenarioEspecial').value;

      const feviWarning = document.getElementById('feviWarning');
      const indeterminateNote = document.getElementById('indeterminateNote');
      feviWarning.style.display="none"; indeterminateNote.style.display="none";

      const valores = {
        eSeptal: parseNumFromInput('eSeptal'),
        eLateral: parseNumFromInput('eLateral'),
        volumenAI: parseNumFromInput('volumenAI'),
        areaAI: parseNumFromInput('areaAI'),
        parametroPresion,
        valorPresion: parseNumFromInput('valorPresion'),
        laStrain: parseNumFromInput('laStrain'),
        velocidadE: parseNumFromInput('velocidadE'),
        velocidadA: parseNumFromInput('velocidadA'),
        ivrt: parseNumFromInput('ivrt'),
        sd: parseNumFromInput('sd'),
        escenarioEspecial: esc
      };

      const faltan = getMissingParams(ritmo, tipoAI, valores);

      // E/A
      let ea = null;
      if (ritmo==="sinusal" && !isNaN(valores.velocidadE) && !isNaN(valores.velocidadA) && valores.velocidadA>0){
        ea = valores.velocidadE / valores.velocidadA;
      }

      // e‚Ä≤ promedio con ajustes de escenario
      let eLat = valores.eLateral, eSep = valores.eSeptal;
      if (esc==="BCRI_CRT" && !isNaN(eSep)) { eLat = NaN; } // ignorar lateral
      let eProm = null;
      if (!isNaN(eSep) && !isNaN(eLat)) eProm = (eSep + eLat)/2;
      else if (!isNaN(eSep)) eProm = eSep;
      else if (!isNaN(eLat)) eProm = eLat;

      let ee = null;
      if (!isNaN(valores.velocidadE) && eProm>0) ee = valores.velocidadE / eProm;

      // Cortes por edad (Tabla 6)
      let eSeptalRef, eLateralRef, ePromRef;
      if (edad==="1"){ eSeptalRef=7.0; eLateralRef=10.0; ePromRef=9.0; }
      else if (edad==="2"){ eSeptalRef=6.0; eLateralRef=8.0; ePromRef=7.0; }
      else { eSeptalRef=6.0; eLateralRef=7.0; ePromRef=6.5; }

      // Render par√°metros
      const parametros = [];
      let eLateralNormal=null, eSeptalNormal=null, ePromNormal=null, eeNormal=null, aiNormal=null, presionNormal=null, laStrainNormal=null;

      if (!isNaN(valores.eLateral)){
        const ref = (esc==="BCRI_CRT") ? "‚Äî (ignorado)" : ("‚â•"+eLateralRef+" cm/s");
        eLateralNormal = (esc==="BCRI_CRT") ? null : (valores.eLateral >= eLateralRef);
        parametros.push({nombre:"e' lateral",valor:valores.eLateral.toFixed(1)+" cm/s",estado:eLateralNormal===null?"indeterminate":(eLateralNormal?"normal":"abnormal"),referencia:ref});
      }
      if (!isNaN(valores.eSeptal)){
        eSeptalNormal = valores.eSeptal >= eSeptalRef;
        parametros.push({nombre:"e' septal",valor:valores.eSeptal.toFixed(1)+" cm/s",estado:eSeptalNormal?"normal":"abnormal",referencia:"‚â•"+eSeptalRef+" cm/s"});
      }
      if (eProm!==null){
        if (esc==="Constriccion"){
          ePromNormal=null;
          parametros.push({nombre:"e' promedio",valor:eProm.toFixed(1)+" cm/s",estado:"indeterminate",referencia:"No penaliza en constricci√≥n"});
        } else {
          ePromNormal = eProm >= ePromRef;
          parametros.push({nombre:"e' promedio",valor:eProm.toFixed(1)+" cm/s",estado:ePromNormal?"normal":"abnormal",referencia:"‚â•"+ePromRef+" cm/s"});
        }
      }
      if (ritmo==="sinusal" && ea!==null){
        parametros.push({nombre:"Relaci√≥n E/A",valor:ea.toFixed(2),estado:"indeterminate",referencia:"Informativo p/gradaci√≥n"});
      }
      if (ee!==null){
        const limite=14;
        eeNormal = ee <= limite;
        const refTxt = (esc==="HCM") ? "‚â§14 (requiere soporte si >14)" : "‚â§14";
        parametros.push({nombre:"E/e' promedio",valor:ee.toFixed(1),estado:eeNormal?"normal":"abnormal",referencia:refTxt});
      }

      if (tipoAI==="volumen" && !isNaN(valores.volumenAI)){
        aiNormal = valores.volumenAI <= 34;
        const note = (esc==="MR") ? " (no primaria para LAP en MR)" : "";
        parametros.push({nombre:"Volumen AI indexado",valor:valores.volumenAI+" ml/m¬≤",estado:aiNormal?"normal":"abnormal",referencia:"‚â§34 ml/m¬≤"+note});
      } else if (tipoAI==="area" && !isNaN(valores.areaAI)){
        aiNormal = valores.areaAI <= 20;
        const note = (esc==="MR") ? " (no primaria para LAP en MR)" : "";
        parametros.push({nombre:"√Årea AI",valor:valores.areaAI+" cm¬≤",estado:aiNormal?"normal":"abnormal",referencia:"‚â§20 cm¬≤ (proxy)"+note});
      }

      if (!isNaN(valores.valorPresion)){
        if (valores.parametroPresion==="TR"){
          presionNormal = valores.valorPresion <= 2.8;
          parametros.push({nombre:"Velocidad TR",valor:valores.valorPresion.toFixed(2)+" m/s",estado:presionNormal?"normal":"abnormal",referencia:"‚â§2.8 m/s"+(esc==="PHnoCard"?" (neutralizado en PH no cardiaca)":"")});
        } else {
          presionNormal = valores.valorPresion < 35;
          parametros.push({nombre:"PSAP",valor:valores.valorPresion.toFixed(1)+" mmHg",estado:presionNormal?"normal":"abnormal",referencia:"<35 mmHg"+(esc==="PHnoCard"?" (neutralizado en PH no cardiaca)":"")});
        }
      }

      if (!isNaN(valores.laStrain)){
        laStrainNormal = valores.laStrain >= 18;
        parametros.push({nombre:"LA Strain",valor:valores.laStrain.toFixed(1)+" %",estado:laStrainNormal?"normal":"abnormal",referencia:"‚â•18% (espec√≠fico), ‚â•23% (normal)"});
      }

      // Conteo pilares
      let principalesAlterados=0, principalesNormales=0, principalesTotal=0;
      if (ePromNormal!==null){ principalesTotal++; principalesAlterados += ePromNormal?0:1; principalesNormales += ePromNormal?1:0; }
      if (eeNormal!==null && !(esc==="HCM" && eeNormal===false)){ principalesTotal++; principalesAlterados += eeNormal?0:1; principalesNormales += eeNormal?1:0; }
      if (presionNormal!==null && esc!=="PHnoCard"){ principalesTotal++; principalesAlterados += presionNormal?0:1; principalesNormales += presionNormal?1:0; }

      // Soportes
      let soporteElevada=false, soporteNormal=false, macHint="";
      if (laStrainNormal===false) soporteElevada=true;
      if (laStrainNormal===true)  soporteNormal=true;

      if (tipoAI==="volumen" && !isNaN(valores.volumenAI)){
        if (esc!=="MR" && valores.volumenAI>34) soporteElevada=true;
        if (valores.volumenAI<=34) soporteNormal=true;
      } else if (tipoAI==="area" && !isNaN(valores.areaAI)){
        if (esc!=="MR" && valores.areaAI>20) soporteElevada=true;
        if (valores.areaAI<=20) soporteNormal=true;
      }

      if (!isNaN(valores.sd) && valores.sd<1.0) soporteElevada=true;
      if (!isNaN(valores.ivrt)){
        const corte = (esc==="MR"||esc==="MS") ? 60 : 70;
        if (valores.ivrt<=corte) soporteElevada=true;
        if (esc==="MAC" && ea!==null && ea>=0.8 && ea<=1.8 && valores.ivrt>=80) soporteNormal=true;
      }

      if (esc==="MAC" && ritmo==="sinusal" && ea!==null){
        if (ea<0.8){ macHint="MAC: E/A <0.8 ‚Üí LAP normal"; soporteNormal=true; }
        else if (ea>1.8){ macHint="MAC: E/A >1.8 ‚Üí LAP elevada"; soporteElevada=true; }
        else { macHint = isNaN(valores.ivrt) ? "MAC: E/A 0.8‚Äì1.8 ‚Üí mida IVRT (80 ms) para definir" : macHint; }
      }

      // Decisi√≥n
      let diagnostico="", pressureStatus="", recomendaciones="";
      const trOpsapDisponible = (presionNormal!==null);

      if (ritmo==="fa" || esc==="AF"){
        // FA: sin gradaci√≥n
        let alterados=0, normales=0;
        if (ePromNormal!==null){ alterados+= ePromNormal?0:1; normales+= ePromNormal?1:0; }
        if (eeNormal!==null && !(esc==="HCM" && eeNormal===false)){ alterados+= eeNormal?0:1; normales+= eeNormal?1:0; }
        if (presionNormal!==null && esc!=="PHnoCard"){ alterados+= presionNormal?0:1; normales+= presionNormal?1:0; }

        if (alterados>=2){ diagnostico="Disfunci√≥n diast√≥lica"; pressureStatus="Presi√≥n de llenado elevada"; }
        else if (normales>=2){ diagnostico="Funci√≥n diast√≥lica normal"; pressureStatus="Presi√≥n de llenado normal"; }
        else { diagnostico="Indeterminado"; indeterminateNote.style.display="block"; }
        recomendaciones = "FA: no se grad√∫a. Use LARS/S-D/IVRT/LAVi para desempatar si queda dudoso. Considere eco de ejercicio si hay s√≠ntomas.";

      } else {
        if (trOpsapDisponible){
          // Caso con los 3 pilares
          if (principalesTotal===3 && principalesAlterados===3){
            diagnostico="Disfunci√≥n diast√≥lica"; pressureStatus="Presi√≥n de llenado elevada";
            recomendaciones="Los 3 par√°metros principales (e‚Ä≤, E/e‚Ä≤, TR/PSAP) est√°n alterados.";
          } else if (principalesTotal===3 && principalesNormales===3){
            diagnostico="Funci√≥n diast√≥lica normal"; pressureStatus="Presi√≥n de llenado normal";
            recomendaciones="Los 3 par√°metros principales est√°n normales.";
          } else if (principalesTotal>=2 && principalesAlterados>=1 && principalesAlterados<principalesTotal){
            if (soporteElevada){ diagnostico="Disfunci√≥n diast√≥lica"; pressureStatus="Presi√≥n de llenado elevada"; recomendaciones="Discordancia resuelta por adicionales (LARS ‚â§18%, LAVi >34* salvo MR, S/D <1 o IVRT bajo)."; }
            else if (soporteNormal){ diagnostico="Funci√≥n diast√≥lica normal"; pressureStatus="Presi√≥n de llenado normal"; recomendaciones="Discordancia resuelta por adicionales (LARS conservado, LAVi/√Årea en rango o MAC con IVRT ‚â•80 ms)."; }
            else { diagnostico="Indeterminado"; indeterminateNote.style.display="block"; recomendaciones="A√±ada LARS, LAVi/√Årea, S/D o IVRT; si hay s√≠ntomas y LAP no elevada, considere eco de ejercicio."; }
          } else {
            diagnostico="Indeterminado"; indeterminateNote.style.display="block";
            recomendaciones="Faltan par√°metros principales (e‚Ä≤, E/e‚Ä≤, TR/PSAP) para definir LAP.";
          }
        } else {
          // Sin TR/PSAP ‚Üí optimizado
          if (principalesTotal>=2 && principalesAlterados===0){
            diagnostico="Funci√≥n diast√≥lica normal"; pressureStatus="Presi√≥n de llenado normal";
            recomendaciones="Par√°metros principales disponibles concordantes con LAP normal. Falta TR/PSAP para completar.";
            if (soporteElevada && !soporteNormal){
              diagnostico="Funci√≥n diast√≥lica probablemente normal (discordante)";
              pressureStatus="Presi√≥n de llenado probablemente normal (discordante)";
              recomendaciones="Principales normales; adicionales sugieren carga/remodelado. Mida TR/PSAP o use LARS/S-D/IVRT para confirmar.";
            }
          } else if (principalesTotal>=2 && principalesAlterados===principalesTotal){
            diagnostico="Disfunci√≥n diast√≥lica (probable)";
            pressureStatus="Presi√≥n de llenado probablemente elevada";
            recomendaciones="e‚Ä≤ por edad y E/e‚Ä≤ sugieren LAP elevada. Falta TR/PSAP; use adicionales (LARS, S/D, IVRT) para confirmar.";
          } else if (principalesTotal>=2 && (principalesAlterados>=1 && principalesAlterados<principalesTotal)){
            if (soporteElevada){ diagnostico="Disfunci√≥n diast√≥lica (probable)"; pressureStatus="Presi√≥n de llenado probablemente elevada"; recomendaciones="Discordancia resuelta por adicionales (LARS ‚â§18%, S/D <1 o IVRT bajo)."; }
            else if (soporteNormal){ diagnostico="Funci√≥n diast√≥lica (probable)"; pressureStatus="Presi√≥n de llenado probablemente normal"; recomendaciones="Discordancia resuelta por adicionales (LARS conservado, LAVi/√Årea en rango o MAC con IVRT ‚â•80 ms)."; }
            else { diagnostico="Indeterminado"; indeterminateNote.style.display="block"; recomendaciones="Sin TR/PSAP y sin adicionales concluyentes. Mida LARS/S-D/IVRT/LAVi o recupere TR/PSAP."; }
          } else if (principalesTotal===1){
            if (soporteElevada && !soporteNormal){ diagnostico="Disfunci√≥n diast√≥lica (probable)"; pressureStatus="Presi√≥n de llenado probablemente elevada"; recomendaciones="Conclusi√≥n apoyada en par√°metros adicionales ante ausencia de TR/PSAP."; }
            else if (soporteNormal && !soporteElevada){ diagnostico="Funci√≥n diast√≥lica (probable)"; pressureStatus="Presi√≥n de llenado probablemente normal"; recomendaciones="Conclusi√≥n apoyada en adicionales ante ausencia de TR/PSAP."; }
            else { diagnostico="Indeterminado"; indeterminateNote.style.display="block"; recomendaciones="Falta TR/PSAP y no hay suficientes adicionales para concluir."; }
          } else {
            diagnostico="Indeterminado"; indeterminateNote.style.display="block"; recomendaciones="No hay par√°metros principales suficientes. Mida e‚Ä≤ y E/e‚Ä≤ y/o TR/PSAP.";
          }
        }

        // Gradaci√≥n (si RS y hay datos E/A)
        if ((diagnostico.startsWith("Disfunci√≥n") || fevi==="menor") && ea!==null && !isNaN(valores.velocidadE)){
          if (ea<0.8 && valores.velocidadE<50)      diagnostico += " - Grado I";
          else if (ea>=2.0)                           diagnostico += " - Grado III";
          else                                        diagnostico += " - Grado II";
        }
      }

      if (fevi==="menor") feviWarning.style.display="block";

      // Advertencias
      let advertencias = "";
      if (faltan.length>0){
        advertencias = `<div class="missing-params-warning"><strong>‚ö†Ô∏è Par√°metros no ingresados:</strong> ${faltan.join(", ")}.</div>`;
      }
      if (isNaN(valores.velocidadE)){
        advertencias += "<br>‚ö†Ô∏è Falta Onda E ‚Üí no se puede calcular E/e‚Ä≤.";
      }
      if (macHint){
        advertencias += `<div class="missing-params-warning" style="margin-top:8px;background:#e8f4fd;border-color:#b3d8f7;color:#1e3a5f;">${macHint}</div>`;
      }

      // Render final
      const results = document.getElementById('results');
      results.className="results";
      if (diagnostico.toLowerCase().includes("normal")) results.classList.add("normal");
      else if (diagnostico.toLowerCase().includes("disfunci√≥n") || (pressureStatus||"").toLowerCase().includes("elevada")) results.classList.add("abnormal");
      else results.classList.add("indeterminate");

      const h = document.getElementById('diagnostico');
      h.textContent = diagnostico;

      const pressureDiv = document.getElementById('pressureStatus');
      pressureDiv.textContent = pressureStatus;
      pressureDiv.className = "pressure-status";
      if ((pressureStatus||"").includes("elevada")) pressureDiv.classList.add("elevated");
      else if ((pressureStatus||"").includes("normal")) pressureDiv.classList.add("normal");

      let htmlParametros="";
      parametros.forEach(p=>{
        htmlParametros += `<div class="parameter-item ${p.estado}"><strong>${p.nombre}:</strong> ${p.valor} <span style="color:#888;font-size:.95em;">(${p.referencia})</span></div>`;
      });
      document.getElementById('parametros-status').innerHTML = htmlParametros;
      document.getElementById('recomendaciones').innerHTML = advertencias + (recomendaciones||"");

      results.style.display="block";

      // Explain Mode (derivado del status)
      const lap = (pressureStatus.includes("elevada") ? "elevada" : (pressureStatus.includes("normal") ? "normal" : "indet"));
      renderExplain(lap, {ritmo:ritmo, escenario:esc});

      // Accesibilidad: foco al encabezado del resultado
      h.focus({preventScroll:true});
      results.scrollIntoView({behavior:"smooth", block:"start"});
    }

    // ---------- Boot ----------
    document.addEventListener('DOMContentLoaded', () => {
      // Navegaci√≥n con Enter: usar submit del form
      const form = document.getElementById('diastolicForm');
      form.addEventListener('submit', (e)=>{ e.preventDefault(); calcularFuncionDiastolica(); });

      // Tambi√©n Enter en inputs
      document.querySelectorAll('input,select').forEach((el)=>{
        el.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter'){ e.preventDefault(); document.getElementById('btnCalcular').click(); }
        });
      });

      // Modal
      document.getElementById('openAlgInfo').addEventListener('click', openModal);
      document.getElementById('algModal').addEventListener('click', (e)=>{ if (e.target===e.currentTarget) closeModal(); });
      document.addEventListener('keydown', (ev)=>{ if (ev.key==="Escape"){ const m=document.getElementById('algModal'); if (m.style.display==='block') closeModal(); } });

      updateAgeReferences();
      toggleEASection();
      toggleAIInput();
      syncPresionUI();
      renderEscenarioInfo();
    });

    // ---------- Service Worker (auto-update) ----------
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(console.error);
      });
      let reloaded = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!reloaded) { reloaded = true; location.reload(); }
      });
    }
  </script>
</body>
</html>

