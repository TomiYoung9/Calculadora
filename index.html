<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora de Función Diastólica </title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --main-bg: #b7d0e8;
      --header-bg: #3a5a7a;
      --card-bg: #fff;
      --accent: #27ae60;
      --accent-dark: #219150;
      --accent-light: #e9f7ef;
      --text-main: #1a2a36;
      --text-soft: #5a6e7f;
      --border: #e3eaf2;
      --shadow: 0 4px 24px rgba(74,144,226,0.08);
      --red: #e74c3c;
      --green: #27ae60;
      --yellow: #f7b731;
      --blue: #3498db;
    }
    body { font-family: 'Inter', Arial, sans-serif; background: var(--main-bg); min-height: 100vh; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: 40px auto 0 auto; background: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden; }
    .header { background: var(--header-bg); color: #fff; padding: 36px 20px 24px 20px; text-align: center; position: relative; }
    .header h1 { font-size: 2.1em; font-weight: 700; margin: 0 0 8px 0; letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center; gap: 14px; color: #fff; }
    .header .subtitle { font-size: 1.08em; font-weight: 500; color: #fff; margin-top: 6px; letter-spacing: 0.2px; }
    .form-container { padding: 36px 22px 28px 22px; }
    .info-box { background: var(--accent-light); color: var(--text-main); padding: 15px 20px; border-radius: 10px; margin-bottom: 24px; font-size: 1.05em; box-shadow: 0 2px 8px #4a90e211; position: relative; }
    .alg-link { display: block; text-align: right; margin-top: 6px; color: #3a5a7a; font-size: 0.97em; text-decoration: underline dotted; cursor: pointer; transition: color 0.2s; }
    .alg-link:hover { color: #27ae60; }
    .form-card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 2px 8px #4a90e211; border: 1.5px solid var(--border); margin-bottom: 20px; padding: 22px 18px 12px 18px; transition: box-shadow 0.2s; }
    .form-card h3 { color: var(--text-main); font-size: 1.13em; font-weight: 600; margin-bottom: 14px; letter-spacing: 0.3px; }
    .input-row-group { display: flex; gap: 18px; flex-wrap: wrap; }
    .input-row { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; flex: 1 1 220px; min-width: 220px; }
    .input-row--full { flex: 1 1 100%; min-width: 100%; }
    .input-row label { font-weight: 500; color: var(--text-main); font-size: 1em; flex: 1 1 120px; }
    .input-row input, .input-row select { flex: 0 0 90px; padding: 9px 10px; border: 1.5px solid var(--border); border-radius: 6px; font-size: 1em; background: #f7fbfd; color: var(--text-main); transition: border-color 0.2s; }
    .input-row input:focus, .input-row select:focus { outline: none; border-color: var(--accent); }
    .unit { margin-left: 7px; color: var(--text-soft); font-weight: 500; font-size: 0.97em; }
    .ai-option-note { font-size: 0.92em; color: #5a6e7f; margin-top: 7px; font-style: italic; }
    .calculate-btn { width: 100%; padding: 13px; background: var(--green); color: white; border: none; border-radius: 9px; font-size: 1.13em; font-weight: 700; cursor: pointer; margin-top: 14px; box-shadow: 0 2px 8px #4a90e211; transition: background 0.2s, box-shadow 0.2s; }
    .calculate-btn:hover { background: var(--accent-dark); box-shadow: 0 6px 24px #4a90e122; }
    .results { margin-top: 26px; padding: 22px 18px; border-radius: 10px; display: none; }
    .results.normal { background: #eafaf1; color: var(--green); border: 2px solid var(--green);}
    .results.abnormal { background: #fdeaea; color: var(--red); border: 2px solid var(--red);}
    .results.indeterminate { background: #fffbe6; color: var(--yellow); border: 2px solid var(--yellow);}
    .results h3 { font-size: 1.2em; margin-bottom: 10px; }
    .parameter-status { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 6px; margin-top: 12px; }
    .parameter-item { background: rgba(255,255,255,0.13); padding: 7px 10px; border-radius: 7px; border-left: 4px solid #fff; font-size: 1em; margin-bottom: 0; }
    .parameter-item.abnormal { border-left-color: var(--red); background: #fdeaea;}
    .parameter-item.normal { border-left-color: var(--green); background: #eafaf1;}
    .parameter-item.indeterminate { border-left-color: var(--yellow); background: #fffbe6;}
    .recommendations { margin-top: 12px; padding: 12px 10px; background: rgba(255,255,255,0.13); border-radius: 7px; }
    .fa-warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px 12px; border-radius: 7px; margin-bottom: 12px; color: #856404; font-size: 1em; }
    .fevi-warning { background: #fff8e1; border: 1px solid #ffecb3; padding: 10px 12px; border-radius: 7px; margin-bottom: 12px; color: #6d4c41; font-size: 1em; }
    .tr-warning { background: #e3f1fd; border: 1.5px solid #b3d8f7; color: #357ab8; padding: 10px 12px; border-radius: 7px; margin-bottom: 12px; font-size: 1em; display: none; }
    .indeterminate-note { background: #fffbe6; border: 1.5px solid var(--yellow); color: #b38600; padding: 10px 12px; border-radius: 7px; margin-bottom: 12px; font-size: 1em; }
    .age-reference { background: #e8f4fd; padding: 10px 12px; border-radius: 7px; margin-bottom: 12px; border-left: 4px solid var(--accent); }
    .missing-params-warning { background: #fffbe6; border: 1.5px solid var(--yellow); color: #b38600; padding: 10px 12px; border-radius: 7px; margin-bottom: 12px; font-size: 1em; }
    .referencias { margin-top: 28px; padding: 16px 12px; background: #f8f9fa; border-radius: 9px; border-left: 5px solid var(--accent-light); }
    .referencias h3 { color: var(--text-main); margin-bottom: 12px; font-size: 1.08em; }
    .referencia-item { margin-bottom: 10px; padding: 10px; background: white; border-radius: 7px; box-shadow: 0 2px 5px #4a90e20a; }
    .referencia-item p { margin: 0; line-height: 1.6; color: var(--text-main); }
    .referencia-item a { color: #111; text-decoration: none; font-weight: 500; }
    .referencia-item a:hover { color: var(--accent); text-decoration: underline; }
    .twitter-section { text-align: center; padding: 10px; margin-bottom: 6px; }
    .twitter-link, .linkedin-link { display: inline-flex; align-items: center; gap: 8px; color: #111; text-decoration: none; font-weight: 600; font-size: 1.1em; transition: all 0.3s ease; }
    .twitter-link:hover, .linkedin-link:hover { color: var(--accent); }
    .twitter-link:visited, .linkedin-link:visited { color: #111; }
    .pressure-status { font-size: 1.08em; font-weight: bold; margin-top: 8px; padding: 7px; border-radius: 7px; text-align: center; }
    .pressure-status.normal { background: #eafaf1; color: var(--green);}
    .pressure-status.elevated { background: #fdeaea; color: var(--red);}

    /* Modal */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; overflow:auto; background-color:rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
    .modal-content { background-color: #fff; margin: 5% auto; padding: 20px 30px; border-radius: 12px; max-width: 600px; box-shadow: 0 4px 24px rgba(0,0,0,0.2); position: relative; }
    .modal-close { position: absolute; top: 12px; right: 16px; background: transparent; border: none; font-size: 28px; font-weight: bold; cursor: pointer; color: #333; line-height: 1; }
    .modal-close:hover { color: #27ae60; }
    .modal-body { max-height: 60vh; overflow-y: auto; font-size: 0.95em; line-height: 1.4; }
    .modal-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .modal-table th, .modal-table td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
    .modal-table th { background-color: #f0f4f8; font-weight: 600; }

    /* Móvil */
    @media (max-width: 480px) {
      body { font-size: 14px; line-height: 1.3; }
      .container { width: 95vw; max-width: 400px; margin: 8px auto; border-radius: 10px; box-shadow: none; }
      .form-container { padding: 12px 10px; }
      .form-card { padding: 14px 12px 8px 12px; margin-bottom: 8px; border: 1px solid var(--border); box-shadow: none; }
      .form-card h3 { font-size: 1.1em; margin-bottom: 8px; line-height: 1.3; }
      .input-row-group { display: block; }
      .input-row { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 12px; gap: 4px; width: 100%; min-width: 0 !important; }
      .input-row--full { flex: none; min-width: 0; }
      .input-row label { font-size: 1em; flex: none; width: 100%; margin-bottom: 0; white-space: normal; color: var(--text-main); }
      .input-row input, .input-row select { width: 100%; flex: none; padding: 8px 10px; font-size: 1em; height: 36px; box-sizing: border-box; border-radius: 6px; border: 1.5px solid var(--border); background: #f7fbfd; color: var(--text-main); transition: border-color 0.2s; }
      .input-row input:focus, .input-row select:focus { outline: none; border-color: var(--accent); }
      .unit { margin-left: 0; margin-top: 4px; font-size: 0.85em; color: var(--text-soft); display: inline-block; }
      .calculate-btn { width: 100%; font-size: 1.1em; padding: 10px 0; border-radius: 7px; margin-top: 10px; box-shadow: none; }
      .results { padding: 12px 10px; font-size: 1em; margin-top: 14px; line-height: 1.3; }
      .parameter-status { grid-template-columns: 1fr; gap: 6px; margin-top: 8px; }
      .parameter-item { font-size: 0.9em; padding: 5px 8px; word-wrap: break-word; margin-bottom: 4px; line-height: 1.2; }
      .info-box, .referencias, .fa-warning, .fevi-warning, .tr-warning, .indeterminate-note, .age-reference, .recommendations, .missing-params-warning { font-size: 0.9em; padding: 8px 10px; margin-bottom: 8px; line-height: 1.2; }
      .recommendations { margin-top: 8px; padding: 8px 10px; }
      .modal-content { margin: 10px 5px; max-width: 95vw; padding: 18px 14px; max-height: 90vh; }
      .modal-table { font-size: 0.85em; }
      input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🫀 Calculadora de Función Diastólica</h1>
      <div class="subtitle">ASE 2025 </div>
    </div>
    <div class="form-container">
      <div class="info-box">
        <strong>📋 Instrucciones:</strong> Complete los parámetros ecocardiográficos disponibles. Todos los campos son opcionales. Los valores de velocidad deben estar en <b>cm/s</b> para E, A, e' y en <b>m/s</b> para TR o <b>mmHg</b> para la PSAP.
        <a id="openAlgInfo" class="alg-link" href="javascript:void(0)">¿Cómo funciona el algoritmo?</a>
      </div>

      <form id="diastolicForm">
        <div class="form-card">
          <h3>🩺 Contexto clínico</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Ritmo:</label>
              <select id="ritmo" onchange="toggleEASection();updateAgeReferences();">
                <option value="sinusal">Ritmo sinusal</option>
                <option value="fa">Fibrilación auricular</option>
              </select>
            </div>
            <div class="input-row">
              <label>FEVI:</label>
              <select id="fevi" onchange="updateAgeReferences()">
                <option value="mayorigual">≥50%</option>
                <option value="menor">&lt;50%</option>
              </select>
            </div>
            <div class="input-row">
              <label>Edad:</label>
              <select id="edad" onchange="updateAgeReferences()">
                <option value="1">20–39 años</option>
                <option value="2">40–65 años</option>
                <option value="3">&gt;65 años</option>
              </select>
            </div>
          </div>
        </div>

        <div id="ageReferences" class="age-reference" style="display:none;">
          <strong>📊 Valores de referencia para este perfil:</strong>
          <div id="ageReferenceContent"></div>
        </div>

        <div class="form-card" id="eaSection">
          <h3>🔄 Flujo mitral (Doppler pulsado)</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Onda E:</label>
              <input type="number" id="velocidadE" step="0.1" min="0" max="300" placeholder="Opcional" />
              <span class="unit">cm/s</span>
            </div>
            <div class="input-row">
              <label>Onda A:</label>
              <input type="number" id="velocidadA" step="0.1" min="0" max="300" placeholder="Opcional" />
              <span class="unit">cm/s</span>
            </div>
          </div>
        </div>

        <div id="faWarning" class="fa-warning" style="display:none;">
          ⚠️ <strong>Fibrilación auricular:</strong> No se utiliza la relación E/A para el diagnóstico. La onda E sí se usa para calcular E/e'.
        </div>

        <div class="form-card">
          <h3>🎯 Doppler tisular</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>e' lateral:</label>
              <input type="number" id="eLateral" step="0.1" min="0" max="30" placeholder="Opcional" />
              <span class="unit">cm/s</span>
            </div>
            <div class="input-row">
              <label>e' septal:</label>
              <input type="number" id="eSeptal" step="0.1" min="0" max="30" placeholder="Opcional" />
              <span class="unit">cm/s</span>
            </div>
          </div>
        </div>

        <div class="form-card">
          <h3>📏 Aurícula izquierda</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Tipo de medición:</label>
              <select id="tipoAI" onchange="toggleAIInput();updateAgeReferences();">
                <option value="volumen">Volumen indexado</option>
                <option value="area">Área</option>
              </select>
            </div>
            <div class="input-row" id="volumenRow">
              <label>Vol AI indexado:</label>
              <input type="number" id="volumenAI" step="1" min="0" max="200" placeholder="Opcional" />
              <span class="unit">ml/m²</span>
            </div>
            <div class="input-row" id="areaRow" style="display:none;">
              <label>Área auricular izquierda:</label>
              <input type="number" id="areaAI" step="0.1" min="0" max="50" placeholder="Opcional" />
              <span class="unit">cm²</span>
            </div>
          </div>
          <div class="ai-option-note">
            <em>Complete uno u otro parámetro. Valores de referencia: Volumen ≤34 ml/m² o Área ≤20 cm² (proxy de LAVi).</em>
          </div>
        </div>

        <div class="form-card">
          <h3>🌊 TR / PSAP</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>Parámetro:</label>
              <select id="parametroPresion" onchange="syncPresionUI()">
                <option value="TR" selected>Velocidad pico TR</option>
                <option value="PSAP">PSAP</option>
              </select>
            </div>
            <div class="input-row">
              <label id="labelPresion">Velocidad pico TR:</label>
              <input type="number" id="valorPresion" step="0.01" min="0" max="6" placeholder="Opcional" />
              <span class="unit" id="unidadPresion">m/s</span>
            </div>
          </div>
          <div class="ai-option-note" id="trNote">
            Corte: <strong>TR ≤2.8 m/s</strong> o <strong>PSAP &lt;35 mmHg</strong>.
          </div>
        </div>

        <div class="form-card">
          <h3>⭐ Strain auricular izquierdo</h3>
          <div class="input-row-group">
            <div class="input-row">
              <label>LA Strain:</label>
              <input type="number" id="laStrain" step="1" min="0" max="60" placeholder="Opcional" />
              <span class="unit">%</span>
            </div>
          </div>
        </div>

        <!-- Calculadora avanzada -->
        <div class="form-card">
          <h3>🧩 Calculadora avanzada</h3>
          <div class="input-row-group">
            <div class="input-row input-row--full">
              <label>Escenario especial:</label>
              <select id="escenarioEspecial" onchange="renderEscenarioInfo()">
                <option value="normal" selected>— Caso general —</option>
                <option value="AF">Fibrilación auricular</option>
                <option value="MAC">MAC moderada/severa</option>
                <option value="MR">Insuficiencia mitral significativa</option>
                <option value="MS">Estenosis mitral significativa</option>
                <option value="PHnoCard">Hipertensión pulmonar no cardiaca</option>
                <option value="LVAD">LVAD</option>
                <option value="HTX">Trasplante cardíaco</option>
                <option value="Constriccion">Pericarditis constrictiva</option>
                <option value="HCM">Miocardiopatía hipertrófica</option>
                <option value="BCRI_CRT">BCRI / CRT / marcapaseo</option>
              </select>
            </div>
            <div class="input-row">
              <label>IVRT:</label>
              <input type="number" id="ivrt" step="1" min="20" max="200" placeholder="Opcional" />
              <span class="unit">ms</span>
            </div>
            <div class="input-row">
              <label>Relación S/D:</label>
              <input type="number" id="sd" step="0.01" min="0" max="3" placeholder="Opcional" />
              <span class="unit">—</span>
            </div>
          </div>
          <div class="ai-option-note" id="escenarioInfo" style="margin-top:8px;"></div>
        </div>

        <!-- IMPORTANTE: ahora es type="submit" -->
        <button type="submit" class="calculate-btn">
          🧮 Calcular función diastólica
        </button>
      </form>

      <div id="results" class="results" aria-live="polite">
        <div id="feviWarning" class="fevi-warning" style="display:none;">
          ⚠️ <strong>FEVI reducida:</strong> En pacientes con FEVI &lt;50%, se asume disfunción diastólica. Lo relevante es estimar la presión de llenado.
        </div>
        <div id="indeterminateNote" class="indeterminate-note" style="display:none;">
          Resultado indeterminado/discordante. Considere parámetros adicionales (LAVi, LARS, S/D, IVRT) o eco de ejercicio si hay síntomas.
        </div>
        <h3 id="diagnostico" tabindex="-1"></h3>
        <div id="pressureStatus" class="pressure-status"></div>
        <div id="parametros-status" class="parameter-status"></div>
        <div id="recomendaciones" class="recommendations"></div>
      </div>

      <div class="referencias">
        <h3>📚 Referencia</h3>
        <div class="referencia-item">
          <p>
            <strong>ASE 2025. Left Ventricular Diastolic Function by Echo</strong><br />
            DOI: <a href="https://doi.org/10.1016/j.echo.2025.03.011" target="_blank" rel="noopener">10.1016/j.echo.2025.03.011</a><br />
            <a href="https://onlinejase.com/article/S0894-7317(25)00157-9/fulltext" target="_blank" rel="noopener">
              Texto completo (JASE)
            </a>
          </p>
        </div>
      </div>

      <div class="twitter-section" style="display: flex; justify-content: center; gap: 20px; padding: 10px; margin-bottom: 6px;">
        <a href="https://x.com/atomasyoung" target="_blank" rel="noopener" class="twitter-link" style="display: inline-flex; align-items: center; gap: 8px; color: #111; text-decoration: none; font-weight: 600; font-size: 1.1em; transition: all 0.3s ease;">
          <svg class="twitter-icon" viewBox="0 0 1200 1227" fill="currentColor" width="24" height="24" aria-hidden="true" focusable="false">
            <path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z" />
          </svg>
          @atomasyoung
        </a>
        <a href="https://www.linkedin.com/in/tomas-young" target="_blank" rel="noopener" class="linkedin-link" style="display: inline-flex; align-items: center; gap: 8px; color: #111; text-decoration: none; font-weight: 600; font-size: 1.1em; transition: all 0.3s ease;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor" width="24" height="24" aria-hidden="true" focusable="false">
            <path d="M100.28 448H7.4V148.9h92.88zm-46.44-340.7a53.66 53.66 0 1 1 53.66-53.66 53.66 53.66 0 0 1-53.66 53.66zM447.9 448h-92.68V302.4c0-34.7-12.4-58.4-43.4-58.4-23.7 0-37.8 15.9-44 31.3-2.3 5.6-2.9 13.4-2.9 21.3V448h-92.68s1.2-270.1 0-297.1h92.68v42.1c12.3-19 34.3-46 83.4-46 60.9 0 106.7 39.8 106.7 125.4z" />
          </svg>
          Tomas Young
        </a>
      </div>

      <div style="text-align:center;color:#6b7280;font-size:12px;margin:6px 0 12px;">
        v1.0.3 · actualizada 11/08/2025
      </div>
    </div>
  </div>

  <!-- Modal de información del algoritmo -->
  <div id="algModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">×</button>
      <h2>🧠 Algoritmo </h2>
      <div class="modal-body">
        <h4>1) Flujo principal según la guía</h4>
        <p>El algoritmo ASE 2025 comienza evaluando <strong>e′</strong> (ajustado por edad), <strong>E/e′</strong> y <strong>TR</strong> <em>o</em> <strong>PSAP</strong>. Si hay discordancia, se usan parámetros adicionales.</p>

        <h4>2) Si FEVI &lt; 50% (cualquier ritmo)</h4>
        <p><strong>Diagnóstico:</strong> se asume disfunción diastólica. El objetivo es estimar la <strong>presión de llenado</strong>. ≥2 de los 3 parámetros principales alterados → LAP elevada.</p>

        <h4>3) Si FEVI ≥50% y Ritmo Sinusal</h4>
        <p><strong>Paso 1:</strong> e′ medio (por edad), E/e′ y TR (o PSAP).</p>
        <ul>
          <li>3/3 alterados → LAP elevada</li>
          <li>3/3 normales → LAP normal</li>
          <li>1–2 alterados → <em>Paso 2</em></li>
        </ul>
        <p><strong>Paso 2 (adicionales para desempatar):</strong> LARS ≤18%, LAVi &gt;34 ml/m² (o Área AI &gt;20 cm² como <em>proxy</em>), S/D venas pulmonares &lt;1, IVRT ≤70 ms.</p>
        <p><strong>Gradación (si hay datos y RS):</strong> Grado I (e′ reducido + E/e′ normal + PASP/TR normal + E/A ≤0.8) · Grado III (E/A ≥2.0) · Grado II (resto si LAP elevada).</p>

        <h4>4) Fibrilación auricular (algoritmo específico)</h4>
        <p>No se informa <em>grado</em>. Estime LAP con multiparámetros (principales y de soporte) y promedie varios ciclos.</p>

        <h4>5) Valores de referencia de e′ por edad (Tabla 6)</h4>
        <table class="modal-table">
          <thead>
            <tr>
              <th>Grupo etario</th>
              <th>e′ septal</th>
              <th>e′ lateral</th>
              <th>e′ promedio</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>20–39 años</td><td>≥7 cm/s</td><td>≥10 cm/s</td><td>≥9 cm/s</td></tr>
            <tr><td>40–65 años</td><td>≥6 cm/s</td><td>≥8 cm/s</td><td>≥7 cm/s</td></tr>
            <tr><td>&gt;65 años</td><td>≥6 cm/s</td><td>≥7 cm/s</td><td>≥6.5 cm/s</td></tr>
          </tbody>
        </table>

        <p><strong>Parámetros independientes de edad:</strong></p>
        <ul>
          <li><strong>E/e′ promedio:</strong> ≤14</li>
          <li><strong>TR:</strong> ≤2.8 m/s <em>o</em> <strong>PSAP:</strong> &lt;35 mmHg</li>
          <li><strong>LAVi:</strong> ≤34 ml/m² (Área AI ≤20 cm² como aproximación)</li>
          <li><strong>LA Strain:</strong> ≥18% (específico), ≥23% (normal)</li>
        </ul>

        <p style="font-size:0.9em; color:#666; text-align:center; margin-top:16px;">
          <strong>Basado en las guías ASE 2025</strong>
        </p>
      </div>
    </div>
  </div>

  <script>
    // --- utilidades ---
    const $ = (id)=>document.getElementById(id);
    // Acepta coma o punto
    const num = (id) => {
      const el = $(id);
      if (!el) return NaN;
      const v = (el.value || "").replace(",", ".");
      return parseFloat(v);
    };

    // Mostrar/ocultar sección E/A según ritmo
    function toggleEASection() {
      const ritmo = $('ritmo').value;
      const velocidadERow = $('velocidadE').closest('.input-row');
      const velocidadARow = $('velocidadA').closest('.input-row');
      if (ritmo === 'fa') {
        $('faWarning').style.display = 'block';
        velocidadERow.style.display = 'flex';
        velocidadARow.style.display = 'none';
        $('velocidadA').value = '';
      } else {
        $('faWarning').style.display = 'none';
        velocidadERow.style.display = 'flex';
        velocidadARow.style.display = 'flex';
      }
    }

    // Área/volumen AI
    function toggleAIInput() {
      const tipoAI = $('tipoAI').value;
      if (tipoAI === 'volumen') {
        $('volumenRow').style.display = 'flex';
        $('areaRow').style.display = 'none';
        $('areaAI').value = '';
      } else {
        $('volumenRow').style.display = 'none';
        $('areaRow').style.display = 'flex';
        $('volumenAI').value = '';
      }
    }

    // Referencias por edad
    function updateAgeReferences() {
      const edad = $('edad').value;
      const ritmo = $('ritmo').value;
      const fevi = $('fevi').value;
      const tipoAI = $('tipoAI').value;

      let edadTexto, eSeptalRef, eLateralRef, ePromRef;
      if (edad === "1") { edadTexto = "20–39 años"; eSeptalRef = 7.0; eLateralRef = 10.0; ePromRef = 9.0; }
      else if (edad === "2") { edadTexto = "40–65 años"; eSeptalRef = 6.0; eLateralRef = 8.0; ePromRef = 7.0; }
      else { edadTexto = ">65 años"; eSeptalRef = 6.0; eLateralRef = 7.0; ePromRef = 6.5; }

      const aiRef = (tipoAI === "volumen") ? "LAVi ≤34 ml/m²" : "Área AI ≤20 cm² (proxy)";
      let ritmoRef = (ritmo === "fa") ? "<br>• En FA no se utiliza E/A" : "";
      let feviRef = (fevi === "menor") ? "<br>• FEVI reducida: se asume disfunción diastólica" : "";

      $('ageReferenceContent').innerHTML = `
        <strong>Edad ${edadTexto}:</strong><br>
        • e' promedio ≥ ${ePromRef} cm/s (lateral ≥ ${eLateralRef}, septal ≥ ${eSeptalRef})<br>
        • E/e' ≤ 14<br>
        • ${aiRef}<br>
        • TR ≤ 2.8 m/s <em>o</em> PSAP &lt; 35 mmHg<br>
        • LA Strain ≥ 18% (específico), ≥ 23% (normal)
        ${ritmoRef}${feviRef}
      `;
      $('ageReferences').style.display = 'block';
    }

    // Modal
    function openModal() { $('algModal').style.display = 'block'; }
    function closeModal() { $('algModal').style.display = 'none'; }

    // TR/PSAP UI
    function syncPresionUI(){
      const sel = $('parametroPresion').value;
      $('labelPresion').textContent = (sel === 'PSAP') ? 'PSAP:' : 'Velocidad pico TR:';
      $('unidadPresion').textContent = (sel === 'PSAP') ? 'mmHg' : 'm/s';
      const input = $('valorPresion');
      if (sel === 'PSAP') { input.min = 0; input.max = 120; input.step = 0.1; }
      else { input.min = 0; input.max = 6; input.step = 0.01; }
    }

    // Texto explicativo por escenario
    function renderEscenarioInfo(){
      const esc = $('escenarioEspecial').value;
      const info = {
        normal: "Caso general: se usan los 3 principales (e′, E/e′, TR/PSAP). Si hay discordancia, LARS, LAVi, S/D e IVRT ayudan.",
        AF: "FA: no se usa E/A; use el algoritmo específico multiparámetros (E≥100, E/e′ septal>11, TR≥2.8 o PSAP≥35, DT≤160; soporte: LARS<18%, S/D<1, IMC>30).",
        MAC: "MAC: E/A <0.8 → LAP normal; >1.8 → LAP elevada; si 0.8–1.8 use IVRT (≥80 ms normal, <80 ms elevada).",
        MR: "MR significativa: LAVi/Área pueden estar altos por volumen. En este modo NO se usan como evidencia primaria; priorice LARS, S/D <1, IVRT <60–70 ms.",
        MS: "MS significativa: E y E/A se alteran por obstrucción; apoyarse en TR/PSAP, S/D e IVRT.",
        PHnoCard: "PH no cardiaca: TR/PSAP altos NO cuentan para LAP elevada (neutralizados). Use e′, E/e′ y adicionales.",
        LVAD: "LVAD: parámetros convencionales poco fiables; reporte orientativo con foco en S/D, LARS y clínica.",
        HTX: "Trasplante: e′ y E/e′ pueden estar alterados; priorice LARS y S/D; conclusión conservadora.",
        Constriccion: "Constrictiva: e′ suele ser relativamente alto; no penalizamos e′ bajo; priorice S/D e IVRT.",
        HCM: "MCH: E/e′ alto requiere soporte adicional (LARS, S/D, LAVi) antes de concluir LAP elevada.",
        BCRI_CRT: "BCRI/CRT: TDI lateral poco fiable; se prioriza e′ septal (el promedio puede usar solo septal)."
      };
      $('escenarioInfo').textContent = info[esc] || info.normal;
    }

    // Enter en móvil + submit del form
    document.addEventListener('DOMContentLoaded', function() {
      const form = $('diastolicForm');

      // 1) Interceptar submit (botón o Enter/Go en móvil)
      form.addEventListener('submit', function(e){
        e.preventDefault();
        calcularFuncionDiastolica();
      });

      // 2) (Opcional) Enter por keydown (mejora UX en desktop)
      form.addEventListener('keydown', function(e){
        if (e.key === 'Enter') {
          e.preventDefault();
          calcularFuncionDiastolica();
        }
      });

      // 3) Forzar teclado decimal en móvil
      document.querySelectorAll('input[type="number"]').forEach(i => {
        i.setAttribute('inputmode', 'decimal');
      });

      // Modal
      $('openAlgInfo').addEventListener('click', openModal);
      $('algModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });
      document.addEventListener('keydown', function(event) { if (event.key === "Escape") closeModal(); });

      updateAgeReferences();
      toggleEASection();
      toggleAIInput();
      syncPresionUI();
      renderEscenarioInfo();
    });

    // --- Algoritmo principal con escenarios ---
    function calcularFuncionDiastolica() {
      const ritmo = $('ritmo').value;
      const edad = $('edad').value;
      const fevi = $('fevi').value;
      const tipoAI = $('tipoAI').value;
      const parametroPresion = $('parametroPresion').value;
      const esc = $('escenarioEspecial').value;

      const feviWarning = $('feviWarning');
      const indeterminateNote = $('indeterminateNote');
      feviWarning.style.display = (fevi === "menor") ? "block" : "none";
      indeterminateNote.style.display = "none";

      const valores = {
        eSeptal: num('eSeptal'),
        eLateral: num('eLateral'),
        volumenAI: num('volumenAI'),
        areaAI: num('areaAI'),
        parametroPresion,
        valorPresion: num('valorPresion'),
        laStrain: num('laStrain'),
        velocidadE: num('velocidadE'),
        velocidadA: num('velocidadA'),
        ivrt: num('ivrt'),
        sd: num('sd'),
        escenarioEspecial: esc
      };

      // Parámetros faltantes
      function getMissingParams(ritmo, tipoAI, v) {
        const faltan = [];
        if (isNaN(v.eSeptal)) faltan.push("e' septal");
        if (isNaN(v.eLateral)) faltan.push("e' lateral");
        if (tipoAI === "volumen" && isNaN(v.volumenAI)) faltan.push("Volumen AI indexado");
        if (tipoAI === "area" && isNaN(v.areaAI)) faltan.push("Área AI");
        if (v.parametroPresion === "TR" && isNaN(v.valorPresion)) faltan.push("Velocidad TR");
        if (v.parametroPresion === "PSAP" && isNaN(v.valorPresion)) faltan.push("PSAP");
        if (ritmo === "sinusal") {
          if (isNaN(v.velocidadE)) faltan.push("Onda E");
          if (isNaN(v.velocidadA)) faltan.push("Onda A");
        }
        if (isNaN(v.laStrain)) faltan.push("LA Strain");
        return faltan;
      }
      const faltan = getMissingParams(ritmo, tipoAI, valores);

      // Cálculos básicos
      let ea = null, ee = null;
      if (ritmo === "sinusal" && !isNaN(valores.velocidadE) && !isNaN(valores.velocidadA) && valores.velocidadA > 0) {
        ea = valores.velocidadE / valores.velocidadA;
      }

      // e′ promedio con ajustes
      let eLat = valores.eLateral, eSep = valores.eSeptal;
      if (esc === "BCRI_CRT" && !isNaN(eSep)) { eLat = NaN; } // ignorar lateral
      let eProm = null;
      if (!isNaN(eSep) && !isNaN(eLat)) eProm = (eSep + eLat) / 2;
      else if (!isNaN(eSep)) eProm = eSep;
      else if (!isNaN(eLat)) eProm = eLat;

      if (!isNaN(valores.velocidadE) && eProm>0) ee = valores.velocidadE / eProm;

      // Cortes ASE 2025 por edad
      let eSeptalRef, eLateralRef, ePromRef;
      if (edad === "1") { eSeptalRef = 7.0; eLateralRef = 10.0; ePromRef = 9.0; }
      else if (edad === "2") { eSeptalRef = 6.0; eLateralRef = 8.0; ePromRef = 7.0; }
      else { eSeptalRef = 6.0; eLateralRef = 7.0; ePromRef = 6.5; }

      // Mostrar parámetros
      let parametros = [];

      let eLateralNormal = null;
      if (!isNaN(valores.eLateral)) {
        const ref = (esc==="BCRI_CRT") ? "— (ignorado)" : ("≥"+eLateralRef+" cm/s");
        eLateralNormal = (esc==="BCRI_CRT") ? null : (valores.eLateral >= eLateralRef);
        parametros.push({ nombre: "e' lateral", valor: valores.eLateral.toFixed(1) + " cm/s", estado: eLateralNormal===null?"indeterminate":(eLateralNormal ? "normal" : "abnormal"), referencia: ref });
      }

      let eSeptalNormal = null;
      if (!isNaN(valores.eSeptal)) {
        eSeptalNormal = valores.eSeptal >= eSeptalRef;
        parametros.push({ nombre: "e' septal", valor: valores.eSeptal.toFixed(1) + " cm/s", estado: eSeptalNormal ? "normal" : "abnormal", referencia: "≥" + eSeptalRef + " cm/s" });
      }

      let ePromNormal = null;
      if (eProm !== null) {
        if (esc === "Constriccion") {
          ePromNormal = null; // no penaliza
          parametros.push({ nombre: "e' promedio", valor: eProm.toFixed(1) + " cm/s", estado: "indeterminate", referencia: "No penaliza en constricción" });
        } else {
          ePromNormal = eProm >= ePromRef;
          parametros.push({ nombre: "e' promedio", valor: eProm.toFixed(1) + " cm/s", estado: ePromNormal ? "normal" : "abnormal", referencia: "≥" + ePromRef + " cm/s" });
        }
      }

      if (ritmo === "sinusal" && ea !== null) {
        parametros.push({ nombre: "Relación E/A", valor: ea.toFixed(2), estado: "indeterminate", referencia: "Informativo p/gradación" });
      }

      let eeNormal = null;
      if (ee !== null) {
        eeNormal = ee <= 14;
        const refTxt = (esc==="HCM") ? "≤14 (requiere soporte si >14)" : "≤14";
        parametros.push({ nombre: "E/e' promedio", valor: ee.toFixed(1), estado: eeNormal ? "normal" : "abnormal", referencia: refTxt });
      }

      // AI volumen/área
      let aiNormal = null;
      if (tipoAI === "volumen" && !isNaN(valores.volumenAI)) {
        aiNormal = valores.volumenAI <= 34;
        const note = (esc==="MR") ? " (no usar como evidencia primaria en MR)" : "";
        parametros.push({ nombre: "Volumen AI indexado", valor: valores.volumenAI + " ml/m²", estado: aiNormal ? "normal" : "abnormal", referencia: "≤34 ml/m²" + note });
      } else if (tipoAI === "area" && !isNaN(valores.areaAI)) {
        aiNormal = valores.areaAI <= 20;
        const note = (esc==="MR") ? " (no usar como evidencia primaria en MR)" : "";
        parametros.push({ nombre: "Área AI", valor: valores.areaAI + " cm²", estado: aiNormal ? "normal" : "abnormal", referencia: "≤20 cm² (proxy)" + note });
      }

      // TR/PSAP
      let presionNormal = null, nombrePresion = null, refPresion = null, valorPresionFmt = "";
      if (!isNaN(valores.valorPresion)) {
        if (valores.parametroPresion === "TR") {
          presionNormal = valores.valorPresion <= 2.8;
          nombrePresion = "Velocidad TR"; refPresion = "≤2.8 m/s"; valorPresionFmt = valores.valorPresion.toFixed(2) + " m/s";
        } else {
          presionNormal = valores.valorPresion < 35;
          nombrePresion = "PSAP"; refPresion = "<35 mmHg"; valorPresionFmt = valores.valorPresion.toFixed(1) + " mmHg";
        }
        const note = (esc==="PHnoCard") ? " (neutralizado en PH no cardiaca)" : "";
        parametros.push({ nombre: nombrePresion, valor: valorPresionFmt, estado: presionNormal ? "normal" : "abnormal", referencia: refPresion + note });
      }

      let laStrainNormal = null;
      if (!isNaN(valores.laStrain)) {
        laStrainNormal = valores.laStrain >= 18;
        parametros.push({ nombre: "LA Strain", valor: valores.laStrain.toFixed(1) + " %", estado: laStrainNormal ? "normal" : "abnormal", referencia: "≥18% (específico), ≥23% (normal)" });
      }

      // Conteo principales
      let principalesAlterados = 0, principalesNormales = 0, principalesTotal = 0;

      if (ePromNormal !== null) { principalesTotal++; principalesAlterados += ePromNormal ? 0 : 1; principalesNormales += ePromNormal ? 1 : 0; }
      if (eeNormal !== null && !(esc==="HCM" && eeNormal===false)) { principalesTotal++; principalesAlterados += eeNormal ? 0 : 1; principalesNormales += eeNormal ? 1 : 0; }
      if (presionNormal !== null && esc!=="PHnoCard") { principalesTotal++; principalesAlterados += presionNormal ? 0 : 1; principalesNormales += presionNormal ? 1 : 0; }

      // Soporte adicional
      let soporteElevada = false, soporteNormal = false;
      if (laStrainNormal === false) soporteElevada = true;
      if (laStrainNormal === true)  soporteNormal = true;

      if (tipoAI === "volumen" && !isNaN(valores.volumenAI)) {
        if (esc!=="MR" && valores.volumenAI > 34) soporteElevada = true;
        if (valores.volumenAI <= 34) soporteNormal = true;
      } else if (tipoAI === "area" && !isNaN(valores.areaAI)) {
        if (esc!=="MR" && valores.areaAI > 20) soporteElevada = true;
        if (valores.areaAI <= 20) soporteNormal = true;
      }

      if (!isNaN(valores.sd) && valores.sd < 1.0) soporteElevada = true; // S/D < 1
      if (!isNaN(valores.ivrt)) {
        const corte = (esc==="MR"||esc==="MS") ? 60 : 70;
        if (valores.ivrt <= corte) soporteElevada = true;
        if (esc==="MAC" && ea !== null && ea>=0.8 && ea<=1.8 && valores.ivrt >= 80) soporteNormal = true;
      }

      // Regla MAC (si hay E/A)
      let macHint = "";
      if (esc === "MAC" && ritmo === "sinusal" && ea !== null) {
        if (ea < 0.8) { macHint = "MAC: E/A < 0.8 → LAP normal"; soporteNormal = true; }
        else if (ea > 1.8) { macHint = "MAC: E/A > 1.8 → LAP elevada"; soporteElevada = true; }
        else {
          if (!isNaN(valores.ivrt)) {
            if (valores.ivrt >= 80) { macHint = "MAC: E/A 0.8–1.8 y IVRT ≥80 ms → LAP normal"; soporteNormal = true; }
            else { macHint = "MAC: E/A 0.8–1.8 y IVRT <80 ms → LAP elevada"; soporteElevada = true; }
          } else { macHint = "MAC: E/A 0.8–1.8 → mida IVRT (80 ms) para definir"; }
        }
      }

      // Diagnóstico / LAP
      let diagnostico = "";
      let pressureStatus = "";
      let recomendaciones = "";

      if (ritmo === "fa" || esc === "AF") {
        let alterados = 0, normales = 0;
        if (ePromNormal !== null) { alterados += ePromNormal ? 0 : 1; normales += ePromNormal ? 1 : 0; }
        if (eeNormal !== null && !(esc==="HCM" && eeNormal===false)) { alterados += eeNormal ? 0 : 1; normales += eeNormal ? 1 : 0; }
        if (presionNormal !== null && esc!=="PHnoCard") { alterados += presionNormal ? 0 : 1; normales += presionNormal ? 1 : 0; }

        if (alterados >= 2) {
          diagnostico = "Disfunción diastólica";
          pressureStatus = "Presión de llenado elevada";
        } else if (normales >= 2) {
          diagnostico = "Función diastólica probablemente normal";
          pressureStatus = "Presión de llenado normal";
        } else {
          diagnostico = "Indeterminado";
          indeterminateNote.style.display = "block";
        }
        recomendaciones = "FA: no se gradúa. Use LARS/S-D/IVRT/LAVi para desempatar si queda dudoso. Considere eco de ejercicio si hay síntomas.";
      } else {
        if (principalesTotal === 3 && principalesAlterados === 3) {
          diagnostico = "Disfunción diastólica";
          pressureStatus = "Presión de llenado elevada";
          recomendaciones = "Los 3 parámetros principales (e′, E/e′, TR/PSAP) están alterados.";
        } else if (principalesTotal === 3 && principalesNormales === 3) {
          diagnostico = "Función diastólica normal";
          pressureStatus = "Presión de llenado normal";
          recomendaciones = "Los 3 parámetros principales están normales.";
        } else if (principalesTotal >= 2 && (principalesAlterados >= 1 && principalesAlterados < principalesTotal)) {
          if (soporteElevada) {
            diagnostico = "Disfunción diastólica";
            pressureStatus = "Presión de llenado elevada";
            recomendaciones = "Discordancia resuelta por adicionales (LARS ≤18%, LAVi >34*, S/D <1 o IVRT bajo).";
          } else if (soporteNormal) {
            pressureStatus = "Presión de llenado probablemente normal (discordante)";
            if (ePromNormal === false) diagnostico = "Relajación alterada (sin evidencia de LAP elevada)";
            else diagnostico = "Función diastólica probablemente normal";
            recomendaciones = "Discordancia con adicionales no sugestivos de LAP elevada. Considere eco de ejercicio si hay síntomas.";
          } else {
            diagnostico = "Indeterminado";
            indeterminateNote.style.display = "block";
            recomendaciones = "Mida LARS, LAVi, S/D o IVRT; si hay síntomas y LAP no elevada → eco de ejercicio.";
          }
        } else {
          diagnostico = "Indeterminado";
          indeterminateNote.style.display = "block";
          recomendaciones = "Faltan parámetros principales (e′, E/e′, TR/PSAP) para definir LAP.";
        }

        // Gradación (solo si corresponde)
        if (pressureStatus.includes("elevada") && ritmo === "sinusal" && ea !== null) {
          if (ea >= 2.0) diagnostico += " - Grado III";
          else diagnostico += " - Grado II";
        } else if (ritmo === "sinusal") {
          const ePrimeReducido = (ePromNormal === false);
          const paspOk = (presionNormal === true || presionNormal === null);
          if (ePrimeReducido && eeNormal === true && paspOk && ea !== null && ea <= 0.8) {
            diagnostico = "Disfunción diastólica - Grado I";
            if (!pressureStatus) pressureStatus = "Presión de llenado normal";
          }
        }
      }

      // Advertencias
      let advertencias = "";
      if (faltan.length > 0) {
        advertencias = `<div class="missing-params-warning">
          <strong>⚠️ Parámetros no ingresados:</strong> ${faltan.join(", ")}.
        </div>`;
      }
      if (isNaN(valores.velocidadE)) {
        advertencias += "<br>⚠️ Falta Onda E → no se puede calcular E/e′.";
      }
      if (macHint) {
        advertencias += `<div class="missing-params-warning" style="margin-top:8px;background:#e8f4fd;border-color:#b3d8f7;color:#1e3a5f;">
          ${macHint}
        </div>`;
      }

      // Render
      const results = $('results');
      results.className = "results";
      if (pressureStatus.includes("normal")) results.classList.add("normal");
      else if (pressureStatus.includes("elevada")) results.classList.add("abnormal");
      else results.classList.add("indeterminate");

      $('diagnostico').innerHTML = diagnostico;

      const pressureDiv = $('pressureStatus');
      pressureDiv.innerHTML = pressureStatus;
      pressureDiv.className = "pressure-status";
      if (pressureStatus.includes("elevada")) pressureDiv.classList.add("elevated");
      else if (pressureStatus.includes("normal")) pressureDiv.classList.add("normal");

      let htmlParametros = "";
      parametros.forEach(p => {
        htmlParametros += `<div class="parameter-item ${p.estado}"><strong>${p.nombre}:</strong> ${p.valor} <span style="color:#888;font-size:0.95em;">(${p.referencia})</span></div>`;
      });
      $('parametros-status').innerHTML = htmlParametros;

      $('recomendaciones').innerHTML = advertencias + recomendaciones;

      results.style.display = "block";
      results.scrollIntoView({behavior: "smooth", block: "start"});

      // Foco accesible al encabezado (fallback iOS)
      const h = $('diagnostico');
      try { h.focus({ preventScroll: true }); } catch (e) { h.focus(); }
    }
  </script>
</body>
</html>
